<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Calendario Scout nel Bosco (2026‚Äì2029) ‚Äî Compleanni</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#08190e">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --text:#eef7ef; --muted: rgba(238,247,239,.78);
    --danger:#ff3f3f; --gold:#ffd24d;

    --overlayA: rgba(8,25,14,.58);
    --overlayB: rgba(8,25,14,.26);

    --panel: rgba(255,255,255,.10);
    --panel2: rgba(255,255,255,.14);

    --btn: rgba(0,0,0,.22);
    --btnBorder: rgba(255,255,255,.18);

    --shadow: 0 18px 50px rgba(0,0,0,.55);
    --radius: 18px;

    --bgUrl: url("ChatGPT Image 19 gen 2026, 21_00_05.png");

    --fliesOpacity: .75;
    --windStrength: 0;

    --mx: 0;
    --my: 0;
  }

  *{ box-sizing:border-box; }
  html, body { height:100%; }
  body{
    margin:0;
    min-height:100vh;
    color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    overflow-x:hidden;
    background-color:#08190e;
    background-image: var(--bgUrl);
    background-size: cover;
    background-position:center;
    background-repeat:no-repeat;
  }

  .bg{
    position:fixed; top:0; left:0;
    width:100vw;
    height:100vh;
    height:100dvh;
    background-image: var(--bgUrl);
    background-size: cover;
    background-position:center;
    transform:scale(1.03);
    z-index:-10;
    animation: bgSlow 16s ease-in-out infinite alternate;
    will-change: transform, filter;
  }
  @keyframes bgSlow{
    from{ transform: scale(1.03) translateY(0) translateX(0); filter:saturate(1); }
    to  { transform: scale(1.07) translateY(-12px) translateX(6px); filter:saturate(1.16); }
  }

  .bgOverlay{
    position:fixed; top:0; left:0;
    width:100vw;
    height:100vh;
    height:100dvh;
    background:
      radial-gradient(1200px 800px at 20% 10%, rgba(124,255,138,.18), transparent 55%),
      radial-gradient(900px 600px at 90% 20%, rgba(255,210,77,.16), transparent 60%),
      linear-gradient(160deg, var(--overlayA), var(--overlayB));
    z-index:-9;
    animation: overlayBreath 9s ease-in-out infinite;
  }
  @keyframes overlayBreath{ 0%,100%{ opacity:1; } 50%{ opacity:.92; } }

  .aurora{
    position: fixed; inset:-80px;
    pointer-events:none;
    z-index:-8;
    background:
      radial-gradient(520px 360px at 20% 30%, rgba(124,255,138,.18), transparent 64%),
      radial-gradient(520px 360px at 80% 40%, rgba(255,210,77,.14), transparent 64%),
      radial-gradient(620px 420px at 50% 80%, rgba(180,255,205,.10), transparent 70%);
    filter: blur(18px);
    opacity:.65;
    transform: translate3d(calc(var(--mx) * 12px), calc(var(--my) * 10px), 0);
    transition: transform .18s ease;
    animation: auroraDrift 10s ease-in-out infinite alternate;
  }
  @keyframes auroraDrift{
    from{ opacity:.55; filter: blur(18px); }
    to{ opacity:.78; filter: blur(22px); }
  }

  .wind{
    position:fixed; inset:-120px;
    pointer-events:none;
    background:
      radial-gradient(700px 440px at 30% 30%, rgba(255,255,255,.12), transparent 72%),
      radial-gradient(900px 600px at 70% 45%, rgba(255,255,255,.09), transparent 74%),
      radial-gradient(720px 480px at 40% 80%, rgba(255,255,255,.08), transparent 72%);
    filter: blur(18px);
    opacity: calc(0.55 + (var(--windStrength) * 0.25));
    transform: translate3d(calc(var(--windStrength) * 18px), calc(var(--windStrength) * -8px), 0) scale(calc(1.02 + var(--windStrength) * 0.02));
    transition: opacity .35s ease, transform .35s ease;
    z-index:-7;
    animation: fogDrift 10s ease-in-out infinite alternate;
  }
  @keyframes fogDrift{ from{ filter: blur(18px);} to{ filter: blur(22px);} }

  .leaves{ position:fixed; inset:0; pointer-events:none; z-index:-1; overflow:hidden; }
  .leafFall{
    position:absolute; top:-80px;
    width:28px; height:28px;
    background: radial-gradient(circle at 30% 30%, rgba(255,210,77,.9), rgba(18,58,32,.25));
    border-radius: 6px 18px 6px 18px;
    opacity:0;
    animation: leafDown var(--t) linear infinite, leafSpin calc(var(--t) * .75) ease-in-out infinite;
    box-shadow: 0 6px 20px rgba(0,0,0,.18);
    transform: translateX(calc(var(--windStrength) * 8px));
  }
  @keyframes leafDown{
    0%{ transform: translate3d(0,-60px,0); opacity:0; }
    8%{ opacity:.85; }
    50%{ opacity:.55; }
    100%{ transform: translate3d(calc(var(--dx) + var(--windStrength) * 140px), 110vh, 0); opacity:0; }
  }
  @keyframes leafSpin{ 0%{ rotate:0deg; } 50%{ rotate:140deg; } 100%{ rotate:300deg; } }

  .fireflies{ position:fixed; inset:0; pointer-events:none; z-index:-1; opacity:var(--fliesOpacity); }
  .firefly{
    position:absolute; width:6px; height:6px; border-radius:50%;
    background: rgba(255,210,77,.95);
    box-shadow: 0 0 18px rgba(255,210,77,.85);
    opacity:0;
    animation: fly var(--t) linear infinite;
  }
  @keyframes fly{
    0%{ transform: translate(0,0) scale(.8); opacity:0; }
    12%{ opacity:.95; }
    50%{ opacity:.35; }
    100%{ transform: translate(calc(var(--dx) + var(--windStrength) * 80px), var(--dy)) scale(1.25); opacity:0; }
  }

  .sparks{ position:fixed; inset:0; pointer-events:none; z-index:-1; }
  .spark{
    position:absolute;
    width:3px; height:3px; border-radius:50%;
    background: rgba(255,255,255,.85);
    box-shadow: 0 0 16px rgba(255,255,255,.32);
    opacity:0;
    animation: sparkFloat var(--t) ease-in-out infinite;
  }
  @keyframes sparkFloat{
    0%{ transform: translate3d(0,20px,0) scale(.8); opacity:0; }
    15%{ opacity:.55; }
    60%{ opacity:.25; }
    100%{ transform: translate3d(var(--dx), calc(-140px - var(--dy)), 0) scale(1.2); opacity:0; }
  }

  .stars{ position:fixed; inset:0; pointer-events:none; z-index:-2; overflow:hidden; }
  .star{
    position:absolute;
    width:2px; height:2px;
    background: rgba(255,255,255,.9);
    border-radius:50%;
    box-shadow: 0 0 18px rgba(255,255,255,.35);
    opacity:0;
    transform: translate3d(0,0,0);
    animation: shoot var(--t) linear infinite;
  }
  @keyframes shoot{
    0%{ opacity:0; transform: translate3d(0,0,0) scale(.8); }
    10%{ opacity:.8; }
    100%{ opacity:0; transform: translate3d(var(--dx), var(--dy), 0) scale(1.1); }
  }

  .confetti{ position:fixed; inset:0; pointer-events:none; z-index:400; overflow:hidden; }
  .conf{
    position:absolute; top:-10px;
    width:10px; height:14px;
    border-radius: 4px;
    opacity:0;
    background: rgba(255,210,77,.9);
    box-shadow: 0 10px 26px rgba(0,0,0,.25);
    animation: confFall var(--t) linear forwards;
  }
  @keyframes confFall{
    0%{ transform: translate3d(0,-20px,0) rotate(0deg); opacity:0; }
    10%{ opacity:.9; }
    100%{ transform: translate3d(var(--dx), 110vh, 0) rotate(680deg); opacity:0; }
  }

  .intro{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background: rgba(0,0,0,.62);
    backdrop-filter: blur(10px);
    z-index:50;
    transition: opacity .6s ease, transform .6s ease;
  }
  .intro.hide{ opacity:0; pointer-events:none; transform: scale(1.02); }

  .introRing{
    position:absolute;
    width:280px; height:280px;
    border-radius:50%;
    border:1px solid rgba(255,255,255,.22);
    box-shadow: 0 0 60px rgba(255,255,255,.10);
    animation: ring 3.2s ease-in-out infinite;
  }
  .introRing::after{
    content:"";
    position:absolute; inset:-18px;
    border-radius:50%;
    border:1px dashed rgba(255,210,77,.22);
    animation: ring2 6.8s linear infinite;
  }
  @keyframes ring{ 0%,100%{ transform: scale(1); opacity:.65; } 50%{ transform: scale(1.06); opacity:.95; } }
  @keyframes ring2{ to{ transform: rotate(360deg); } }

  .enterBtn{
    position:relative;
    padding: 22px 46px;
    font-size: 26px;
    font-weight: 900;
    letter-spacing: .06em;
    border-radius: 999px;
    border: 2px solid rgba(255,255,255,.48);
    background: rgba(0,0,0,.30);
    color: var(--text);
    cursor:pointer;
    box-shadow: 0 22px 60px rgba(0,0,0,.55), 0 0 40px rgba(255,255,255,.18);
    animation: pulse 2.2s ease-in-out infinite;
    overflow:hidden;
  }
  .enterBtn::after{
    content:"";
    position:absolute; inset:-70px;
    background: radial-gradient(320px 220px at 30% 30%, rgba(255,255,255,.14), transparent 60%);
    transform: translateX(-40%);
    animation: shimmer 2.6s ease-in-out infinite;
  }
  @keyframes shimmer{ 0%,100%{ opacity:.25; transform: translateX(-40%); } 50%{ opacity:.55; transform: translateX(40%); } }
  @keyframes pulse{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-2px); } }

  .wrap{ position:relative; z-index:2; max-width:1080px; margin:22px auto 46px; padding:14px; }
  .topbar{
    display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    padding:14px; background:var(--panel); border:1px solid var(--panel2);
    border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter: blur(10px);
    animation: floatPanel 7s ease-in-out infinite;
  }
  @keyframes floatPanel{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-2px); } }
  .title{ display:flex; gap:10px; align-items:center; font-weight:900; }
  .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  button, select{
    border:1px solid var(--btnBorder); background: var(--btn); color: var(--text);
    padding:10px 12px; border-radius:14px; cursor:pointer; outline:none; font-family:inherit;
    transition: transform .18s ease, filter .18s ease, box-shadow .18s ease;
  }
  button:hover, select:hover{ transform: translateY(-1px) scale(1.01); filter: brightness(1.08); box-shadow: 0 14px 28px rgba(0,0,0,.22); }
  button:active{ transform: translateY(0) scale(.99); }

  .monthTitle{ font-size:18px; font-weight:900; text-transform:capitalize; }
  .muted{ color: var(--muted); font-size:13px; }

  .stage{
    margin-top:14px; position:relative; border-radius:22px; overflow:hidden;
    box-shadow:var(--shadow); border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    backdrop-filter: blur(10px);
  }
  .frame{ position:absolute; inset:0; background:url("frame.jpg") center/cover no-repeat; opacity:.96; pointer-events:none; z-index:1; }
  .content{ position:relative; z-index:2; padding:34px 26px 18px; }

  .grid{ display:grid; grid-template-columns:repeat(7, 1fr); gap:10px; }
  .dow{
    text-align:center; font-weight:900; font-size:13px; color: rgba(0,0,0,.80);
    background: rgba(255,255,255,.84); border-radius:12px; padding:10px 6px; border:1px solid rgba(0,0,0,.08);
    animation: popIn .5s ease both;
  }
  @keyframes popIn{ from{ transform: translateY(6px); opacity:0; } to{ transform: translateY(0); opacity:1; } }

  .day{
    border-radius:16px; padding:10px; background: rgba(255,255,255,.90);
    border:1px solid rgba(0,0,0,.08); color: rgba(0,0,0,.88);
    position:relative; overflow:hidden; display:flex; align-items:flex-start; justify-content:flex-start;
    transition: transform .18s ease, filter .18s ease, box-shadow .18s ease;
  }
  .day:hover{
    transform: translateY(-2px) scale(1.01);
    filter: brightness(1.03);
    box-shadow: 0 16px 30px rgba(0,0,0,.18);
  }
  .day .n{ font-weight:900; font-size:16px; }
  .off{ opacity:.55; }

  .today{
    outline: 3px solid rgba(124,255,138,.75);
    outline-offset:-3px;
    animation: todayGlow 2.2s ease-in-out infinite;
  }
  @keyframes todayGlow{
    0%,100%{ box-shadow: 0 0 0 rgba(124,255,138,0); }
    50%{ box-shadow: 0 0 28px rgba(124,255,138,.35); }
  }

  .marker{
    position:absolute; right:8px; bottom:8px;
    font-size:14px; opacity:.98;
    display:flex; align-items:center; gap:6px;
    transform-origin: 50% 70%;
    animation: markerBounce 1.8s ease-in-out infinite;
    padding: 4px 6px;
    border-radius: 999px;
    background: rgba(0,0,0,.10);
    border: 1px solid rgba(0,0,0,.08);
  }
  .dotRed{
    width:7px; height:7px; border-radius:50%;
    background: rgba(255,63,63,.95);
    box-shadow: 0 0 16px rgba(255,63,63,.45);
  }
  @keyframes markerBounce{
    0%,100%{ transform: translateY(0) rotate(0deg); }
    50%{ transform: translateY(-2px) rotate(-2deg); }
  }

  .eventDay::before{
    content:"";
    position:absolute; inset:-40px;
    background:
      radial-gradient(240px 180px at 25% 25%, rgba(255,63,63,.12), transparent 62%),
      radial-gradient(260px 200px at 80% 40%, rgba(255,210,77,.14), transparent 62%);
    opacity:.9;
    filter: blur(12px);
    pointer-events:none;
    animation: eventAura 3.4s ease-in-out infinite;
  }
  @keyframes eventAura{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-6px); } }

  .jumpFlash{ animation: jumpFlash 1.6s ease-in-out 0s 3; }
  @keyframes jumpFlash{
    0%{ transform: scale(1); }
    50%{ transform: scale(1.03); filter: brightness(1.14); box-shadow: 0 0 40px rgba(255,63,63,.45); }
    100%{ transform: scale(1); }
  }

  @media (max-width: 780px){
    .content{ padding: 18px 14px 14px; }
    .grid{ gap:8px; }
    .day{ aspect-ratio: 1/1; padding:8px; }
    .day .n{ font-size:14px; }
    .monthTitle{ font-size:16px; }
  }

  .monthEvents{
    margin-top: 10px;
    padding: 10px 12px;
    border-radius: 16px;
    background: rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.14);
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .monthEventsLine{
    display:flex; gap:10px; align-items:flex-start;
    padding:8px 10px;
    border-radius:14px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    transition: transform .18s ease, filter .18s ease;
    cursor:pointer;
  }
  .monthEventsLine:hover{ transform: translateY(-1px); filter: brightness(1.06); }
  .monthEventsIco{ font-size:18px; line-height:1; }
  .monthEventsTxt{ font-size:13px; color: rgba(238,247,239,.88); }
  .monthEventsSub{ font-size:12px; color: var(--muted); margin-top:2px; }

  .accordion{ margin-top:14px; display:flex; flex-direction:column; gap:12px; }
  .accItem{
    background: var(--panel);
    border:1px solid var(--panel2);
    border-radius: 20px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
    overflow:hidden;
    transition: transform .18s ease, filter .18s ease;
  }
  .accItem:hover{ transform: translateY(-1px); filter: brightness(1.03); }

  .accBtn{
    width:100%;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:14px 14px;
    border:0;
    background: transparent;
    cursor:pointer;
    color: var(--text);
    position:relative;
    overflow:hidden;
  }
  .accBtn::after{
    content:"";
    position:absolute; inset:-60px;
    background: radial-gradient(360px 220px at 20% 30%, rgba(255,255,255,.10), transparent 60%);
    opacity:0;
    transition: opacity .22s ease;
  }
  .accItem:hover .accBtn::after{ opacity:.65; }

  .accLeft{ display:flex; align-items:center; gap:10px; font-weight:900; }
  .accIco{
    width:34px; height:34px;
    display:grid; place-items:center;
    border-radius: 12px;
    background: rgba(0,0,0,.18);
    border: 1px solid rgba(255,255,255,.14);
    box-shadow: 0 10px 26px rgba(0,0,0,.22);
    animation: icoFloat 4.2s ease-in-out infinite;
  }
  @keyframes icoFloat{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-2px); } }

  .accTitle{ font-size:15px; margin:0; }
  .chev{
    width:40px; height:40px;
    display:grid; place-items:center;
    border-radius: 14px;
    background: rgba(0,0,0,.14);
    border:1px solid rgba(255,255,255,.14);
    transition: transform .25s ease, filter .25s ease;
  }
  .accItem.open .chev{ transform: rotate(180deg); filter: brightness(1.15); }

  .accBody{ display:none; padding: 0 14px 14px; }
  .accItem.open .accBody{ display:block; animation: rise .32s ease both; }
  @keyframes rise{ from{ opacity:0; transform: translateY(10px);} to{ opacity:1; transform: translateY(0);} }

  .cards{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
  @media (max-width: 900px){ .cards{ grid-template-columns: 1fr; } }

  .card{
    background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12);
    border-radius: 16px; padding:12px; position:relative; overflow:hidden;
    transition: transform .18s ease, filter .18s ease;
  }
  .card:hover{ transform: translateY(-2px); filter: brightness(1.06); }

  .kicker{ font-size:12px; color: var(--muted); margin-bottom:6px; }
  .big{ font-size:15px; font-weight:900; margin:0; }
  .small{ margin:6px 0 0; color: var(--muted); font-size:13px; }

  .redNote{
    margin:8px 0 0;
    font-weight:900;
    color: rgba(255,63,63,.95);
    letter-spacing: .02em;
    text-shadow: 0 10px 26px rgba(0,0,0,.35);
    animation: redPulse 1.4s ease-in-out infinite;
  }
  @keyframes redPulse{ 0%,100%{ opacity:.78; } 50%{ opacity:1; } }

  .journalBox{
    width:100%;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.18);
    color: var(--text);
    border-radius: 16px;
    padding: 12px;
    min-height: 110px;
    outline:none;
    font-family: inherit;
    resize: vertical;
    transition: box-shadow .18s ease, filter .18s ease;
  }
  .journalBox:focus{ box-shadow: 0 0 0 3px rgba(124,255,138,.22); filter: brightness(1.05); }

  /* NODO */
  .knotBox{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
  .knotImg{
    flex: 0 0 260px;
    background: rgba(0,0,0,.22);
    border:1px solid rgba(255,255,255,.14);
    border-radius: 16px;
    padding: 10px;
    overflow:hidden;
    box-shadow: 0 14px 30px rgba(0,0,0,.25);
    cursor: pointer; /* ‚úÖ cliccabile */
  }
  .knotImg img{
    width:100%;
    height: 180px;
    object-fit: cover;
    display:block;
    border-radius: 12px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.18);
  }
  .knotImgCap{
    margin-top:8px;
    font-weight:900;
    font-size:13px;
    color: rgba(238,247,239,.92);
  }
  .knotText{ flex: 1 1 260px; }
  .knotName{ font-weight:900; font-size:16px; margin:0; }
  .knotDesc{ margin:8px 0 0; color: var(--muted); }

  /* BUSSOLA */
  .compassWrap{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .compass{
    width:140px; height:140px;
    border-radius:50%;
    border:2px solid rgba(255,255,255,.35);
    background: rgba(0,0,0,.18);
    position:relative;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    animation: compassBreath 3.6s ease-in-out infinite;
  }
  @keyframes compassBreath{ 0%,100%{ transform: scale(1); } 50%{ transform: scale(1.02); } }
  .compass::before{
    content:""; position:absolute; inset:10px;
    border-radius:50%;
    border:1px dashed rgba(255,210,77,.28);
    opacity:.85;
    animation: spinSlow 18s linear infinite;
  }
  @keyframes spinSlow{ to{ transform: rotate(360deg); } }

  .needle{
    position:absolute;
    left:50%; top:22px;
    width:4px; height:54px;
    transform-origin: 50% 100%;
    background: rgba(255,63,63,.95);
    border-radius: 6px;
    box-shadow: 0 0 18px rgba(255,63,63,.35);
    transform: translateX(-50%) rotate(0deg);
    transition: transform .5s ease;
  }
  .needle::after{
    content:""; position:absolute; left:-6px; top:-6px;
    width:16px; height:16px; border-radius:50%;
    background: rgba(255,255,255,.75);
    box-shadow: 0 0 18px rgba(255,255,255,.25);
  }
  .virtueName{ margin:0; font-weight:900; font-size:16px; }
  .virtueDesc{ margin:8px 0 0; color: var(--muted); }

  /* TIMELINE */
  .timeline{
    display:flex; gap:12px;
    overflow-x:auto;
    scroll-snap-type: x mandatory;
    padding-bottom: 6px;
  }
  .timeItem{
    min-width: 240px;
    scroll-snap-align: start;
    background: rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.14);
    border-radius: 16px;
    padding: 12px;
    transition: transform .18s ease, filter .18s ease;
  }
  .timeItem:hover{ transform: translateY(-2px); filter: brightness(1.08); }
  .timeYear{ font-weight:900; font-size:16px; margin:0; }
  .timeText{ margin:8px 0 0; color: var(--muted); font-size:13px; }

  /* MODAL LEGGE SCOUT */
  .modalBackdrop{
    position:fixed; inset:0;
    background: rgba(0,0,0,.60);
    display:none;
    align-items:center; justify-content:center;
    padding: 18px;
    z-index:99;
  }
  .modalBackdrop.show{ display:flex; }
  .modal{
    width:min(680px, 96vw);
    background: rgba(14,44,25,.92);
    border:1px solid rgba(255,255,255,.14);
    border-radius: 22px;
    box-shadow: var(--shadow);
    padding: 16px;
    transform: translateY(18px) scale(.95);
    opacity:0;
    animation: pop .32s ease forwards;
    overflow:hidden;
  }
  @keyframes pop{ to{ transform: translateY(0) scale(1); opacity:1; } }
  .modalHeader{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; padding:6px 6px 10px; }
  .modalTitle{ font-weight:900; font-size:18px; margin:0; }
  .modalBody{
    background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12);
    border-radius: 18px;
    padding: 12px;
    margin: 6px;
  }
  .line{
    display:flex; gap:10px; align-items:flex-start;
    padding:10px; border-radius:14px;
    background: rgba(0,0,0,.20);
    border:1px solid rgba(255,255,255,.10);
    margin-bottom: 10px;
    animation: slideIn .35s ease both;
  }
  @keyframes slideIn{ from{ transform: translateX(-12px); opacity:0; } to{ transform: translateX(0); opacity:1; } }
  .ico{ font-size: 22px; line-height:1; }
  .sub{ color: rgba(238,247,239,.85); font-size: 13px; margin:2px 0 0; }

  /* FOTO */
  details.photoWin{
    margin-top:14px;
    background: var(--panel);
    border:1px solid var(--panel2);
    border-radius: 20px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
    overflow:hidden;
  }
  details.photoWin > summary{
    list-style:none;
    cursor:pointer;
    padding:14px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    font-weight:900;
  }
  details.photoWin > summary::-webkit-details-marker{ display:none; }
  .sumLeft{ display:flex; gap:10px; align-items:center; }
  .sumIco{
    width:34px; height:34px; display:grid; place-items:center;
    border-radius:12px;
    background: rgba(0,0,0,.18);
    border: 1px solid rgba(255,255,255,.14);
    box-shadow: 0 10px 26px rgba(0,0,0,.22);
  }
  .sumChev{
    width:40px; height:40px; display:grid; place-items:center;
    border-radius: 14px;
    background: rgba(0,0,0,.14);
    border:1px solid rgba(255,255,255,.14);
    transition: transform .25s ease;
  }
  details[open] .sumChev{ transform: rotate(180deg); }

  .galleryWrap{ padding: 0 14px 14px; }
  .galleryGrid{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap:10px;
  }
  @media (max-width: 860px){ .galleryGrid{ grid-template-columns: 1fr; } }

  .thumb{
    border-radius: 16px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    box-shadow: 0 14px 30px rgba(0,0,0,.25);
    cursor:pointer;
    transition: transform .18s ease, filter .18s ease;
  }
  .thumb:hover{ transform: translateY(-2px); filter: brightness(1.06); }

  .thumb img, .thumb video{
    width:100%;
    height: 280px;
    object-fit: cover;
    display:block;
    background: rgba(0,0,0,.22);
  }
  .thumb video{ outline:none; }

  .thumbCap{
    padding:10px 12px;
    font-weight:900;
    color: rgba(238,247,239,.92);
    border-top:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.14);
  }
  .thumbCap small{ display:block; font-weight:600; color: rgba(238,247,239,.72); margin-top:4px; }

  /* LIGHTBOX */
  .lightbox{
    position:fixed; inset:0;
    background: rgba(0,0,0,.72);
    display:none;
    align-items:center;
    justify-content:center;
    padding: 14px;
    z-index: 200;
  }
  .lightbox.show{ display:flex; }
  .lbBox{
    width:min(980px, 96vw);
    max-height: 88vh;
    border-radius: 18px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(10,28,16,.85);
    box-shadow: 0 30px 80px rgba(0,0,0,.6);
    animation: lbPop .26s ease both;
  }
  @keyframes lbPop{ from{ transform: translateY(14px) scale(.98); opacity:0; } to{ transform: translateY(0) scale(1); opacity:1; } }
  .lbTop{
    display:flex; justify-content:space-between; align-items:center;
    padding: 10px 12px;
    background: rgba(0,0,0,.25);
    border-bottom: 1px solid rgba(255,255,255,.12);
  }
  .lbTitle{ font-weight:900; font-size: 14px; color: rgba(238,247,239,.92); }
  .lbClose{
    border:1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.22);
    color: var(--text);
    border-radius: 12px;
    padding: 8px 10px;
    cursor:pointer;
    font-weight:900;
  }
  .lbMedia{
    display:block;
    width:100%;
    height: min(78vh, 720px);
    object-fit: contain;
    background: rgba(0,0,0,.20);
  }

  .footerWindow{
    margin-top:14px;
    border-radius: 18px;
    padding: 14px;
    text-align:center;
    box-shadow: var(--shadow);
    background: rgba(0,0,0,.34);
    border: 1px solid rgba(255,255,255,.22);
    backdrop-filter: blur(10px);
  }
  .footerWindow b{
    display:inline-block;
    font-size: 14px;
    letter-spacing: .06em;
    padding: 10px 16px;
    border-radius: 999px;
    background: rgba(255,255,255,.10);
    border: 1px solid rgba(255,255,255,.18);
    box-shadow: 0 18px 44px rgba(0,0,0,.30);
    text-transform: uppercase;
  }

  .toastWrap{
    position: fixed;
    left: 50%;
    bottom: 16px;
    transform: translateX(-50%);
    z-index: 500;
    display: grid;
    gap: 10px;
    width: min(720px, 94vw);
    pointer-events: none;
  }
  .toast{
    pointer-events: auto;
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding: 12px 14px;
    border-radius: 18px;
    background: rgba(0,0,0,.50);
    border: 1px solid rgba(255,255,255,.18);
    box-shadow: 0 18px 50px rgba(0,0,0,.55);
    backdrop-filter: blur(10px);
    animation: toastIn .28s ease both;
  }
  @keyframes toastIn{ from{ opacity:0; transform: translateY(10px) scale(.98);} to{ opacity:1; transform: translateY(0) scale(1);} }
  .toast .tIco{ font-size:20px; line-height:1; }
  .toast .tTxt{ flex:1; }
  .toast .tTxt b{ display:block; font-size:14px; }
  .toast .tTxt small{ display:block; color: rgba(238,247,239,.75); margin-top:4px; }
  .toast .tClose{
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.08);
    color: var(--text);
    border-radius: 12px;
    padding: 6px 10px;
    cursor:pointer;
    font-weight:900;
  }
</style>
</head>

<body>
  <div class="bg"></div>
  <div class="bgOverlay"></div>
  <div class="aurora"></div>
  <div class="wind" id="windLayer"></div>
  <div class="stars" id="stars"></div>
  <div class="leaves" id="leaves"></div>
  <div class="fireflies" id="fireflies"></div>
  <div class="sparks" id="sparks"></div>

  <div class="confetti" id="confetti"></div>

  <div class="intro" id="intro">
    <div class="introRing"></div>
    <button class="enterBtn" id="enterBtn" type="button">ENTRA</button>
  </div>

  <div class="wrap" id="app" style="opacity:0; transform: translateY(8px); transition: opacity .5s ease, transform .5s ease;">
    <div class="topbar">
      <div class="title">
        <div style="font-size:22px;">üå≤</div>
        <div>
          <div style="font-size:16px;font-weight:900;">Calendario Scout nel Bosco</div>
          <div class="muted">2026 ‚Üí 2029 ¬∑ <b>Solo compleanni</b> üéÇ</div>
        </div>
      </div>

      <div class="controls">
        <button id="prev" type="button">‚¨ÖÔ∏è</button>
        <div class="monthTitle" id="monthTitle">‚Äî</div>
        <button id="next" type="button">‚û°Ô∏è</button>

        <select id="yearSel">
          <option>2026</option>
          <option>2027</option>
          <option>2028</option>
          <option>2029</option>
        </select>

        <button id="todayBtn" type="button">Oggi</button>
      </div>
    </div>

    <div class="stage" id="stage">
      <div class="frame"></div>
      <div class="content">
        <div class="grid" id="dow"></div>
        <div style="height:10px"></div>
        <div class="grid" id="cal"></div>
        <div class="monthEvents" id="monthEvents"></div>
      </div>
    </div>

    <div class="accordion" id="accordion">
      <div class="accItem open" id="accCountdown">
        <button class="accBtn" type="button" data-acc="accCountdown">
          <div class="accLeft">
            <div class="accIco">üîî</div>
            <p class="accTitle">Avvisi compleanni (alle 09:00: -10, -5, 0 giorni)</p>
          </div>
          <div class="chev">‚ñæ</div>
        </button>
        <div class="accBody">
          <div class="cards" id="countCards"></div>
          <!-- ‚úÖ NOTA RIMOSSA QUI -->
        </div>
      </div>

      <div class="accItem" id="accThoughts">
        <button class="accBtn" type="button" data-acc="accThoughts">
          <div class="accLeft">
            <div class="accIco">üí≠</div>
            <p class="accTitle">Pensieri</p>
          </div>
          <div class="chev">‚ñæ</div>
        </button>
        <div class="accBody">
          <p class="muted" style="margin:0 0 10px;">Scrivi qui. Rimane salvato sul tuo dispositivo.</p>
          <textarea id="journal" class="journalBox" placeholder="Scrivi qui quello che ti passa per la mente..."></textarea>
          <div class="muted" id="journalStatus" style="margin-top:8px;"></div>
        </div>
      </div>

      <div class="accItem open" id="accKnot">
        <button class="accBtn" type="button" data-acc="accKnot">
          <div class="accLeft">
            <div class="accIco">üßµ</div>
            <p class="accTitle">Nodo del giorno</p>
          </div>
          <div class="chev">‚ñæ</div>
        </button>
        <div class="accBody">
          <div class="knotBox">
            <!-- ‚úÖ cliccabile: apre lightbox -->
            <div class="knotImg" id="knotImg" title="Clicca per ingrandire"></div>

            <div class="knotText">
              <p class="knotName" id="knotName">‚Äî</p>
              <p class="knotDesc" id="knotDesc">‚Äî</p>
              <!-- ‚úÖ ASCII ART RIMOSSA COMPLETAMENTE -->
            </div>
          </div>
        </div>
      </div>

      <div class="accItem open" id="accCompass">
        <button class="accBtn" type="button" data-acc="accCompass">
          <div class="accLeft">
            <div class="accIco">üß≠</div>
            <p class="accTitle">Bussola morale</p>
          </div>
          <div class="chev">‚ñæ</div>
        </button>
        <div class="accBody">
          <div class="compassWrap">
            <div class="compass" aria-label="Bussola morale">
              <div class="needle" id="needle"></div>
            </div>
            <div>
              <p class="virtueName" id="virtueName">‚Äî</p>
              <p class="virtueDesc" id="virtueDesc">‚Äî</p>
            </div>
          </div>
        </div>
      </div>

      <div class="accItem open" id="accTimeline">
        <button class="accBtn" type="button" data-acc="accTimeline">
          <div class="accLeft">
            <div class="accIco">üï∞Ô∏è</div>
            <p class="accTitle">Linea del tempo scout (Jamboree)</p>
          </div>
          <div class="chev">‚ñæ</div>
        </button>
        <div class="accBody">
          <div class="timeline" id="timeline"></div>
          <p class="muted" style="margin:10px 0 0;">Scorri a destra/sinistra üëâ</p>
        </div>
      </div>

      <div class="accItem" id="accLaws">
        <button class="accBtn" type="button" id="lawsBtn">
          <div class="accLeft">
            <div class="accIco">üìú</div>
            <p class="accTitle">Legge Scout</p>
          </div>
          <div class="chev">‚ñæ</div>
        </button>
        <div class="accBody">
          <p class="muted" style="margin:0;">Apri la finestra con la legge scout.</p>
        </div>
      </div>
    </div>

    <details class="photoWin" id="photoWin">
      <summary>
        <div class="sumLeft">
          <div class="sumIco">üì∑</div>
          <div>Foto campo estivo 2025</div>
        </div>
        <div class="sumChev">‚ñæ</div>
      </summary>
      <div class="galleryWrap">
        <div class="galleryGrid" id="galleryGrid"></div>
        <p class="muted" style="margin:10px 0 0;">
          Nota: i file <b>.HEIC</b> non sempre si vedono nel browser. Qui ci sono JPG/MP4 quindi ok.
        </p>
      </div>
    </details>

    <div class="footerWindow">
      <b>Site created by Mattia Spensieri</b>
    </div>
  </div>

  <div class="modalBackdrop" id="lawsBackdrop">
    <div class="modal">
      <div class="modalHeader">
        <h3 class="modalTitle">üìú Legge Scout</h3>
        <button id="lawsClose" type="button">Chiudi ‚úñ</button>
      </div>
      <div class="modalBody">
        <div class="line"><div class="ico">1Ô∏è‚É£</div><div><b>Lo scout √® leale.</b><div class="sub">Dice la verit√† e mantiene la parola data.</div></div></div>
        <div class="line"><div class="ico">2Ô∏è‚É£</div><div><b>Lo scout √® amico di tutti e fratello di ogni altro scout.</b><div class="sub">Aiuta senza guardare chi sei.</div></div></div>
        <div class="line"><div class="ico">3Ô∏è‚É£</div><div><b>Lo scout √® cortese.</b><div class="sub">Rispetta gli altri e si comporta bene.</div></div></div>
        <div class="line"><div class="ico">4Ô∏è‚É£</div><div><b>Lo scout ama e rispetta la natura.</b><div class="sub">Protegge il bosco, gli animali e l‚Äôambiente.</div></div></div>
        <div class="line"><div class="ico">5Ô∏è‚É£</div><div><b>Lo scout sorride e canta anche nelle difficolt√†.</b><div class="sub">Non si arrende e porta buon umore.</div></div></div>
        <div class="line"><div class="ico">6Ô∏è‚É£</div><div><b>Lo scout √® laborioso ed economo.</b><div class="sub">Usa bene le cose e non spreca.</div></div></div>
        <div class="line"><div class="ico">7Ô∏è‚É£</div><div><b>Lo scout √® puro nei pensieri, parole e azioni.</b><div class="sub">Fa scelte giuste e rispettose.</div></div></div>
      </div>
    </div>
  </div>

  <div class="lightbox" id="lightbox">
    <div class="lbBox">
      <div class="lbTop">
        <div class="lbTitle" id="lbTitle">Media</div>
        <button class="lbClose" id="lbClose" type="button">Chiudi ‚úñ</button>
      </div>
      <div id="lbMediaHost"></div>
    </div>
  </div>

  <div class="toastWrap" id="toastWrap"></div>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js").catch(console.error);
    });
  }

  const pad = n => String(n).padStart(2,"0");
  const ymd = (y,m,d) => `${y}-${pad(m)}-${pad(d)}`;
  const itMonth = (y,m) => new Date(y, m-1, 1).toLocaleString("it-IT",{month:"long", year:"numeric"});
  const DOW = ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];
  const YEAR_MIN = 2026, YEAR_MAX = 2029;
  const inRange = y => (y>=YEAR_MIN && y<=YEAR_MAX);

  function daysBetween(a,b){
    const A = new Date(a.getFullYear(), a.getMonth(), a.getDate());
    const B = new Date(b.getFullYear(), b.getMonth(), b.getDate());
    return Math.round((B - A) / (1000*60*60*24));
  }

  function dateToObj(iso){
    const [y,m,d] = iso.split("-").map(n=>parseInt(n,10));
    return new Date(y, m-1, d);
  }

  const intro = document.getElementById("intro");
  const enterBtn = document.getElementById("enterBtn");
  const app = document.getElementById("app");

  const dowEl = document.getElementById("dow");
  const calEl = document.getElementById("cal");
  const monthTitleEl = document.getElementById("monthTitle");
  const yearSel = document.getElementById("yearSel");
  const monthEventsBox = document.getElementById("monthEvents");
  const countCards = document.getElementById("countCards");

  const journal = document.getElementById("journal");
  const journalStatus = document.getElementById("journalStatus");

  const knotImg = document.getElementById("knotImg");
  const knotName = document.getElementById("knotName");
  const knotDesc = document.getElementById("knotDesc");

  const needle = document.getElementById("needle");
  const virtueName = document.getElementById("virtueName");
  const virtueDesc = document.getElementById("virtueDesc");

  const lawsBtn = document.getElementById("lawsBtn");
  const lawsBackdrop = document.getElementById("lawsBackdrop");
  const lawsClose = document.getElementById("lawsClose");

  const galleryGrid = document.getElementById("galleryGrid");
  const lightbox = document.getElementById("lightbox");
  const lbTitle = document.getElementById("lbTitle");
  const lbClose = document.getElementById("lbClose");
  const lbMediaHost = document.getElementById("lbMediaHost");

  const toastWrap = document.getElementById("toastWrap");
  const confettiBox = document.getElementById("confetti");
  const timelineEl = document.getElementById("timeline");

  let stateYear = 2026;
  let stateMonth = 1;

  const BIRTHDAYS = [
    { id:"mariateresa", name:"Mariateresa", day:7,  month:1,  icon:"üéÇ" },
    { id:"clara",       name:"Clara",       day:19, month:1,  icon:"üéÇ" },
    { id:"cristian",    name:"Cristian",    day:28, month:1,  icon:"üéÇ" },
    { id:"ambra",       name:"Ambra",       day:28, month:2,  icon:"üéÇ" },
    { id:"arta",        name:"Arta",        day:22, month:3,  icon:"üéÇ" },
    { id:"ginevra",     name:"Ginevra Di Buono", day:22, month:3, icon:"üéÇ" },
    { id:"greta",       name:"Greta Iorio", day:28, month:3,  icon:"üéÇ" },
    { id:"eliana",      name:"Eliana Alfieri", day:30, month:4, icon:"üéÇ" },
    { id:"rudi",        name:"Rudi",        day:11, month:5,  icon:"üéÇ" },
    { id:"annalisa",    name:"Annalisa",    day:22, month:5,  icon:"üéÇ" },
    { id:"alessia",     name:"Alessia Di Michele", day:12, month:6, icon:"üéÇ" },
    { id:"lorenzo",     name:"Lorenzo",     day:18, month:6,  icon:"üéÇ" },
    { id:"paolo",       name:"Paolo Iannetta", day:20, month:6, icon:"üéÇ" },
    { id:"pasquale",    name:"Pasquale Petrone", day:1, month:7, icon:"üéÇ" },
    { id:"loris",       name:"Loris",       day:16, month:7,  icon:"üéÇ" },
    { id:"vittorio",    name:"Vittorio",    day:20, month:8,  icon:"üéÇ" },
    { id:"gabriele",    name:"Gabriele Pio Ciocca", day:13, month:9, icon:"üéÇ" },
    { id:"sofia",       name:"Sofia",       day:31, month:10, icon:"üéÇ" },
    { id:"giuseppe",    name:"Giuseppe",    day:18, month:11, icon:"üéÇ" },
    { id:"giulia",      name:"Giulia Leone",day:15, month:11, icon:"üéÇ" },
    { id:"chiara",      name:"Chiara",      day:22, month:12, icon:"üéÇ" },
    { id:"simone",      name:"Simone",      day:18, month:12, icon:"üéÇ" }
  ];

  function getAllBirthdaysForYear(year){
    return BIRTHDAYS.map(b=>{
      const d = new Date(year, b.month-1, b.day);
      return {
        id: b.id,
        icon: b.icon,
        name: b.name,
        kind: "birthday",
        dateObj: d,
        date: ymd(year, b.month, b.day)
      };
    });
  }

  // ‚úÖ NODI (solo immagine + descrizione, senza ASCII ART)
  const KNOTS = [
    {
      id:"nodo_savoia",
      name:"Nodo Savoia (nodo dell‚Äôamicizia scout)",
      img:"ChatGPT Image 27 gen 2026, 17_09_46.png",
      desc:"Nodo simbolico scout (amicizia). Bello da mostrare e ricordare."
    },
    {
      id:"nodo_parlato",
      name:"Nodo parlato",
      img:"ChatGPT Image 27 gen 2026, 17_09_38.png",
      desc:"Per fissare una corda a un palo. Molto usato in campo e nei lavori di legatura."
    },
    {
      id:"nodo_piano",
      name:"Nodo piano (o nodo diritto)",
      img:"ChatGPT Image 27 gen 2026, 17_09_36.png",
      desc:"Unisce due corde simili. Semplice ma va fatto bene (occhio al verso!)."
    },
    {
      id:"gassa_damante",
      name:"Gassa d‚Äôamante",
      img:"ChatGPT Image 27 gen 2026, 17_15_10.png",
      desc:"Cappio fisso che non scorre. Utilissimo quando ti serve un anello sicuro."
    },
    {
      id:"prusik",
      name:"Nodo Prusik",
      img:"ChatGPT Image 27 gen 2026, 17_15_10.png",
      desc:"Nodo autobloccante su corda. Si usa in progressione/recupero con grande attenzione."
    },
    {
      id:"legatura_quadra",
      name:"Legatura quadra",
      img:"ChatGPT Image 27 gen 2026, 17_15_10.png",
      desc:"Per unire due pali a 90¬∞. Classica per costruzioni di campo."
    },
    {
      id:"nodo_bandiera",
      name:"Nodo bandiera",
      img:"ChatGPT Image 27 gen 2026, 17_23_01.png",
      desc:"Per unire due corde anche diverse. Tieni ben serrato e controlla sempre."
    }
  ];

  const VIRTUES = [
    { name:"Coraggio", desc:"Fare la cosa giusta anche quando hai paura." },
    { name:"Aiuto", desc:"Dare una mano senza aspettarsi niente in cambio." },
    { name:"Onest√†", desc:"Dire la verit√† e rispettare la parola data." },
    { name:"Lealt√†", desc:"Essere affidabile con gli altri e con te stesso." },
    { name:"Servizio", desc:"Mettere il bene comune davanti alla comodit√† personale." }
  ];

  function buildTimeline(){
    const items = [
      { year:"1920", text:"1¬∞ World Scout Jamboree ‚Äî Olympia, Londra (30 luglio‚Äì8 agosto)." },
      { year:"1947", text:"Jamboree della Pace ‚Äî ripartenza dopo la guerra (Francia)." },
      { year:"1957", text:"50 anni di scoutismo ‚Äî Jamboree a Sutton Park (UK)." },
      { year:"2007", text:"Centenario dello scoutismo ‚Äî grande celebrazione mondiale." },
      { year:"2019", text:"Jamboree ‚Äî Nord America (USA)." },
      { year:"2023", text:"Jamboree ‚Äî Corea del Sud (Saemangeum)." },
      { year:"2027", text:"Jamboree ‚Äî Polonia (Gda≈Ñsk), 30 luglio‚Äì8 agosto." }
    ];

    timelineEl.innerHTML = "";
    items.forEach(x=>{
      const div = document.createElement("div");
      div.className="timeItem";
      div.innerHTML = `<p class="timeYear">${x.year}</p><p class="timeText">${x.text}</p>`;
      timelineEl.appendChild(div);
    });
  }

  function firstDayOffset(y,m){
    const js = new Date(y, m-1, 1).getDay();
    return (js + 6) % 7;
  }
  function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); }

  function setTheme(){
    const m = stateMonth;
    const hour = new Date().getHours();
    const night = (hour >= 20 || hour < 7);

    let overlayA = "rgba(8,25,14,.58)", overlayB = "rgba(8,25,14,.26)";
    if([12,1,2].includes(m)) { overlayA="rgba(8,16,32,.64)"; overlayB="rgba(8,16,32,.30)"; }
    if([6,7,8].includes(m)) { overlayA="rgba(40,22,6,.58)"; overlayB="rgba(15,35,18,.22)"; }
    if([9,10,11].includes(m)) { overlayA="rgba(22,12,6,.62)"; overlayB="rgba(15,30,16,.24)"; }

    document.documentElement.style.setProperty("--overlayA", night ? "rgba(0,0,0,.72)" : overlayA);
    document.documentElement.style.setProperty("--overlayB", night ? "rgba(0,0,0,.32)" : overlayB);
    document.documentElement.style.setProperty("--fliesOpacity", night ? ".95" : ".55");
  }

  function birthdaysByKeyForCurrentView(){
    const list = getAllBirthdaysForYear(stateYear);
    const map = new Map();
    list.forEach(e=>{
      const key = e.date;
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(e);
    });
    return map;
  }

  function markerForDate(key, eventMap){
    const evs = eventMap.get(key);
    if(!evs || !evs.length) return "";
    const icons = evs.slice(0,2).map(x=>x.icon).join("");
    return icons;
  }

  function renderDOW(){
    dowEl.innerHTML = "";
    DOW.forEach(d=>{
      const div = document.createElement("div");
      div.className="dow";
      div.textContent = d;
      dowEl.appendChild(div);
    });
  }

  function renderCalendar(){
    if(!inRange(stateYear)){ stateYear=YEAR_MIN; stateMonth=1; }
    setTheme();

    monthTitleEl.textContent = itMonth(stateYear, stateMonth);
    yearSel.value = String(stateYear);
    calEl.innerHTML = "";

    const today = new Date();
    const todayKey = ymd(today.getFullYear(), today.getMonth()+1, today.getDate());

    const offset = firstDayOffset(stateYear, stateMonth);
    const dim = daysInMonth(stateYear, stateMonth);

    const prevMonth = stateMonth === 1 ? 12 : stateMonth - 1;
    const prevYear  = stateMonth === 1 ? stateYear - 1 : stateYear;
    const nextMonth = stateMonth === 12 ? 1 : stateMonth + 1;
    const nextYear  = stateMonth === 12 ? stateYear + 1 : stateYear;

    const dimPrev = daysInMonth(prevYear, prevMonth);
    const eventMap = birthdaysByKeyForCurrentView();

    let cells = 0;

    for(let i=0;i<offset;i++){
      const dayNum = dimPrev - offset + 1 + i;
      const key = ymd(prevYear, prevMonth, dayNum);
      calEl.appendChild(makeDayCell(prevYear, prevMonth, dayNum, key, true, todayKey, eventMap));
      cells++;
    }

    for(let d=1; d<=dim; d++){
      const key = ymd(stateYear, stateMonth, d);
      calEl.appendChild(makeDayCell(stateYear, stateMonth, d, key, false, todayKey, eventMap));
      cells++;
    }

    let nextDay = 1;
    while(cells < 42){
      const key = ymd(nextYear, nextMonth, nextDay);
      calEl.appendChild(makeDayCell(nextYear, nextMonth, nextDay, key, true, todayKey, eventMap));
      cells++;
      nextDay++;
    }

    renderMonthEventsList(eventMap);
  }

  function makeDayCell(y,m,d,key,isOff,todayKey,eventMap){
    const div = document.createElement("div");
    div.className = "day" + (isOff ? " off" : "") + (key===todayKey ? " today" : "");

    const evs = eventMap.get(key) || [];
    const marker = markerForDate(key, eventMap);

    if(evs.length && !isOff) div.classList.add("eventDay");
    div.dataset.key = key;

    div.innerHTML = `
      <div class="n">${d}</div>
      ${marker && !isOff ? `<div class="marker"><span>${marker}</span><span class="dotRed"></span></div>` : ""}
    `;

    if(evs.length && !isOff){
      div.style.cursor = "pointer";
      div.addEventListener("click", ()=>{
        div.classList.remove("jumpFlash");
        void div.offsetWidth;
        div.classList.add("jumpFlash");
        spawnConfettiBurst();
      });
    }
    return div;
  }

  function renderMonthEventsList(eventMap){
    monthEventsBox.innerHTML = "";

    const dim = daysInMonth(stateYear, stateMonth);
    const keys = [];
    for(let d=1; d<=dim; d++) keys.push(ymd(stateYear, stateMonth, d));

    const items = [];
    keys.forEach(k=>{
      const evs = eventMap.get(k);
      if(evs && evs.length){
        evs.forEach(e => items.push({ key:k, e }));
      }
    });

    if(items.length === 0){
      const line = document.createElement("div");
      line.className="monthEventsLine";
      line.innerHTML = `<div class="monthEventsIco">üåô</div><div class="monthEventsTxt">Nessun compleanno in questo mese</div>`;
      monthEventsBox.appendChild(line);
      return;
    }

    items.forEach(item=>{
      const dt = dateToObj(item.key);
      const label = dt.toLocaleDateString("it-IT",{day:"2-digit", month:"long"});
      const line = document.createElement("div");
      line.className="monthEventsLine";
      line.innerHTML = `
        <div class="monthEventsIco">üéÇ</div>
        <div class="monthEventsTxt">
          <b>${item.e.name}</b>
          <div class="monthEventsSub">üìÖ ${label}</div>
        </div>
      `;
      line.addEventListener("click", ()=> jumpToDate(item.key));
      monthEventsBox.appendChild(line);
    });
  }

  function jumpToDate(isoKey){
    const [y,m] = isoKey.split("-").map(n=>parseInt(n,10));
    if(!inRange(y)) return;
    stateYear = y; stateMonth = m;
    renderCalendar();

    requestAnimationFrame(()=>{
      const cell = calEl.querySelector(`[data-key="${isoKey}"]`);
      if(cell){
        cell.scrollIntoView({behavior:"smooth", block:"center"});
        cell.classList.remove("jumpFlash");
        void cell.offsetWidth;
        cell.classList.add("jumpFlash");
      }
    });
  }

  function buildUpcomingBirthdayList(){
    const now = new Date();
    const y = now.getFullYear();
    const all = [...getAllBirthdaysForYear(y), ...getAllBirthdaysForYear(y+1)];

    return all
      .map(e => ({...e, diff: daysBetween(now, e.dateObj)}))
      .filter(e => e.diff >= 0 && e.diff <= 10)
      .sort((a,b)=> a.diff - b.diff);
  }

  function renderCountdown(){
    countCards.innerHTML = "";
    const list = buildUpcomingBirthdayList();

    if(list.length === 0){
      const card = document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <div class="kicker">üîî Avvisi</div>
        <p class="big">Nessun compleanno nei prossimi 10 giorni</p>
        <p class="small">Scorri il calendario per vedere tutti i compleanni segnati.</p>
      `;
      countCards.appendChild(card);
      return;
    }

    list.slice(0,10).forEach(e=>{
      const when = e.dateObj.toLocaleDateString("it-IT", {day:"2-digit", month:"long", year:"numeric"});
      const msg = (e.diff===0)
        ? `üéâ √à oggi il compleanno di ${e.name}!`
        : `Tra ${e.diff} giorni √® il compleanno di ${e.name} (${when}).`;

      const card = document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <div class="kicker">üéÇ Compleanno</div>
        <p class="big">${msg}</p>
        <p class="small">üìÖ ${when}</p>
        <div class="redNote">üî¥ Segnato sul calendario</div>
      `;
      card.addEventListener("click", ()=> jumpToDate(e.date));
      countCards.appendChild(card);
    });
  }

  function showToast({ icon="üéÇ", title="Avviso", message="", onClick=null }){
    const t = document.createElement("div");
    t.className = "toast";
    t.innerHTML = `
      <div class="tIco">${icon}</div>
      <div class="tTxt">
        <b>${title}</b>
        <small>${message}</small>
      </div>
      <button class="tClose" type="button">‚úñ</button>
    `;
    t.querySelector(".tClose").addEventListener("click", ()=> t.remove());

    if(onClick){
      t.style.cursor = "pointer";
      t.addEventListener("click", (e)=>{
        if(e.target && e.target.classList.contains("tClose")) return;
        onClick();
        t.remove();
      });
    }

    toastWrap.prepend(t);
    setTimeout(()=> { if(t.isConnected) t.remove(); }, 12000);
  }

  function canNotify(){ return ("Notification" in window); }

  async function ensureNotificationPermission(){
    if(!canNotify()) return false;
    if(Notification.permission === "granted") return true;
    if(Notification.permission === "denied") return false;
    const res = await Notification.requestPermission();
    return res === "granted";
  }

  function pushWebNotification(title, body){
    if(!canNotify()) return;
    if(Notification.permission !== "granted") return;
    try{ new Notification(title, { body }); }catch(e){}
  }

  const NOTIF_KEY = "birthday_notifs_9am_v1";
  const ALERT_DAYS = new Set([10, 5, 0]);

  function loadNotifState(){
    try{ return JSON.parse(localStorage.getItem(NOTIF_KEY) || "{}"); }
    catch{ return {}; }
  }
  function saveNotifState(state){
    localStorage.setItem(NOTIF_KEY, JSON.stringify(state));
  }

  function todayIso(){
    const now = new Date();
    return ymd(now.getFullYear(), now.getMonth()+1, now.getDate());
  }

  function isAroundNineAM(now){
    const h = now.getHours();
    const min = now.getMinutes();
    return (h === 9 && min <= 15);
  }

  function checkBirthdayAlertsAt9(){
    const now = new Date();
    if(!isAroundNineAM(now)) return;

    const state = loadNotifState();
    const today = todayIso();

    const y = now.getFullYear();
    const all = [...getAllBirthdaysForYear(y), ...getAllBirthdaysForYear(y+1)];
    const list = all
      .map(e => ({...e, diff: daysBetween(now, e.dateObj)}))
      .filter(e => e.diff >= 0 && e.diff <= 10)
      .filter(e => ALERT_DAYS.has(e.diff));

    list.forEach(e=>{
      const dedupeKey = `${e.id}_${e.diff}_${today}`;
      if(state[dedupeKey]) return;

      const when = e.dateObj.toLocaleDateString("it-IT", {day:"2-digit", month:"long", year:"numeric"});

      let title = "üéÇ Compleanno in arrivo";
      let msg = `Tra ${e.diff} giorni √® il compleanno di ${e.name} (${when}).`;

      if(e.diff === 10) msg = `‚è≥ Tra meno di 10 giorni √® il compleanno di ${e.name} (${when}).`;
      if(e.diff === 5)  msg = `‚ö†Ô∏è Tra 5 giorni √® il compleanno di ${e.name} (${when}).`;
      if(e.diff === 0){ title = "üéâ √à oggi!"; msg = `Auguri ${e.name}! (${when})`; }

      showToast({ icon:"üéÇ", title, message: msg, onClick: ()=> jumpToDate(e.date) });
      pushWebNotification(title, msg);

      state[dedupeKey] = true;
    });

    saveNotifState(state);
  }

  const JOURNAL_KEY = "scout_thoughts_v4";
  function loadJournal(){
    const saved = localStorage.getItem(JOURNAL_KEY);
    if(saved !== null) journal.value = saved;
    journalStatus.textContent = saved ? "‚úÖ Testo caricato (salvato sul tuo dispositivo)" : "‚úçÔ∏è Inizia a scrivere‚Ä¶";
  }
  let saveTimer = null;
  function scheduleSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      localStorage.setItem(JOURNAL_KEY, journal.value);
      const t = new Date();
      journalStatus.textContent = "üíæ Salvato: " + t.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});
    }, 220);
  }
  journal.addEventListener("input", scheduleSave);

  // ‚úÖ LIGHTBOX (riusato anche per i nodi)
  function isVideo(file){ return file.toLowerCase().endsWith(".mp4"); }

  function openLightbox(file, titleOverride=null){
    lbTitle.textContent = titleOverride || file;
    lbMediaHost.innerHTML = "";

    if(isVideo(file)){
      const v = document.createElement("video");
      v.className = "lbMedia";
      v.src = file;
      v.controls = true;
      v.autoplay = true;
      v.playsInline = true;
      v.style.objectFit = "contain";
      lbMediaHost.appendChild(v);
    } else {
      const img = document.createElement("img");
      img.className = "lbMedia";
      img.src = file;
      img.alt = titleOverride || file;
      img.style.objectFit = "contain";
      lbMediaHost.appendChild(img);
    }

    lightbox.classList.add("show");
  }

  function closeLightbox(){
    lightbox.classList.remove("show");
    lbMediaHost.innerHTML = "";
  }

  lbClose.addEventListener("click", closeLightbox);
  lightbox.addEventListener("click",(e)=>{ if(e.target===lightbox) closeLightbox(); });
  window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeLightbox(); });

  // ‚úÖ Nodo del giorno (clic sull‚Äôimmagine = ingrandisci)
  let currentKnot = null;
  function setKnotOfDay(){
    const now = new Date();
    const seed = (now.getFullYear()*10000) + ((now.getMonth()+1)*100) + now.getDate();
    const idx = seed % KNOTS.length;
    const k = KNOTS[idx];
    currentKnot = k;

    knotName.textContent = k.name;
    knotDesc.textContent = k.desc || "‚Äî";

    if(k.img){
      knotImg.innerHTML = `
        <img src="${k.img}" alt="${k.name}">
        <div class="knotImgCap">üîç Clicca per ingrandire</div>
      `;
    } else {
      knotImg.innerHTML = `
        <img src="frame.jpg" alt="Nodo del giorno">
        <div class="knotImgCap">Nodo del giorno</div>
      `;
    }
  }

  // ‚úÖ click sull‚Äôimmagine del nodo -> lightbox
  knotImg.addEventListener("click", ()=>{
    if(currentKnot && currentKnot.img){
      openLightbox(currentKnot.img, currentKnot.name);
    }
  });

  function setVirtueOfDay(){
    const now = new Date();
    const seed = (now.getFullYear()*10000) + ((now.getMonth()+1)*100) + now.getDate();
    const idx = seed % VIRTUES.length;
    const v = VIRTUES[idx];

    virtueName.textContent = `Virt√π del giorno: ${v.name}`;
    virtueDesc.textContent = v.desc;

    const angle = idx * 72;
    needle.style.transform = `translateX(-50%) rotate(${angle}deg)`;
  }

  document.querySelectorAll(".accBtn[data-acc]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-acc");
      const item = document.getElementById(id);
      item.classList.toggle("open");
    });
  });

  lawsBtn.addEventListener("click", ()=> lawsBackdrop.classList.add("show"));
  lawsClose.addEventListener("click", ()=> lawsBackdrop.classList.remove("show"));
  lawsBackdrop.addEventListener("click", (e)=>{ if(e.target===lawsBackdrop) lawsBackdrop.classList.remove("show"); });

  document.getElementById("prev").addEventListener("click", ()=>{
    stateMonth--;
    if(stateMonth<1){ stateMonth=12; stateYear--; }
    if(!inRange(stateYear)){ stateYear=YEAR_MIN; stateMonth=1; }
    renderCalendar();
  });
  document.getElementById("next").addEventListener("click", ()=>{
    stateMonth++;
    if(stateMonth>12){ stateMonth=1; stateYear++; }
    if(!inRange(stateYear)){ stateYear=YEAR_MAX; stateMonth=12; }
    renderCalendar();
  });
  yearSel.addEventListener("change", ()=>{
    stateYear = parseInt(yearSel.value,10);
    renderCalendar();
  });
  document.getElementById("todayBtn").addEventListener("click", ()=>{
    const t = new Date();
    if(t.getFullYear()<YEAR_MIN || t.getFullYear()>YEAR_MAX){ stateYear=YEAR_MIN; stateMonth=1; }
    else { stateYear=t.getFullYear(); stateMonth=t.getMonth()+1; }
    renderCalendar();
  });

  const stage = document.getElementById("stage");
  let touchStartX = null;
  stage.addEventListener("touchstart",(e)=>{ touchStartX = e.touches[0].clientX; }, {passive:true});
  stage.addEventListener("touchend",(e)=>{
    if(touchStartX===null) return;
    const endX = e.changedTouches[0].clientX;
    const dx = endX - touchStartX;
    touchStartX = null;
    if(Math.abs(dx) < 40) return;
    if(dx < 0) document.getElementById("next").click();
    else document.getElementById("prev").click();
  }, {passive:true});

  function spawnConfettiBurst(){
    const n = 24;
    const colors = [
      "rgba(255,210,77,.92)",
      "rgba(124,255,138,.85)",
      "rgba(255,255,255,.85)",
      "rgba(255,63,63,.80)"
    ];
    for(let i=0;i<n;i++){
      const c = document.createElement("div");
      c.className = "conf";
      c.style.left = (10 + Math.random()*80) + "vw";
      c.style.background = colors[i % colors.length];
      c.style.setProperty("--t", (1.8 + Math.random()*1.2) + "s");
      c.style.setProperty("--dx", ((Math.random()*360)-180) + "px");
      confettiBox.appendChild(c);
      setTimeout(()=>{ if(c.isConnected) c.remove(); }, 3200);
    }
  }

  // MEDIA campo estivo
  const MEDIA = [
    "1e38146e-d6d7-4fdd-bcb2-8a6b0887210e.jpg",
    "3e799a83-3336-47db-a2eb-bc55540677ba.jpg",
    "5aae342f-8b7f-43c5-85e9-13f6881e8f67.jpg",
    "7e9d6930-3cb9-41a5-bae0-9e788f0abe50.jpg",
    "8c78f8ec-652a-434f-ab06-e3e0788ecb31.jpg",
    "8cc7054e-5881-420c-ba3a-435828560198.jpg",
    "85ffc3dd-2321-4804-bd00-90a326a38b5f.jpg",
    "95f82bcc-fe77-4a68-8089-a165afb315ee.jpg",
    "338867c3-8486-4749-b364-f76e9232028a.jpg",
    "91583127-dee0-4e25-bf9b-3ca8c7311e1c.jpg",
    "a400cc11-4b2f-4672-8595-baeba587dacc.jpg",
    "bdb6b79f-82a4-4800-8dec-98e9161d8f12.jpg",
    "d24c8755-7cc8-464e-8a19-38c0e46e2dec.jpg",
    "e08df019-6c8c-40b5-b813-802f3b8d41f7.jpg",
    "E28F1480-5C8A-4E67-8C5D-D545474F5B32.jpg",
    "f98df94d-5212-492c-a8a2-742e5ee1360c.jpg",
    "5f08d156-ad8b-420c-8b9a-6662ce952cd5.mp4",
    "dbea094f-77fa-4787-b1be-5e750421b67c.mp4",
    "e62058ee-c8e9-4616-a3fe-fa8a46110433.mp4"
  ];

  function renderGallery(){
    galleryGrid.innerHTML = "";
    MEDIA.forEach(file=>{
      const box = document.createElement("div");
      box.className = "thumb";

      if(isVideo(file)){
        box.innerHTML = `
          <video src="${file}" muted playsinline preload="metadata"></video>
          <div class="thumbCap">üé¨ ${file}<small>Tocca per aprire</small></div>
        `;
      } else {
        box.innerHTML = `
          <img src="${file}" alt="${file}" loading="lazy">
          <div class="thumbCap">üì∑ ${file}<small>Tocca per aprire</small></div>
        `;
      }

      box.addEventListener("click", ()=> openLightbox(file, file));
      galleryGrid.appendChild(box);
    });
  }

  async function doEnter(){
    intro.classList.add("hide");
    app.style.opacity = "1";
    app.style.transform = "translateY(0)";
    await ensureNotificationPermission();
    checkBirthdayAlertsAt9();
    try{ localStorage.setItem("scout_entered_v1","1"); }catch(e){}
  }

  (function init(){
    renderDOW();
    renderCalendar();
    renderCountdown();
    loadJournal();
    setKnotOfDay();
    setVirtueOfDay();
    buildTimeline();
    setTheme();
    renderGallery();

    checkBirthdayAlertsAt9();

    setInterval(()=>{
      setTheme();
      renderCountdown();
      setKnotOfDay();
      setVirtueOfDay();
      checkBirthdayAlertsAt9();
    }, 60000);

    enterBtn.addEventListener("click", doEnter);
  })();
</script>
</body>
</html>
