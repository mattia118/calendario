<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Calendario Scout nel Bosco (2026‚Äì2029) ‚Äî Compleanni</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#08190e">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --bg:#08190e;
    --text:#eef7ef;
    --muted:rgba(238,247,239,.78);
    --panel:rgba(255,255,255,.10);
    --panel2:rgba(255,255,255,.14);
    --shadow:0 18px 50px rgba(0,0,0,.55);
    --radius:18px;
    --btn:rgba(0,0,0,.22);
    --btnBorder:rgba(255,255,255,.18);
    --overlayA:rgba(8,25,14,.58);
    --overlayB:rgba(8,25,14,.26);

    /* üî• metti qui la tua immagine */
    --bgUrl: url("ChatGPT Image 19 gen 2026, 21_00_05.png");
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    min-height:100vh;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--text);
    background: var(--bg);
    overflow-x:hidden;
  }

  /* sfondo */
  .bg{
    position:fixed; inset:0; z-index:-10;
    background-image:var(--bgUrl);
    background-size:cover;
    background-position:center;
    transform:scale(1.03);
  }
  .bgOverlay{
    position:fixed; inset:0; z-index:-9;
    background:
      radial-gradient(1200px 800px at 20% 10%, rgba(124,255,138,.18), transparent 55%),
      radial-gradient(900px 600px at 90% 20%, rgba(255,210,77,.16), transparent 60%),
      linear-gradient(160deg, var(--overlayA), var(--overlayB));
  }

  /* intro */
  .intro{
    position:fixed; inset:0; z-index:50;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.62);
    backdrop-filter: blur(10px);
    transition: opacity .6s ease, transform .6s ease;
  }
  .intro.hide{opacity:0; pointer-events:none; transform:scale(1.02)}
  .introRing{
    position:absolute;
    width:280px;height:280px;border-radius:50%;
    border:1px solid rgba(255,255,255,.22);
    box-shadow:0 0 60px rgba(255,255,255,.10);
    animation:ring 3.2s ease-in-out infinite;
  }
  .introRing::after{
    content:""; position:absolute; inset:-18px; border-radius:50%;
    border:1px dashed rgba(255,210,77,.22);
    animation:ring2 6.8s linear infinite;
  }
  @keyframes ring{0%,100%{transform:scale(1);opacity:.65}50%{transform:scale(1.06);opacity:.95}}
  @keyframes ring2{to{transform:rotate(360deg)}}
  .enterBtn{
    position:relative;
    padding:22px 46px;
    font-size:26px;
    font-weight:900;
    letter-spacing:.06em;
    border-radius:999px;
    border:2px solid rgba(255,255,255,.48);
    background:rgba(0,0,0,.30);
    color:var(--text);
    cursor:pointer;
    box-shadow:0 22px 60px rgba(0,0,0,.55), 0 0 40px rgba(255,255,255,.18);
    overflow:hidden;
    animation:pulse 2.2s ease-in-out infinite;
  }
  .enterBtn::after{
    content:""; position:absolute; inset:-70px;
    background:radial-gradient(320px 220px at 30% 30%, rgba(255,255,255,.14), transparent 60%);
    transform:translateX(-40%);
    animation:shimmer 2.6s ease-in-out infinite;
  }
  @keyframes shimmer{0%,100%{opacity:.25;transform:translateX(-40%)}50%{opacity:.55;transform:translateX(40%)}}
  @keyframes pulse{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}

  /* layout */
  .wrap{max-width:1080px; margin:22px auto 46px; padding:14px; position:relative; z-index:2}
  .topbar{
    display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    padding:14px; border-radius:var(--radius);
    background:var(--panel); border:1px solid var(--panel2);
    box-shadow:var(--shadow); backdrop-filter: blur(10px);
  }
  .title{display:flex; gap:10px; align-items:center; font-weight:900}
  .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  button,select{
    border:1px solid var(--btnBorder);
    background:var(--btn);
    color:var(--text);
    padding:10px 12px;
    border-radius:14px;
    cursor:pointer;
    outline:none;
    font-family:inherit;
    transition: transform .18s ease, filter .18s ease, box-shadow .18s ease;
  }
  button:hover,select:hover{transform:translateY(-1px) scale(1.01); filter:brightness(1.08); box-shadow:0 14px 28px rgba(0,0,0,.22)}
  .monthTitle{font-size:18px; font-weight:900; text-transform:capitalize}
  .muted{color:var(--muted); font-size:13px}

  .stage{
    margin-top:14px; border-radius:22px; overflow:hidden;
    box-shadow:var(--shadow);
    border:1px solid rgba(255,255,255,.14);
    background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    backdrop-filter: blur(10px);
  }
  .content{padding:22px 18px 14px}

  .grid{display:grid; grid-template-columns:repeat(7,1fr); gap:10px}
  .dow{
    text-align:center; font-weight:900; font-size:13px;
    color:rgba(0,0,0,.8);
    background:rgba(255,255,255,.84);
    border-radius:12px;
    padding:10px 6px;
    border:1px solid rgba(0,0,0,.08);
  }

  .day{
    border-radius:16px;
    padding:10px;
    background:rgba(255,255,255,.90);
    border:1px solid rgba(0,0,0,.08);
    color:rgba(0,0,0,.88);
    position:relative;
    overflow:hidden;
    display:flex;
    align-items:flex-start;
    justify-content:flex-start;
    transition: transform .18s ease, filter .18s ease, box-shadow .18s ease;
  }
  .day:hover{transform:translateY(-2px) scale(1.01); filter:brightness(1.03); box-shadow:0 16px 30px rgba(0,0,0,.18)}
  .day .n{font-weight:900; font-size:16px}
  .off{opacity:.55}
  .today{outline:3px solid rgba(124,255,138,.75); outline-offset:-3px}

  .marker{
    position:absolute; right:8px; bottom:8px;
    font-size:14px;
    display:flex; align-items:center; gap:6px;
    padding:4px 6px;
    border-radius:999px;
    background:rgba(0,0,0,.10);
    border:1px solid rgba(0,0,0,.08);
  }
  .dotRed{width:7px;height:7px;border-radius:50%;background:rgba(255,63,63,.95); box-shadow:0 0 16px rgba(255,63,63,.45)}

  .eventDay::before{
    content:"";
    position:absolute; inset:-40px;
    background:
      radial-gradient(240px 180px at 25% 25%, rgba(255,63,63,.12), transparent 62%),
      radial-gradient(260px 200px at 80% 40%, rgba(255,210,77,.14), transparent 62%);
    opacity:.9;
    filter: blur(12px);
    pointer-events:none;
  }

  .monthEvents{
    margin-top:10px;
    padding:10px 12px;
    border-radius:16px;
    background:rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.14);
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .monthEventsLine{
    display:flex; gap:10px; align-items:flex-start;
    padding:8px 10px;
    border-radius:14px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    cursor:pointer;
  }
  .monthEventsIco{font-size:18px}
  .monthEventsTxt{font-size:13px; color:rgba(238,247,239,.88)}
  .monthEventsSub{font-size:12px; color:var(--muted); margin-top:2px}

  /* accordion */
  .accordion{margin-top:14px; display:flex; flex-direction:column; gap:12px}
  .accItem{
    background:var(--panel);
    border:1px solid var(--panel2);
    border-radius:20px;
    box-shadow:var(--shadow);
    backdrop-filter: blur(10px);
    overflow:hidden;
  }
  .accBtn{
    width:100%;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:14px;
    border:0;
    background:transparent;
    cursor:pointer;
    color:var(--text);
  }
  .accLeft{display:flex; align-items:center; gap:10px; font-weight:900}
  .accIco{
    width:34px;height:34px;
    display:grid; place-items:center;
    border-radius:12px;
    background:rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.14);
  }
  .accTitle{margin:0; font-size:15px}
  .chev{
    width:40px;height:40px;
    display:grid; place-items:center;
    border-radius:14px;
    background:rgba(0,0,0,.14);
    border:1px solid rgba(255,255,255,.14);
    transition: transform .25s ease;
  }
  .accItem.open .chev{transform:rotate(180deg)}
  .accBody{display:none; padding:0 14px 14px}
  .accItem.open .accBody{display:block}

  .cards{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
  @media(max-width:900px){.cards{grid-template-columns:1fr}}
  .card{
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    padding:12px;
  }
  .kicker{font-size:12px; color:var(--muted); margin-bottom:6px}
  .big{font-size:15px; font-weight:900; margin:0}
  .small{margin:6px 0 0; color:var(--muted); font-size:13px}
  .redNote{margin:8px 0 0; font-weight:900; color:rgba(255,63,63,.95)}

  /* knot */
  .knotBox{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start}
  .knotImg{
    flex:0 0 220px;
    background:rgba(0,0,0,.22);
    border:1px solid rgba(255,255,255,.14);
    border-radius:16px;
    padding:10px;
    box-shadow:0 12px 30px rgba(0,0,0,.25);
    overflow:hidden;
  }
  .knotImg svg{width:100%; height:auto; display:block}
  .knotText{flex:1 1 260px}
  .knotName{font-weight:900; font-size:16px; margin:0}
  .knotDesc{margin:8px 0 0; color:var(--muted)}

  /* bussola */
  .compassWrap{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .compass{
    width:140px;height:140px;border-radius:50%;
    border:2px solid rgba(255,255,255,.35);
    background:rgba(0,0,0,.18);
    position:relative;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  .compass::before{
    content:""; position:absolute; inset:10px; border-radius:50%;
    border:1px dashed rgba(255,210,77,.28);
    opacity:.85;
  }
  .needle{
    position:absolute; left:50%; top:22px;
    width:4px; height:54px;
    transform-origin:50% 100%;
    background:rgba(255,63,63,.95);
    border-radius:6px;
    box-shadow:0 0 18px rgba(255,63,63,.35);
    transform:translateX(-50%) rotate(0deg);
    transition: transform .5s ease;
  }
  .needle::after{
    content:""; position:absolute; left:-6px; top:-6px;
    width:16px; height:16px; border-radius:50%;
    background:rgba(255,255,255,.75);
  }
  .virtueName{margin:0; font-weight:900; font-size:16px}
  .virtueDesc{margin:8px 0 0; color:var(--muted)}

  /* toast */
  .toastWrap{
    position:fixed;
    left:50%; bottom:16px;
    transform:translateX(-50%);
    z-index:500;
    display:grid;
    gap:10px;
    width:min(720px,94vw);
    pointer-events:none;
  }
  .toast{
    pointer-events:auto;
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding:12px 14px;
    border-radius:18px;
    background:rgba(0,0,0,.50);
    border:1px solid rgba(255,255,255,.18);
    box-shadow:0 18px 50px rgba(0,0,0,.55);
    backdrop-filter: blur(10px);
  }
  .toast .tIco{font-size:20px; line-height:1}
  .toast .tTxt{flex:1}
  .toast .tTxt b{display:block; font-size:14px}
  .toast .tTxt small{display:block; color:rgba(238,247,239,.75); margin-top:4px}
  .toast .tClose{
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.08);
    color:var(--text);
    border-radius:12px;
    padding:6px 10px;
    cursor:pointer;
    font-weight:900;
  }

  /* confetti */
  .confetti{position:fixed; inset:0; pointer-events:none; z-index:400; overflow:hidden}
  .conf{
    position:absolute; top:-10px;
    width:10px; height:14px;
    border-radius:4px;
    opacity:0;
    box-shadow:0 10px 26px rgba(0,0,0,.25);
    animation: confFall var(--t) linear forwards;
  }
  @keyframes confFall{
    0%{transform:translate3d(0,-20px,0) rotate(0deg); opacity:0}
    10%{opacity:.9}
    100%{transform:translate3d(var(--dx), 110vh, 0) rotate(680deg); opacity:0}
  }
</style>
</head>

<body>
  <div class="bg"></div>
  <div class="bgOverlay"></div>

  <div class="confetti" id="confetti"></div>

  <!-- INTRO -->
  <div class="intro" id="intro">
    <div class="introRing"></div>
    <button class="enterBtn" id="enterBtn">ENTRA</button>
  </div>

  <div class="wrap" id="app" style="opacity:0; transform: translateY(8px); transition: opacity .5s ease, transform .5s ease;">
    <div class="topbar">
      <div class="title">
        <div style="font-size:22px;">üå≤</div>
        <div>
          <div style="font-size:16px;font-weight:900;">Calendario Scout nel Bosco</div>
          <div class="muted">2026 ‚Üí 2029 ¬∑ <b>Solo compleanni</b> üéÇ</div>
        </div>
      </div>

      <div class="controls">
        <button id="prev">‚¨ÖÔ∏è</button>
        <div class="monthTitle" id="monthTitle">‚Äî</div>
        <button id="next">‚û°Ô∏è</button>

        <select id="yearSel">
          <option>2026</option>
          <option>2027</option>
          <option>2028</option>
          <option>2029</option>
        </select>

        <button id="todayBtn">Oggi</button>
      </div>
    </div>

    <div class="stage" id="stage">
      <div class="content">
        <div class="grid" id="dow"></div>
        <div style="height:10px"></div>
        <div class="grid" id="cal"></div>
        <div class="monthEvents" id="monthEvents"></div>
      </div>
    </div>

    <!-- SEZIONI -->
    <div class="accordion" id="accordion">

      <div class="accItem open" id="accCountdown">
        <button class="accBtn" type="button" data-acc="accCountdown">
          <div class="accLeft">
            <div class="accIco">üîî</div>
            <p class="accTitle">Avvisi compleanni (09:00: -10, -5, 0 giorni)</p>
          </div>
          <div class="chev">‚ñæ</div>
        </button>
        <div class="accBody">
          <div class="cards" id="countCards"></div>
          <p class="muted" style="margin:10px 0 0;">
            Nota: per notifiche push vere serve HTTPS + installazione PWA. Ma l‚Äôapp funziona anche senza.
          </p>
        </div>
      </div>

      <div class="accItem open" id="accKnot">
        <button class="accBtn" type="button" data-acc="accKnot">
          <div class="accLeft">
            <div class="accIco">üßµ</div>
            <p class="accTitle">Nodo del giorno</p>
          </div>
          <div class="chev">‚ñæ</div>
        </button>
        <div class="accBody">
          <div class="knotBox">
            <div class="knotImg" id="knotImg"></div>
            <div class="knotText">
              <p class="knotName" id="knotName">‚Äî</p>
              <p class="knotDesc" id="knotDesc">‚Äî</p>
            </div>
          </div>
        </div>
      </div>

      <div class="accItem open" id="accCompass">
        <button class="accBtn" type="button" data-acc="accCompass">
          <div class="accLeft">
            <div class="accIco">üß≠</div>
            <p class="accTitle">Bussola morale</p>
          </div>
          <div class="chev">‚ñæ</div>
        </button>
        <div class="accBody">
          <div class="compassWrap">
            <div class="compass" aria-label="Bussola morale">
              <div class="needle" id="needle"></div>
            </div>
            <div>
              <p class="virtueName" id="virtueName">‚Äî</p>
              <p class="virtueDesc" id="virtueDesc">‚Äî</p>
            </div>
          </div>
        </div>
      </div>

    </div>

  </div>

  <!-- TOAST -->
  <div class="toastWrap" id="toastWrap"></div>

<script>
/* ============================================================
   ‚úÖ SERVICE WORKER + NOTIFICHE (SAFE) ‚Äî NON BLOCCA MAI ENTRA
   ============================================================ */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    const isSecure =
      location.protocol === "https:" ||
      location.hostname === "localhost" ||
      location.hostname === "127.0.0.1";

    if (!isSecure) {
      console.warn("Service Worker disattivato: serve HTTPS o localhost.");
      return;
    }
    navigator.serviceWorker.register("./service-worker.js")
      .catch(err => console.warn("SW register failed:", err));
  });
}

function canNotify(){
  return ("Notification" in window) &&
    (location.protocol === "https:" || location.hostname === "localhost" || location.hostname === "127.0.0.1");
}

async function ensureNotificationPermission(){
  try{
    if(!canNotify()) return false;
    if(Notification.permission === "granted") return true;
    if(Notification.permission === "denied") return false;
    const res = await Notification.requestPermission();
    return res === "granted";
  }catch(e){
    console.warn("Notifiche non disponibili:", e);
    return false;
  }
}

function pushWebNotification(title, body){
  try{
    if(!canNotify()) return;
    if(Notification.permission !== "granted") return;
    new Notification(title, { body });
  }catch(e){
    console.warn("Push notification error:", e);
  }
}

/* ============================================================
   UTIL
   ============================================================ */
const pad = n => String(n).padStart(2,"0");
const ymd = (y,m,d) => `${y}-${pad(m)}-${pad(d)}`;
const itMonth = (y,m) => new Date(y, m-1, 1).toLocaleString("it-IT",{month:"long", year:"numeric"});
const DOW = ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];
const YEAR_MIN = 2026, YEAR_MAX = 2029;
const inRange = y => (y>=YEAR_MIN && y<=YEAR_MAX);

function daysBetween(a,b){
  const A = new Date(a.getFullYear(), a.getMonth(), a.getDate());
  const B = new Date(b.getFullYear(), b.getMonth(), b.getDate());
  return Math.round((B - A) / (1000*60*60*24));
}
function dateToObj(iso){
  const [y,m,d] = iso.split("-").map(n=>parseInt(n,10));
  return new Date(y, m-1, d);
}
function firstDayOffset(y,m){
  const js = new Date(y, m-1, 1).getDay(); // 0 dom..6 sab
  return (js + 6) % 7; // lun=0..dom=6
}
function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); }

/* ============================================================
   DOM
   ============================================================ */
const intro = document.getElementById("intro");
const enterBtn = document.getElementById("enterBtn");
const app = document.getElementById("app");
const dowEl = document.getElementById("dow");
const calEl = document.getElementById("cal");
const monthTitleEl = document.getElementById("monthTitle");
const yearSel = document.getElementById("yearSel");
const monthEventsBox = document.getElementById("monthEvents");
const countCards = document.getElementById("countCards");

const knotImg = document.getElementById("knotImg");
const knotName = document.getElementById("knotName");
const knotDesc = document.getElementById("knotDesc");

const needle = document.getElementById("needle");
const virtueName = document.getElementById("virtueName");
const virtueDesc = document.getElementById("virtueDesc");

const toastWrap = document.getElementById("toastWrap");
const confettiBox = document.getElementById("confetti");

/* ============================================================
   STATO
   ============================================================ */
let stateYear = 2026;
let stateMonth = 1;

/* ============================================================
   ‚úÖ COMPLEANNI (tutti quelli che mi hai dato)
   ============================================================ */
const BIRTHDAYS = [
  { id:"mariateresa", name:"Mariateresa", day:7,  month:1,  icon:"üéÇ" },
  { id:"clara",       name:"Clara",       day:19, month:1,  icon:"üéÇ" },
  { id:"cristian",    name:"Cristian",    day:28, month:1,  icon:"üéÇ" },

  { id:"ambra",       name:"Ambra",       day:28, month:2,  icon:"üéÇ" },

  { id:"arta",        name:"Arta",        day:22, month:3,  icon:"üéÇ" },
  { id:"ginevra",     name:"Ginevra Di Buono", day:22, month:3, icon:"üéÇ" },
  { id:"greta",       name:"Greta Iorio", day:28, month:3,  icon:"üéÇ" },

  { id:"eliana",      name:"Eliana Alfieri", day:30, month:4, icon:"üéÇ" },

  { id:"rudi",        name:"Rudi",        day:11, month:5,  icon:"üéÇ" },
  { id:"annalisa",    name:"Annalisa",    day:22, month:5,  icon:"üéÇ" },

  { id:"alessia",     name:"Alessia Di Michele", day:12, month:6, icon:"üéÇ" },
  { id:"lorenzo",     name:"Lorenzo",     day:18, month:6,  icon:"üéÇ" },
  { id:"paolo",       name:"Paolo Iannetta", day:20, month:6, icon:"üéÇ" },

  { id:"pasquale",    name:"Pasquale Petrone", day:1, month:7, icon:"üéÇ" },
  { id:"loris",       name:"Loris",       day:16, month:7,  icon:"üéÇ" },

  { id:"vittorio",    name:"Vittorio",    day:20, month:8,  icon:"üéÇ" },

  { id:"gabriele",    name:"Gabriele Pio Ciocca", day:13, month:9, icon:"üéÇ" },

  { id:"sofia",       name:"Sofia",       day:31, month:10, icon:"üéÇ" },

  { id:"giulia",      name:"Giulia Leone", day:15, month:11, icon:"üéÇ" },
  { id:"giuseppe",    name:"Giuseppe",    day:18, month:11, icon:"üéÇ" },

  { id:"simone",      name:"Simone",      day:18, month:12, icon:"üéÇ" },
  { id:"chiara",      name:"Chiara",      day:22, month:12, icon:"üéÇ" }
];

function getAllBirthdaysForYear(year){
  return BIRTHDAYS.map(b=>{
    const d = new Date(year, b.month-1, b.day);
    return {
      id: b.id,
      icon: b.icon,
      name: b.name,
      kind: "birthday",
      dateObj: d,
      date: ymd(year, b.month, b.day)
    };
  });
}

/* ============================================================
   ‚úÖ NODI (immagini SVG)
   ============================================================ */
function knotSvg(kind){
  const stroke1 = "rgba(255,210,77,.92)";
  const stroke2 = "rgba(124,255,138,.82)";

  let p1 = "", p2 = "", circle=false;

  switch(kind){
    case "piano":
      p1 = "M30 70 C60 20, 120 20, 150 70 C180 120, 240 120, 270 70";
      p2 = "M30 90 C70 140, 110 140, 150 90 C190 40, 230 40, 270 90";
      break;
    case "gassa":
      p1 = "M70 130 C40 90, 70 40, 130 55 C170 65, 155 115, 115 110 C90 107, 78 92, 82 75";
      p2 = "M145 120 C185 150, 245 135, 255 95 C265 55, 228 35, 190 45 C162 52, 150 75, 160 95";
      break;
    case "parlato":
      circle = true;
      p1 = "M78 35 C52 72, 52 118, 78 155";
      p2 = "M112 35 C142 70, 142 120, 112 155";
      break;
    case "otto":
      p1 = "M110 40 C70 40, 60 95, 105 108 C150 122, 155 165, 110 165 C70 165, 58 118, 100 110";
      p2 = "M190 40 C230 40, 240 95, 195 108 C150 122, 145 165, 190 165 C230 165, 242 118, 200 110";
      break;
    case "prusik":
      circle = true;
      p1 = "M78 40 C60 80, 60 120, 78 160";
      p2 = "M222 40 C240 80, 240 120, 222 160";
      break;
    case "savoia":
      p1 = "M40 90 C80 40, 120 40, 160 90 C200 140, 240 140, 280 90";
      p2 = "M40 110 C85 160, 120 160, 160 110 C200 60, 235 60, 280 110";
      break;
    default:
      p1 = "M30 80 C80 20, 120 20, 150 80 C180 140, 240 140, 270 80";
      p2 = "M30 100 C80 160, 120 160, 150 100 C180 40, 240 40, 270 100";
  }

  const ring = circle ? `<circle cx="150" cy="95" r="42" fill="none" stroke="rgba(255,255,255,.20)" stroke-width="10"/>` : "";

  return `
  <svg viewBox="0 0 300 190" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Nodo">
    <defs>
      <filter id="g" x="-30%" y="-30%" width="160%" height="160%">
        <feGaussianBlur stdDeviation="3" result="b"/>
        <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <rect x="0" y="0" width="300" height="190" rx="18" fill="rgba(0,0,0,.18)"/>
    <path d="${p1}" fill="none" stroke="${stroke1}" stroke-width="10" stroke-linecap="round" stroke-linejoin="round" filter="url(#g)"/>
    <path d="${p2}" fill="none" stroke="${stroke2}" stroke-width="10" stroke-linecap="round" stroke-linejoin="round" filter="url(#g)"/>
    ${ring}
    <circle cx="38" cy="78" r="6" fill="${stroke1}"/>
    <circle cx="262" cy="112" r="6" fill="${stroke2}"/>
  </svg>`;
}

const KNOTS = [
  { name:"Nodo piano",     svg:knotSvg("piano"),   desc:"Unisce due corde simili. Semplice, ma va fatto bene." },
  { name:"Gassa d‚Äôamante", svg:knotSvg("gassa"),   desc:"Cappio fisso che non scorre. Utilissimo quando ti serve un anello sicuro." },
  { name:"Nodo parlato",   svg:knotSvg("parlato"), desc:"Per fissare una corda a un palo. Molto usato in campo." },
  { name:"Nodo a otto",    svg:knotSvg("otto"),    desc:"Nodo di arresto: sicuro e facilissimo da riconoscere." },
  { name:"Prusik",         svg:knotSvg("prusik"),  desc:"Nodo autobloccante: scorre se lo spingi, si blocca se lo carichi." },
  { name:"Nodo savoia",    svg:knotSvg("savoia"),  desc:"Ottimo per accorciare una corda o isolare un tratto rovinato." }
];

const VIRTUES = [
  { name:"Coraggio", desc:"Fare la cosa giusta anche quando hai paura." },
  { name:"Aiuto", desc:"Dare una mano senza aspettarsi niente in cambio." },
  { name:"Onest√†", desc:"Dire la verit√† e rispettare la parola data." },
  { name:"Lealt√†", desc:"Essere affidabile con gli altri e con te stesso." },
  { name:"Servizio", desc:"Mettere il bene comune davanti alla comodit√† personale." }
];

/* ============================================================
   EVENT MAP
   ============================================================ */
function birthdaysByKeyForCurrentView(){
  const list = getAllBirthdaysForYear(stateYear);
  const map = new Map();
  list.forEach(e=>{
    const key = e.date;
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(e);
  });
  return map;
}
function markerForDate(key, eventMap){
  const evs = eventMap.get(key);
  if(!evs || !evs.length) return "";
  return evs.slice(0,2).map(x=>x.icon).join("");
}

/* ============================================================
   RENDER DOW
   ============================================================ */
function renderDOW(){
  dowEl.innerHTML = "";
  DOW.forEach(d=>{
    const div = document.createElement("div");
    div.className="dow";
    div.textContent = d;
    dowEl.appendChild(div);
  });
}

/* ============================================================
   CALENDARIO
   ============================================================ */
function makeDayCell(y,m,d,key,isOff,todayKey,eventMap){
  const div = document.createElement("div");
  div.className = "day" + (isOff ? " off" : "") + (key===todayKey ? " today" : "");

  const evs = eventMap.get(key) || [];
  const marker = markerForDate(key, eventMap);
  if(evs.length && !isOff) div.classList.add("eventDay");

  div.dataset.key = key;
  div.innerHTML = `
    <div class="n">${d}</div>
    ${marker && !isOff ? `<div class="marker"><span>${marker}</span><span class="dotRed"></span></div>` : ""}
  `;

  if(evs.length && !isOff){
    div.style.cursor="pointer";
    div.addEventListener("click", ()=>{
      spawnConfettiBurst();
      showToast({
        icon:"üéÇ",
        title:"Compleanno",
        message: evs.map(x=>`${x.name}`).join(", "),
        onClick: ()=> jumpToDate(key)
      });
    });
  }
  return div;
}

function renderCalendar(){
  if(!inRange(stateYear)){ stateYear = YEAR_MIN; stateMonth = 1; }

  monthTitleEl.textContent = itMonth(stateYear, stateMonth);
  yearSel.value = String(stateYear);
  calEl.innerHTML = "";

  const today = new Date();
  const todayKey = ymd(today.getFullYear(), today.getMonth()+1, today.getDate());

  const offset = firstDayOffset(stateYear, stateMonth);
  const dim = daysInMonth(stateYear, stateMonth);

  const prevMonth = stateMonth === 1 ? 12 : stateMonth - 1;
  const prevYear  = stateMonth === 1 ? stateYear - 1 : stateYear;
  const nextMonth = stateMonth === 12 ? 1 : stateMonth + 1;
  const nextYear  = stateMonth === 12 ? stateYear + 1 : stateYear;

  const dimPrev = daysInMonth(prevYear, prevMonth);
  const eventMap = birthdaysByKeyForCurrentView();

  let cells = 0;

  for(let i=0;i<offset;i++){
    const dayNum = dimPrev - offset + 1 + i;
    const key = ymd(prevYear, prevMonth, dayNum);
    calEl.appendChild(makeDayCell(prevYear, prevMonth, dayNum, key, true, todayKey, eventMap));
    cells++;
  }

  for(let d=1; d<=dim; d++){
    const key = ymd(stateYear, stateMonth, d);
    calEl.appendChild(makeDayCell(stateYear, stateMonth, d, key, false, todayKey, eventMap));
    cells++;
  }

  let nextDay = 1;
  while(cells < 42){
    const key = ymd(nextYear, nextMonth, nextDay);
    calEl.appendChild(makeDayCell(nextYear, nextMonth, nextDay, key, true, todayKey, eventMap));
    cells++;
    nextDay++;
  }

  renderMonthEventsList(eventMap);
}

/* ============================================================
   LISTA COMPLEANNI DEL MESE
   ============================================================ */
function renderMonthEventsList(eventMap){
  monthEventsBox.innerHTML = "";
  const dim = daysInMonth(stateYear, stateMonth);

  const items = [];
  for(let d=1; d<=dim; d++){
    const k = ymd(stateYear, stateMonth, d);
    const evs = eventMap.get(k);
    if(evs && evs.length){
      evs.forEach(e=> items.push({key:k, e}));
    }
  }

  if(items.length === 0){
    const line = document.createElement("div");
    line.className="monthEventsLine";
    line.innerHTML = `<div class="monthEventsIco">üåô</div><div class="monthEventsTxt">Nessun compleanno in questo mese</div>`;
    monthEventsBox.appendChild(line);
    return;
  }

  items.forEach(item=>{
    const dt = dateToObj(item.key);
    const label = dt.toLocaleDateString("it-IT",{day:"2-digit", month:"long"});
    const line = document.createElement("div");
    line.className="monthEventsLine";
    line.innerHTML = `
      <div class="monthEventsIco">üéÇ</div>
      <div class="monthEventsTxt">
        <b>${item.e.name}</b>
        <div class="monthEventsSub">üìÖ ${label}</div>
      </div>
    `;
    line.addEventListener("click", ()=> jumpToDate(item.key));
    monthEventsBox.appendChild(line);
  });
}

/* ============================================================
   JUMP
   ============================================================ */
function jumpToDate(isoKey){
  const [y,m] = isoKey.split("-").map(n=>parseInt(n,10));
  if(!inRange(y)) return;
  stateYear = y; stateMonth = m;
  renderCalendar();

  requestAnimationFrame(()=>{
    const cell = calEl.querySelector(`[data-key="${isoKey}"]`);
    if(cell){
      cell.scrollIntoView({behavior:"smooth", block:"center"});
    }
  });
}

/* ============================================================
   COUNTDOWN ENTRO 10 GIORNI
   ============================================================ */
function buildUpcomingBirthdayList(){
  const now = new Date();
  const y = now.getFullYear();
  const all = [...getAllBirthdaysForYear(y), ...getAllBirthdaysForYear(y+1)];

  return all
    .map(e => ({...e, diff: daysBetween(now, e.dateObj)}))
    .filter(e => e.diff >= 0 && e.diff <= 10)
    .sort((a,b)=> a.diff - b.diff);
}

function renderCountdown(){
  countCards.innerHTML = "";
  const list = buildUpcomingBirthdayList();

  if(list.length === 0){
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <div class="kicker">üîî Avvisi</div>
      <p class="big">Nessun compleanno nei prossimi 10 giorni</p>
      <p class="small">Scorri il calendario per vedere tutti i compleanni segnati.</p>
    `;
    countCards.appendChild(card);
    return;
  }

  list.slice(0,10).forEach(e=>{
    const when = e.dateObj.toLocaleDateString("it-IT", {day:"2-digit", month:"long", year:"numeric"});
    const msg = (e.diff===0)
      ? `üéâ √à oggi il compleanno di ${e.name}!`
      : `Tra ${e.diff} giorni √® il compleanno di ${e.name} (${when}).`;

    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <div class="kicker">üéÇ Compleanno</div>
      <p class="big">${msg}</p>
      <p class="small">üìÖ ${when}</p>
      <div class="redNote">üî¥ Segnato sul calendario</div>
    `;
    card.addEventListener("click", ()=> jumpToDate(e.date));
    countCards.appendChild(card);
  });
}

/* ============================================================
   TOAST
   ============================================================ */
function showToast({ icon="üéÇ", title="Avviso", message="", onClick=null }){
  const t = document.createElement("div");
  t.className = "toast";
  t.innerHTML = `
    <div class="tIco">${icon}</div>
    <div class="tTxt">
      <b>${title}</b>
      <small>${message}</small>
    </div>
    <button class="tClose" type="button">‚úñ</button>
  `;
  t.querySelector(".tClose").addEventListener("click", ()=> t.remove());

  if(onClick){
    t.style.cursor = "pointer";
    t.addEventListener("click", (e)=>{
      if(e.target && e.target.classList.contains("tClose")) return;
      onClick();
      t.remove();
    });
  }

  toastWrap.prepend(t);
  setTimeout(()=>{ if(t.isConnected) t.remove(); }, 12000);
}

/* ============================================================
   NOTIFICHE 9:00 (solo toast + push se disponibile)
   ============================================================ */
const NOTIF_KEY = "birthday_notifs_9am_v1";
const ALERT_DAYS = new Set([10,5,0]);

function loadNotifState(){
  try{ return JSON.parse(localStorage.getItem(NOTIF_KEY) || "{}"); }
  catch{ return {}; }
}
function saveNotifState(state){
  localStorage.setItem(NOTIF_KEY, JSON.stringify(state));
}
function todayIso(){
  const now = new Date();
  return ymd(now.getFullYear(), now.getMonth()+1, now.getDate());
}
function isAroundNineAM(now){
  const h = now.getHours();
  const min = now.getMinutes();
  return (h === 9 && min <= 15);
}

function checkBirthdayAlertsAt9(){
  const now = new Date();
  if(!isAroundNineAM(now)) return;

  const state = loadNotifState();
  const today = todayIso();

  const y = now.getFullYear();
  const all = [...getAllBirthdaysForYear(y), ...getAllBirthdaysForYear(y+1)];
  const list = all
    .map(e => ({...e, diff: daysBetween(now, e.dateObj)}))
    .filter(e => e.diff >= 0 && e.diff <= 10)
    .filter(e => ALERT_DAYS.has(e.diff));

  list.forEach(e=>{
    const dedupeKey = `${e.id}_${e.diff}_${today}`;
    if(state[dedupeKey]) return;

    const when = e.dateObj.toLocaleDateString("it-IT", {day:"2-digit", month:"long", year:"numeric"});
    let title = "üéÇ Compleanno in arrivo";
    let msg = `Tra ${e.diff} giorni √® il compleanno di ${e.name} (${when}).`;

    if(e.diff === 10) msg = `‚è≥ Tra meno di 10 giorni √® il compleanno di ${e.name} (${when}).`;
    if(e.diff === 5)  msg = `‚ö†Ô∏è Tra 5 giorni √® il compleanno di ${e.name} (${when}).`;
    if(e.diff === 0){ title = "üéâ √à oggi!"; msg = `Auguri ${e.name}! (${when})`; }

    showToast({ icon:"üéÇ", title, message: msg, onClick: ()=> jumpToDate(e.date) });
    pushWebNotification(title, msg);

    state[dedupeKey] = true;
  });

  saveNotifState(state);
}

/* ============================================================
   NODO + BUSSOLA DEL GIORNO
   ============================================================ */
function setKnotOfDay(){
  const now = new Date();
  const seed = (now.getFullYear()*10000) + ((now.getMonth()+1)*100) + now.getDate();
  const idx = seed % KNOTS.length;
  const k = KNOTS[idx];
  knotName.textContent = k.name;
  knotDesc.textContent = k.desc;
  knotImg.innerHTML = k.svg;
}

function setVirtueOfDay(){
  const now = new Date();
  const seed = (now.getFullYear()*10000) + ((now.getMonth()+1)*100) + now.getDate();
  const idx = seed % VIRTUES.length;
  const v = VIRTUES[idx];

  virtueName.textContent = `Virt√π del giorno: ${v.name}`;
  virtueDesc.textContent = v.desc;

  const angle = idx * 72;
  needle.style.transform = `translateX(-50%) rotate(${angle}deg)`;
}

/* ============================================================
   ACCORDION
   ============================================================ */
document.querySelectorAll(".accBtn[data-acc]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const id = btn.getAttribute("data-acc");
    const item = document.getElementById(id);
    item.classList.toggle("open");
  });
});

/* ============================================================
   NAV
   ============================================================ */
document.getElementById("prev").addEventListener("click", ()=>{
  stateMonth--;
  if(stateMonth<1){ stateMonth=12; stateYear--; }
  if(!inRange(stateYear)){ stateYear=YEAR_MIN; stateMonth=1; }
  renderCalendar();
});
document.getElementById("next").addEventListener("click", ()=>{
  stateMonth++;
  if(stateMonth>12){ stateMonth=1; stateYear++; }
  if(!inRange(stateYear)){ stateYear=YEAR_MAX; stateMonth=12; }
  renderCalendar();
});
yearSel.addEventListener("change", ()=>{
  stateYear = parseInt(yearSel.value,10);
  renderCalendar();
});
document.getElementById("todayBtn").addEventListener("click", ()=>{
  const t = new Date();
  if(t.getFullYear()<YEAR_MIN || t.getFullYear()>YEAR_MAX){
    stateYear=YEAR_MIN; stateMonth=1;
  } else {
    stateYear=t.getFullYear(); stateMonth=t.getMonth()+1;
  }
  renderCalendar();
});

/* ============================================================
   CONFETTI
   ============================================================ */
function spawnConfettiBurst(){
  const n = 24;
  const colors = [
    "rgba(255,210,77,.92)",
    "rgba(124,255,138,.85)",
    "rgba(255,255,255,.85)",
    "rgba(255,63,63,.80)"
  ];
  for(let i=0;i<n;i++){
    const c = document.createElement("div");
    c.className = "conf";
    c.style.left = (10 + Math.random()*80) + "vw";
    c.style.background = colors[i % colors.length];
    c.style.setProperty("--t", (1.8 + Math.random()*1.2) + "s");
    c.style.setProperty("--dx", ((Math.random()*360)-180) + "px");
    confettiBox.appendChild(c);
    setTimeout(()=>{ if(c.isConnected) c.remove(); }, 3200);
  }
}

/* ============================================================
   AVVIO SICURO + ENTRA CHE NON SI BLOCCA MAI
   ============================================================ */
window.addEventListener("DOMContentLoaded", () => {
  // init base
  renderDOW();
  renderCalendar();
  renderCountdown();
  setKnotOfDay();
  setVirtueOfDay();

  // click ENTRA (sempre)
  enterBtn.addEventListener("click", async () => {
    // chiudi sempre l‚Äôintro
    intro.classList.add("hide");
    app.style.opacity = "1";
    app.style.transform = "translateY(0)";

    // prova notifiche (se fallisce non importa)
    try{
      await ensureNotificationPermission();
      checkBirthdayAlertsAt9();
    }catch(e){
      console.warn("Errore ENTRA:", e);
    }
  });

  // refresh 1/min
  setInterval(()=>{
    renderCountdown();
    setKnotOfDay();
    setVirtueOfDay();
    checkBirthdayAlertsAt9();
  }, 60000);

  // controllo all'avvio
  checkBirthdayAlertsAt9();
});
</script>
</body>
</html>
