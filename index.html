<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Calendario Compleanni Scout (2026‚Äì2029)</title>

<style>
  :root{
    --text:#eef7ef;
    --muted: rgba(238,247,239,.75);

    --panel: rgba(255,255,255,.10);
    --panel2: rgba(255,255,255,.16);
    --shadow: 0 18px 55px rgba(0,0,0,.55);
    --radius: 18px;

    /* ‚úÖ SFONDO (metti qui il tuo file) */
    --bgUrl: url("ChatGPT Image 19 gen 2026, 21_00_05.png");

    /* Animazioni ‚Äúglobali‚Äù */
    --wind: 0;           /* 0..1 */
    --glow: 1;           /* 0.9..1.2 */
    --hue: 0deg;         /* rotazione colori */
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    min-height:100vh;
    color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    overflow-x:hidden;

    background:#06150c;
    background-image: var(--bgUrl);
    background-size: cover;
    background-position:center;
    background-repeat:no-repeat;
  }

  /* =========================
     SFONDO ‚ÄúVIVO‚Äù
  ========================= */
  .bg{
    position:fixed; inset:0;
    background-image: var(--bgUrl);
    background-size: cover;
    background-position:center;
    transform: scale(1.06);
    z-index:-10;
    will-change: transform, filter;
    animation: bgFloat 14s ease-in-out infinite alternate;
    filter: saturate(1.08) contrast(1.05) hue-rotate(var(--hue));
  }
  @keyframes bgFloat{
    from{ transform: scale(1.06) translate3d(0,0,0); }
    to  { transform: scale(1.11) translate3d(6px,-14px,0); }
  }

  .overlay{
    position:fixed; inset:0;
    z-index:-9;
    background:
      radial-gradient(1200px 900px at 15% 10%, rgba(124,255,138,.18), transparent 60%),
      radial-gradient(900px 700px at 90% 15%, rgba(255,210,77,.16), transparent 62%),
      radial-gradient(1000px 800px at 60% 90%, rgba(114,195,255,.10), transparent 62%),
      linear-gradient(160deg, rgba(0,0,0,.66), rgba(0,0,0,.30));
    animation: overlayBreath 9s ease-in-out infinite;
  }
  @keyframes overlayBreath{ 0%,100%{ opacity:1; } 50%{ opacity:.93; } }

  /* Nebbia/vento che reagisce allo scroll */
  .fog{
    position:fixed; inset:-140px;
    pointer-events:none;
    z-index:-8;
    background:
      radial-gradient(820px 520px at 30% 30%, rgba(255,255,255,.11), transparent 72%),
      radial-gradient(920px 620px at 75% 45%, rgba(255,255,255,.09), transparent 74%),
      radial-gradient(740px 520px at 40% 85%, rgba(255,255,255,.07), transparent 72%);
    filter: blur(22px);
    opacity: calc(0.40 + (var(--wind) * 0.35));
    transform: translate3d(calc(var(--wind) * 26px), calc(var(--wind) * -12px), 0)
              scale(calc(1.02 + var(--wind) * 0.05));
    transition: opacity .35s ease, transform .35s ease;
    animation: fogDrift 10s ease-in-out infinite alternate;
  }
  @keyframes fogDrift{ from{ filter: blur(20px);} to{ filter: blur(26px);} }

  /* Lucciole */
  .fireflies{ position:fixed; inset:0; pointer-events:none; z-index:-2; }
  .firefly{
    position:absolute; width:6px; height:6px; border-radius:50%;
    background: rgba(255,210,77,.95);
    box-shadow: 0 0 20px rgba(255,210,77,.85);
    opacity:0;
    animation: fly var(--t) linear infinite;
    filter: brightness(calc(1 + (var(--glow) - 1)));
  }
  @keyframes fly{
    0%{ transform: translate(0,0) scale(.85); opacity:0; }
    12%{ opacity:.95; }
    55%{ opacity:.35; }
    100%{ transform: translate(calc(var(--dx) + var(--wind) * 90px), var(--dy)) scale(1.25); opacity:0; }
  }

  /* Foglie */
  .leaves{ position:fixed; inset:0; pointer-events:none; z-index:-2; overflow:hidden; }
  .leaf{
    position:absolute; top:-90px;
    width:30px; height:30px;
    border-radius: 7px 20px 7px 20px;
    background: radial-gradient(circle at 30% 30%, rgba(255,210,77,.9), rgba(18,58,32,.22));
    box-shadow: 0 10px 22px rgba(0,0,0,.18);
    opacity:0;
    animation: leafDown var(--t) linear infinite, leafSpin calc(var(--t) * .75) ease-in-out infinite;
  }
  @keyframes leafDown{
    0%{ transform: translate3d(0,-70px,0); opacity:0; }
    8%{ opacity:.85; }
    55%{ opacity:.50; }
    100%{
      transform: translate3d(calc(var(--dx) + var(--wind) * 160px), 110vh, 0);
      opacity:0;
    }
  }
  @keyframes leafSpin{ 0%{ rotate:0deg; } 50%{ rotate:160deg; } 100%{ rotate:320deg; } }

  /* Scintille leggere */
  .sparks{ position:fixed; inset:0; pointer-events:none; z-index:-2; }
  .spark{
    position:absolute; width:3px; height:3px; border-radius:50%;
    background: rgba(255,255,255,.86);
    box-shadow: 0 0 18px rgba(255,255,255,.30);
    opacity:0;
    animation: sparkFloat var(--t) ease-in-out infinite;
  }
  @keyframes sparkFloat{
    0%{ transform: translate3d(0,22px,0) scale(.8); opacity:0; }
    18%{ opacity:.55; }
    65%{ opacity:.22; }
    100%{ transform: translate3d(calc(var(--dx) + var(--wind) * 70px), calc(-170px - var(--dy)), 0) scale(1.2); opacity:0; }
  }

  /* =========================
     INTRO
  ========================= */
  .intro{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background: rgba(0,0,0,.62);
    backdrop-filter: blur(10px);
    z-index:50;
    transition: opacity .6s ease, transform .6s ease;
  }
  .intro.hide{ opacity:0; pointer-events:none; transform: scale(1.02); }

  .introRing{
    position:absolute;
    width:290px; height:290px;
    border-radius:50%;
    border:1px solid rgba(255,255,255,.22);
    box-shadow: 0 0 70px rgba(255,255,255,.12);
    animation: ring 3.0s ease-in-out infinite;
  }
  .introRing::after{
    content:"";
    position:absolute; inset:-18px;
    border-radius:50%;
    border:1px dashed rgba(255,210,77,.22);
    animation: ring2 6.4s linear infinite;
  }
  @keyframes ring{ 0%,100%{ transform: scale(1); opacity:.65; } 50%{ transform: scale(1.07); opacity:.95; } }
  @keyframes ring2{ to{ transform: rotate(360deg); } }

  .enterBtn{
    position:relative;
    padding: 22px 48px;
    font-size: 26px;
    font-weight: 1000;
    letter-spacing: .06em;
    border-radius: 999px;
    border: 2px solid rgba(255,255,255,.50);
    background: rgba(0,0,0,.30);
    color: var(--text);
    cursor:pointer;
    box-shadow: 0 24px 70px rgba(0,0,0,.55), 0 0 46px rgba(255,255,255,.18);
    overflow:hidden;
    animation: pulse 2.1s ease-in-out infinite;
    transform-origin: 50% 60%;
  }
  .enterBtn::before{
    content:"";
    position:absolute; inset:-80px;
    background: radial-gradient(360px 260px at 30% 30%, rgba(255,255,255,.15), transparent 62%);
    transform: translateX(-45%);
    animation: shimmer 2.5s ease-in-out infinite;
  }
  .enterBtn::after{
    content:"";
    position:absolute; inset:0;
    background: radial-gradient(240px 140px at 50% 50%, rgba(124,255,138,.16), transparent 70%);
    opacity:.55;
    animation: btnGlow 2.8s ease-in-out infinite;
    pointer-events:none;
  }
  @keyframes shimmer{ 0%,100%{ opacity:.22; transform: translateX(-45%);} 50%{ opacity:.55; transform: translateX(45%);} }
  @keyframes pulse{ 0%,100%{ transform: translateY(0) scale(1); } 50%{ transform: translateY(-2px) scale(1.01); } }
  @keyframes btnGlow{ 0%,100%{ filter: blur(0px); } 50%{ filter: blur(1px); } }

  /* =========================
     LAYOUT
  ========================= */
  .wrap{
    position:relative; z-index:2;
    max-width:1080px;
    margin:22px auto 46px;
    padding:14px;
    opacity:0;
    transform: translateY(10px);
    transition: opacity .55s ease, transform .55s ease;
  }
  .topbar{
    display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    padding:14px;
    background:var(--panel);
    border:1px solid var(--panel2);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    backdrop-filter: blur(12px);
    animation: floatPanel 7s ease-in-out infinite;
  }
  @keyframes floatPanel{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-2px); } }

  .title{ display:flex; gap:10px; align-items:center; font-weight:1000; }
  .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  button, select{
    border:1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.22);
    color: var(--text);
    padding:10px 12px;
    border-radius:14px;
    cursor:pointer;
    outline:none;
    font-family:inherit;
    transition: transform .18s ease, filter .18s ease, box-shadow .18s ease;
  }
  button:hover, select:hover{
    transform: translateY(-1px) scale(1.01);
    filter: brightness(1.10);
    box-shadow: 0 16px 32px rgba(0,0,0,.22);
  }
  button:active{ transform: translateY(0) scale(.99); }

  .monthTitle{ font-size:18px; font-weight:1000; text-transform:capitalize; }
  .muted{ color: var(--muted); font-size:13px; }

  .stage{
    margin-top:14px;
    position:relative;
    border-radius:22px;
    overflow:hidden;
    box-shadow:var(--shadow);
    border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    backdrop-filter: blur(12px);
  }

  /* Cornice animata (leggera) */
  .frame{
    position:absolute; inset:0;
    pointer-events:none;
    z-index:1;
    opacity:.86;
    background:
      radial-gradient(600px 280px at 10% 20%, rgba(255,210,77,.10), transparent 60%),
      radial-gradient(700px 320px at 90% 20%, rgba(124,255,138,.12), transparent 60%),
      linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
    animation: frameShift 10s ease-in-out infinite alternate;
  }
  @keyframes frameShift{
    from{ filter: blur(0px); transform: translateY(0); }
    to{ filter: blur(.2px); transform: translateY(-6px); }
  }

  .content{ position:relative; z-index:2; padding:28px 22px 18px; }

  .grid{ display:grid; grid-template-columns:repeat(7, 1fr); gap:10px; }

  .dow{
    text-align:center;
    font-weight:1000;
    font-size:13px;
    color: rgba(0,0,0,.82);
    background: rgba(255,255,255,.86);
    border-radius:12px;
    padding:10px 6px;
    border:1px solid rgba(0,0,0,.08);
    animation: popIn .55s ease both;
  }
  @keyframes popIn{ from{ transform: translateY(6px); opacity:0; } to{ transform: translateY(0); opacity:1; } }

  .day{
    border-radius:16px;
    padding:10px;
    background: rgba(255,255,255,.92);
    border:1px solid rgba(0,0,0,.08);
    color: rgba(0,0,0,.88);
    position:relative;
    overflow:hidden;
    display:flex;
    align-items:flex-start;
    justify-content:flex-start;
    transition: transform .18s ease, filter .18s ease, box-shadow .18s ease;
    isolation:isolate;
  }
  .day:hover{
    transform: translateY(-2px) scale(1.01);
    filter: brightness(1.03);
    box-shadow: 0 16px 30px rgba(0,0,0,.18);
  }
  .day .n{ font-weight:1000; font-size:16px; }
  .off{ opacity:.55; }

  /* Oggi */
  .today{
    outline: 3px solid rgba(124,255,138,.75);
    outline-offset:-3px;
    animation: todayGlow 2.2s ease-in-out infinite;
  }
  @keyframes todayGlow{
    0%,100%{ box-shadow: 0 0 0 rgba(124,255,138,0); }
    50%{ box-shadow: 0 0 28px rgba(124,255,138,.35); }
  }

  /* Giorno compleanno: aura + shimmer */
  .bday::before{
    content:"";
    position:absolute; inset:-50px;
    z-index:-1;
    background:
      radial-gradient(240px 180px at 25% 25%, rgba(255,63,63,.14), transparent 62%),
      radial-gradient(260px 200px at 80% 40%, rgba(255,210,77,.18), transparent 62%),
      radial-gradient(300px 220px at 40% 85%, rgba(124,255,138,.14), transparent 62%);
    filter: blur(12px);
    opacity:.95;
    animation: aura 3.2s ease-in-out infinite;
  }
  @keyframes aura{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-7px); } }

  .bday::after{
    content:"";
    position:absolute; inset:-40px;
    z-index:-1;
    background: linear-gradient(120deg, rgba(255,255,255,.0), rgba(255,255,255,.20), rgba(255,255,255,.0));
    transform: translateX(-60%) rotate(12deg);
    animation: shine 2.8s ease-in-out infinite;
    opacity:.55;
  }
  @keyframes shine{
    0%,100%{ transform: translateX(-60%) rotate(12deg); opacity:.25; }
    50%{ transform: translateX(60%) rotate(12deg); opacity:.55; }
  }

  /* Marker icone */
  .marker{
    position:absolute; right:8px; bottom:8px;
    font-size:14px;
    display:flex; align-items:center; gap:6px;
    padding: 4px 7px;
    border-radius: 999px;
    background: rgba(0,0,0,.10);
    border: 1px solid rgba(0,0,0,.08);
    transform-origin: 50% 70%;
    animation: markerBounce 1.8s ease-in-out infinite;
  }
  @keyframes markerBounce{
    0%,100%{ transform: translateY(0) rotate(0deg); }
    50%{ transform: translateY(-2px) rotate(-2deg); }
  }
  .dot{
    width:7px; height:7px; border-radius:50%;
    background: rgba(255,63,63,.95);
    box-shadow: 0 0 16px rgba(255,63,63,.45);
  }

  /* Flash click */
  .jumpFlash{ animation: jumpFlash 1.6s ease-in-out 0s 2; }
  @keyframes jumpFlash{
    0%{ transform: scale(1); }
    50%{ transform: scale(1.03); filter: brightness(1.14); box-shadow: 0 0 44px rgba(255,63,63,.45); }
    100%{ transform: scale(1); }
  }

  /* Lista compleanni del mese */
  .monthEvents{
    margin-top: 10px;
    padding: 10px 12px;
    border-radius: 16px;
    background: rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.14);
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .monthEventsLine{
    display:flex; gap:10px; align-items:flex-start;
    padding:9px 10px;
    border-radius:14px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    transition: transform .18s ease, filter .18s ease;
    cursor:pointer;
    position:relative;
    overflow:hidden;
  }
  .monthEventsLine::after{
    content:"";
    position:absolute; inset:-40px;
    background: radial-gradient(300px 220px at 20% 30%, rgba(255,255,255,.10), transparent 60%);
    opacity:0;
    transition: opacity .22s ease;
  }
  .monthEventsLine:hover{ transform: translateY(-1px); filter: brightness(1.08); }
  .monthEventsLine:hover::after{ opacity:.70; }
  .monthEventsIco{ font-size:18px; line-height:1; }
  .monthEventsTxt{ font-size:13px; color: rgba(238,247,239,.90); }
  .monthEventsSub{ font-size:12px; color: var(--muted); margin-top:2px; }

  /* Modal */
  .modalBackdrop{
    position:fixed; inset:0;
    background: rgba(0,0,0,.62);
    display:none;
    align-items:center; justify-content:center;
    padding: 18px;
    z-index:99;
  }
  .modalBackdrop.show{ display:flex; }

  .modal{
    width:min(700px, 96vw);
    background: rgba(14,44,25,.92);
    border:1px solid rgba(255,255,255,.14);
    border-radius: 22px;
    box-shadow: var(--shadow);
    padding: 16px;
    overflow:hidden;
    transform: translateY(18px) scale(.96);
    opacity:0;
    animation: pop .32s ease forwards;
  }
  @keyframes pop{ to{ transform: translateY(0) scale(1); opacity:1; } }

  .modalHeader{
    display:flex; justify-content:space-between; gap:12px; align-items:flex-start;
    padding:6px 6px 10px;
  }
  .modalTitle{ font-weight:1000; font-size:18px; margin:0; }
  .modalBody{
    background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12);
    border-radius: 18px;
    padding: 12px;
    margin: 6px;
  }
  .line{
    display:flex; gap:10px; align-items:flex-start;
    padding:10px;
    border-radius:14px;
    background: rgba(0,0,0,.20);
    border:1px solid rgba(255,255,255,.10);
    margin-bottom: 10px;
    animation: slideIn .35s ease both;
  }
  @keyframes slideIn{ from{ transform: translateX(-12px); opacity:0; } to{ transform: translateX(0); opacity:1; } }
  .ico{ font-size: 22px; line-height:1; }
  .sub{ color: rgba(238,247,239,.86); font-size: 13px; margin:2px 0 0; }

  /* Confetti (canvas) */
  canvas#confetti{
    position:fixed; inset:0;
    pointer-events:none;
    z-index:120;
  }

  @media (max-width: 780px){
    .content{ padding: 18px 14px 14px; }
    .grid{ gap:8px; }
    .day{ aspect-ratio: 1/1; padding:8px; }
    .day .n{ font-size:14px; }
    .monthTitle{ font-size:16px; }
  }
</style>
</head>

<body>
  <div class="bg"></div>
  <div class="overlay"></div>
  <div class="fog" id="fog"></div>
  <div class="leaves" id="leaves"></div>
  <div class="fireflies" id="fireflies"></div>
  <div class="sparks" id="sparks"></div>
  <canvas id="confetti"></canvas>

  <!-- INTRO -->
  <div class="intro" id="intro">
    <div class="introRing"></div>
    <button class="enterBtn" id="enterBtn">ENTRA</button>
  </div>

  <div class="wrap" id="app">
    <div class="topbar">
      <div class="title">
        <div style="font-size:22px;">üéÇ</div>
        <div>
          <div style="font-size:16px;font-weight:1000;">Calendario Compleanni Scout</div>
          <div class="muted">2026 ‚Üí 2029 (solo compleanni)</div>
        </div>
      </div>

      <div class="controls">
        <button id="prev">‚¨ÖÔ∏è</button>
        <div class="monthTitle" id="monthTitle">‚Äî</div>
        <button id="next">‚û°Ô∏è</button>

        <select id="yearSel">
          <option>2026</option>
          <option>2027</option>
          <option>2028</option>
          <option>2029</option>
        </select>

        <button id="todayBtn">Oggi</button>
      </div>
    </div>

    <div class="stage" id="stage">
      <div class="frame"></div>
      <div class="content">
        <div class="grid" id="dow"></div>
        <div style="height:10px"></div>
        <div class="grid" id="cal"></div>
        <div class="monthEvents" id="monthEvents"></div>
      </div>
    </div>
  </div>

  <!-- MODAL COMPLEANNO -->
  <div class="modalBackdrop" id="bdayBackdrop" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <h3 class="modalTitle" id="bdayTitle">üéÇ Compleanno</h3>
        <button id="bdayClose">Chiudi ‚úñ</button>
      </div>
      <div class="modalBody" id="bdayBody"></div>
    </div>
  </div>

<script>
  // =========================
  // UTIL
  // =========================
  const pad = n => String(n).padStart(2,"0");
  const ymd = (y,m,d) => `${y}-${pad(m)}-${pad(d)}`;
  const itMonth = (y,m) => new Date(y, m-1, 1).toLocaleString("it-IT",{month:"long", year:"numeric"});
  const dateToObj = (iso) => {
    const [Y,M,D] = iso.split("-").map(x=>parseInt(x,10));
    return new Date(Y, M-1, D);
  };
  const DOW = ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];
  const YEAR_MIN = 2026, YEAR_MAX = 2029;
  const inRange = y => (y>=YEAR_MIN && y<=YEAR_MAX);

  function firstDayOffset(y,m){
    const js = new Date(y, m-1, 1).getDay(); // 0 dom..6 sab
    return (js + 6) % 7; // lun=0..dom=6
  }
  function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); }

  // =========================
  // DOM
  // =========================
  const intro = document.getElementById("intro");
  const enterBtn = document.getElementById("enterBtn");
  const app = document.getElementById("app");

  const dowEl = document.getElementById("dow");
  const calEl = document.getElementById("cal");
  const monthTitleEl = document.getElementById("monthTitle");
  const yearSel = document.getElementById("yearSel");
  const monthEventsBox = document.getElementById("monthEvents");

  const stage = document.getElementById("stage");

  // Modal
  const bdayBackdrop = document.getElementById("bdayBackdrop");
  const bdayClose = document.getElementById("bdayClose");
  const bdayTitle = document.getElementById("bdayTitle");
  const bdayBody  = document.getElementById("bdayBody");

  // =========================
  // STATO CALENDARIO
  // =========================
  let stateYear = 2026;
  let stateMonth = 1;

  // =========================
  // ‚úÖ SOLO COMPLEANNI
  // (anni ignorati: ricorrenza ogni anno)
  // =========================
  const BIRTHDAYS = [
    { id:"mariateresa", month:1,  day:7,  icon:"üéÇ", name:"Mariateresa" },
    { id:"cristian",    month:1,  day:28, icon:"üéÇ", name:"Cristian" },

    { id:"ambra",       month:2,  day:28, icon:"üéÇ", name:"Ambra" },

    { id:"arta",        month:3,  day:22, icon:"üéÇ", name:"Arta" },
    { id:"ginevra",     month:3,  day:22, icon:"üéÇ", name:"Ginevra Di Buono" },
    { id:"greta",       month:3,  day:28, icon:"üéÇ", name:"Greta Iorio" },

    { id:"eliana",      month:4,  day:30, icon:"üéÇ", name:"Eliana Alfieri" },

    { id:"rudi",        month:5,  day:11, icon:"üéÇ", name:"Rudi" },

    { id:"lorenzo",     month:6,  day:18, icon:"üéÇ", name:"Lorenzo" },
    { id:"paolo",       month:6,  day:20, icon:"üéÇ", name:"Paolo Iannetta" },

    { id:"loris",       month:7,  day:16, icon:"üéÇ", name:"Loris" },

    { id:"giuseppe",    month:11, day:18, icon:"üéÇ", name:"Giuseppe" },

    { id:"chiara",      month:12, day:22, icon:"üéÇ", name:"Chiara" },
  ];

  function getBirthdaysForYear(year){
    // espansione: stesso compleanno ogni anno
    return BIRTHDAYS.map(b => ({
      ...b,
      date: ymd(year, b.month, b.day),
      dateObj: new Date(year, b.month-1, b.day),
      kind: "birthday"
    }));
  }

  function eventsByKeyForCurrentView(){
    const list = getBirthdaysForYear(stateYear);
    const map = new Map();
    list.forEach(e=>{
      const key = e.date;
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(e);
    });
    return map;
  }

  function markerForDate(key, eventMap){
    const evs = eventMap.get(key);
    if(!evs || !evs.length) return "";
    // se pi√π compleanni lo stesso giorno: mostra ‚ÄúüéÇx2‚Äù
    if(evs.length > 1) return `üéÇ√ó${evs.length}`;
    return evs[0].icon;
  }

  // =========================
  // RENDER DOW
  // =========================
  function renderDOW(){
    dowEl.innerHTML = "";
    DOW.forEach(d=>{
      const div = document.createElement("div");
      div.className="dow";
      div.textContent = d;
      dowEl.appendChild(div);
    });
  }

  // =========================
  // RENDER CALENDARIO
  // =========================
  function renderCalendar(){
    if(!inRange(stateYear)){ stateYear=YEAR_MIN; stateMonth=1; }

    monthTitleEl.textContent = itMonth(stateYear, stateMonth);
    yearSel.value = String(stateYear);
    calEl.innerHTML = "";

    const today = new Date();
    const todayKey = ymd(today.getFullYear(), today.getMonth()+1, today.getDate());

    const offset = firstDayOffset(stateYear, stateMonth);
    const dim = daysInMonth(stateYear, stateMonth);

    const prevMonth = stateMonth === 1 ? 12 : stateMonth - 1;
    const prevYear  = stateMonth === 1 ? stateYear - 1 : stateYear;
    const nextMonth = stateMonth === 12 ? 1 : stateMonth + 1;
    const nextYear  = stateMonth === 12 ? stateYear + 1 : stateYear;

    const dimPrev = daysInMonth(prevYear, prevMonth);
    const eventMap = eventsByKeyForCurrentView();

    let cells = 0;

    // celle ‚Äúfuori mese‚Äù
    for(let i=0;i<offset;i++){
      const dayNum = dimPrev - offset + 1 + i;
      const key = ymd(prevYear, prevMonth, dayNum);
      calEl.appendChild(makeDayCell(prevYear, prevMonth, dayNum, key, true, todayKey, eventMap));
      cells++;
    }

    // mese corrente
    for(let d=1; d<=dim; d++){
      const key = ymd(stateYear, stateMonth, d);
      calEl.appendChild(makeDayCell(stateYear, stateMonth, d, key, false, todayKey, eventMap));
      cells++;
    }

    // riempi fino a 42 celle
    let nextDay = 1;
    while(cells < 42){
      const key = ymd(nextYear, nextMonth, nextDay);
      calEl.appendChild(makeDayCell(nextYear, nextMonth, nextDay, key, true, todayKey, eventMap));
      cells++;
      nextDay++;
    }

    renderMonthBirthdaysList(eventMap);
  }

  function makeDayCell(y,m,d,key,isOff,todayKey,eventMap){
    const div = document.createElement("div");
    div.className = "day" + (isOff ? " off" : "") + (key===todayKey ? " today" : "");

    const evs = eventMap.get(key) || [];
    const marker = markerForDate(key, eventMap);

    if(evs.length && !isOff) div.classList.add("bday");

    div.dataset.key = key;
    div.innerHTML = `
      <div class="n">${d}</div>
      ${marker && !isOff ? `<div class="marker"><span>${marker}</span><span class="dot"></span></div>` : ""}
    `;

    if(evs.length && !isOff){
      div.style.cursor = "pointer";
      div.addEventListener("click", ()=>{
        // animazione flash
        div.classList.remove("jumpFlash");
        void div.offsetWidth;
        div.classList.add("jumpFlash");

        // confetti + modal
        burstConfettiFromElement(div);
        openBirthdayModal(key, evs);
      });
    }
    return div;
  }

  // =========================
  // LISTA COMPLEANNI DEL MESE
  // =========================
  function renderMonthBirthdaysList(eventMap){
    monthEventsBox.innerHTML = "";

    const dim = daysInMonth(stateYear, stateMonth);
    const keys = [];
    for(let d=1; d<=dim; d++) keys.push(ymd(stateYear, stateMonth, d));

    const items = [];
    keys.forEach(k=>{
      const evs = eventMap.get(k);
      if(evs && evs.length){
        evs.forEach(e => items.push({ key:k, e }));
      }
    });

    if(items.length === 0){
      const line = document.createElement("div");
      line.className="monthEventsLine";
      line.innerHTML = `<div class="monthEventsIco">üåô</div><div class="monthEventsTxt">Nessun compleanno in questo mese</div>`;
      monthEventsBox.appendChild(line);
      return;
    }

    items.forEach(item=>{
      const dt = dateToObj(item.key);
      const label = dt.toLocaleDateString("it-IT",{day:"2-digit", month:"long"});
      const line = document.createElement("div");
      line.className="monthEventsLine";
      line.innerHTML = `
        <div class="monthEventsIco">üéÇ</div>
        <div class="monthEventsTxt">
          <b>${item.e.name}</b>
          <div class="monthEventsSub">üìÖ ${label}</div>
        </div>
      `;
      line.addEventListener("click", ()=> jumpToDate(item.key));
      monthEventsBox.appendChild(line);
    });
  }

  // =========================
  // JUMP
  // =========================
  function jumpToDate(isoKey){
    const [y,m,d] = isoKey.split("-").map(n=>parseInt(n,10));
    if(!inRange(y)) return;
    stateYear = y; stateMonth = m;
    renderCalendar();

    requestAnimationFrame(()=>{
      const cell = calEl.querySelector(`[data-key="${isoKey}"]`);
      if(cell){
        cell.scrollIntoView({behavior:"smooth", block:"center"});
        cell.classList.remove("jumpFlash");
        void cell.offsetWidth;
        cell.classList.add("jumpFlash");
      }
    });
  }

  // =========================
  // MODAL COMPLEANNI
  // =========================
  function openBirthdayModal(key, evs){
    const dt = dateToObj(key);
    const label = dt.toLocaleDateString("it-IT",{weekday:"long", day:"2-digit", month:"long", year:"numeric"});
    bdayTitle.textContent = "üéÇ Compleanno";

    const lines = evs.map(e => `
      <div class="line">
        <div class="ico">üéâ</div>
        <div>
          <b>${e.name}</b>
          <div class="sub">üìÖ ${label}</div>
        </div>
      </div>
    `).join("");

    bdayBody.innerHTML = lines + `
      <div class="line">
        <div class="ico">‚ú®</div>
        <div>
          <b>Tip scout:</b>
          <div class="sub">Scrivi un messaggio semplice e sincero. Vale pi√π di mille effetti speciali üòâ</div>
        </div>
      </div>
    `;

    bdayBackdrop.classList.add("show");
    bdayBackdrop.setAttribute("aria-hidden","false");
  }
  function closeBirthdayModal(){
    bdayBackdrop.classList.remove("show");
    bdayBackdrop.setAttribute("aria-hidden","true");
  }
  bdayClose.addEventListener("click", closeBirthdayModal);
  bdayBackdrop.addEventListener("click",(e)=>{ if(e.target===bdayBackdrop) closeBirthdayModal(); });
  window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeBirthdayModal(); });

  // =========================
  // NAV CALENDARIO
  // =========================
  document.getElementById("prev").addEventListener("click", ()=>{
    stateMonth--;
    if(stateMonth<1){ stateMonth=12; stateYear--; }
    if(!inRange(stateYear)){ stateYear=YEAR_MIN; stateMonth=1; }
    renderCalendar();
  });
  document.getElementById("next").addEventListener("click", ()=>{
    stateMonth++;
    if(stateMonth>12){ stateMonth=1; stateYear++; }
    if(!inRange(stateYear)){ stateYear=YEAR_MAX; stateMonth=12; }
    renderCalendar();
  });
  yearSel.addEventListener("change", ()=>{
    stateYear = parseInt(yearSel.value,10);
    renderCalendar();
  });
  document.getElementById("todayBtn").addEventListener("click", ()=>{
    const t = new Date();
    if(t.getFullYear()<YEAR_MIN || t.getFullYear()>YEAR_MAX){ stateYear=YEAR_MIN; stateMonth=1; }
    else { stateYear=t.getFullYear(); stateMonth=t.getMonth()+1; }
    renderCalendar();
  });

  // Swipe mese su mobile (sul calendario)
  let touchStartX = null;
  stage.addEventListener("touchstart",(e)=>{ touchStartX = e.touches[0].clientX; }, {passive:true});
  stage.addEventListener("touchend",(e)=>{
    if(touchStartX===null) return;
    const endX = e.changedTouches[0].clientX;
    const dx = endX - touchStartX;
    touchStartX = null;
    if(Math.abs(dx) < 40) return;
    if(dx < 0) document.getElementById("next").click();
    else document.getElementById("prev").click();
  }, {passive:true});

  // =========================
  // EFFETTI: lucciole + foglie + scintille
  // =========================
  function spawnFireflies(){
    const box = document.getElementById("fireflies");
    box.innerHTML = "";
    const n = 22;
    for(let i=0;i<n;i++){
      const f = document.createElement("div");
      f.className = "firefly";
      f.style.left = (Math.random()*100) + "%";
      f.style.top  = (Math.random()*100) + "%";
      f.style.setProperty("--t", (6 + Math.random()*9) + "s");
      f.style.setProperty("--dx", ((Math.random()*280)-140) + "px");
      f.style.setProperty("--dy", ((Math.random()*260)-180) + "px");
      f.style.animationDelay = (Math.random()*3) + "s";
      box.appendChild(f);
    }
  }

  function spawnLeaves(){
    const box = document.getElementById("leaves");
    box.innerHTML = "";
    const n = 34;
    for(let i=0;i<n;i++){
      const l = document.createElement("div");
      l.className = "leaf";
      l.style.left = (Math.random()*100) + "%";
      l.style.setProperty("--t", (7 + Math.random()*11) + "s");
      l.style.setProperty("--dx", ((Math.random()*300)-150) + "px");
      l.style.animationDelay = (Math.random()*6) + "s";
      const s = 0.65 + Math.random()*1.25;
      l.style.width = (30*s) + "px";
      l.style.height = (30*s) + "px";
      box.appendChild(l);
    }
  }

  function spawnSparks(){
    const box = document.getElementById("sparks");
    box.innerHTML = "";
    const n = 26;
    for(let i=0;i<n;i++){
      const s = document.createElement("div");
      s.className = "spark";
      s.style.left = (Math.random()*100) + "%";
      s.style.top  = (55 + Math.random()*50) + "%";
      s.style.setProperty("--t", (4 + Math.random()*6) + "s");
      s.style.setProperty("--dx", ((Math.random()*200)-100) + "px");
      s.style.setProperty("--dy", (Math.random()*110) + "px");
      s.style.animationDelay = (Math.random()*4) + "s";
      box.appendChild(s);
    }
  }

  window.addEventListener("resize", ()=>{
    spawnFireflies();
    spawnLeaves();
    spawnSparks();
    resizeConfetti();
  });

  // =========================
  // VENTO: reagisce allo scroll
  // =========================
  let lastY = window.scrollY;
  let lastT = performance.now();
  let wind = 0;
  let calmTimer = null;

  function setWind(v){
    wind = Math.max(0, Math.min(1, v));
    document.documentElement.style.setProperty("--wind", String(wind));
  }

  window.addEventListener("scroll", ()=>{
    const y = window.scrollY;
    const t = performance.now();
    const dy = Math.abs(y - lastY);
    const dt = Math.max(16, (t - lastT));
    const speed = dy / dt;

    const boost = Math.max(0, Math.min(1, speed * 3.6));
    setWind(Math.max(wind, boost));

    lastY = y; lastT = t;

    clearTimeout(calmTimer);
    calmTimer = setTimeout(()=> setWind(wind * 0.45), 160);
    setTimeout(()=> setWind(wind * 0.30), 360);
    setTimeout(()=> setWind(wind * 0.18), 720);
    setTimeout(()=> setWind(0), 1300);
  }, {passive:true});

  // =========================
  // Hue shift leggero (ambiente ‚Äúmagico‚Äù)
  // =========================
  let hue = 0;
  setInterval(()=>{
    hue = (hue + 2) % 360;
    document.documentElement.style.setProperty("--hue", hue + "deg");
    const glow = 0.95 + (Math.sin(Date.now()/1800) * 0.08);
    document.documentElement.style.setProperty("--glow", String(glow));
  }, 240);

  // =========================
  // CONFETTI (canvas) ‚Äì esplode sui compleanni
  // =========================
  const confettiCanvas = document.getElementById("confetti");
  const ctx = confettiCanvas.getContext("2d");
  let W = 0, H = 0;
  const confetti = [];
  function resizeConfetti(){
    W = confettiCanvas.width  = Math.floor(window.innerWidth * devicePixelRatio);
    H = confettiCanvas.height = Math.floor(window.innerHeight * devicePixelRatio);
    confettiCanvas.style.width = "100%";
    confettiCanvas.style.height = "100%";
    ctx.setTransform(1,0,0,1,0,0);
  }
  function rand(min,max){ return min + Math.random()*(max-min); }

  function burst(x,y,amount=90){
    for(let i=0;i<amount;i++){
      confetti.push({
        x, y,
        vx: rand(-7,7),
        vy: rand(-11,-3),
        g:  rand(0.18, 0.35),
        r:  rand(3, 6),
        rot: rand(0, Math.PI*2),
        vr: rand(-0.18, 0.18),
        life: rand(50, 90),
        t: 0
      });
    }
  }

  function burstConfettiFromElement(el){
    const rect = el.getBoundingClientRect();
    const x = (rect.left + rect.width*0.62) * devicePixelRatio;
    const y = (rect.top  + rect.height*0.45) * devicePixelRatio;
    burst(x,y,110);
  }

  function tickConfetti(){
    ctx.clearRect(0,0,W,H);
    for(let i=confetti.length-1;i>=0;i--){
      const p = confetti[i];
      p.t++;
      p.vy += p.g;
      p.x  += p.vx;
      p.y  += p.vy;
      p.rot += p.vr;

      const fade = Math.max(0, 1 - (p.t / p.life));
      ctx.globalAlpha = fade;

      // colori ‚Äúvivi‚Äù senza fissare palette rigida: hue dinamico
      const hh = (hue + (p.x/30)) % 360;
      ctx.fillStyle = `hsla(${hh}, 90%, 60%, 1)`;

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.beginPath();
      ctx.rect(-p.r, -p.r*0.6, p.r*2, p.r*1.2);
      ctx.fill();
      ctx.restore();

      if(p.t >= p.life || p.y > H + 40){
        confetti.splice(i,1);
      }
    }
    ctx.globalAlpha = 1;
    requestAnimationFrame(tickConfetti);
  }

  // =========================
  // INTRO -> ENTRA
  // =========================
  enterBtn.addEventListener("click", ()=>{
    intro.classList.add("hide");
    app.style.opacity = "1";
    app.style.transform = "translateY(0)";
    // mini burst anche all‚Äôingresso
    burst(window.innerWidth*0.5*devicePixelRatio, window.innerHeight*0.35*devicePixelRatio, 140);
  });

  // =========================
  // AVVIO
  // =========================
  (function init(){
    renderDOW();
    renderCalendar();

    spawnFireflies();
    spawnLeaves();
    spawnSparks();

    resizeConfetti();
    tickConfetti();
  })();
</script>
</body>
</html>
