<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calendario Scout nel Bosco (2026‚Äì2029)</title>

<style>
  :root{
    --text:#eef7ef; --muted: rgba(238,247,239,.78);
    --danger:#ff3f3f; --gold:#ffd24d;

    --overlayA: rgba(8,25,14,.55);
    --overlayB: rgba(8,25,14,.25);

    --panel: rgba(255,255,255,.10);
    --panel2: rgba(255,255,255,.14);

    --btn: rgba(0,0,0,.22);
    --btnBorder: rgba(255,255,255,.18);

    --shadow: 0 18px 50px rgba(0,0,0,.55);
    --radius: 18px;

    --bgUrl: url("bg_forest.jpg");
    --fliesOpacity: .75;
  }

  *{ box-sizing:border-box; }
  html, body { height:100%; }
  body{
    margin:0;
    color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    overflow-x:hidden;
    background:#08190e;
  }

  /* BACKGROUND BOSCO */
  .bg{
    position:fixed; inset:0;
    background-image: var(--bgUrl);
    background-size: cover;
    background-position:center;
    transform: scale(1.03);
    filter: saturate(1.05) contrast(1.05);
    z-index:-3;
  }
  .bgOverlay{
    position:fixed; inset:0;
    background:
      radial-gradient(1200px 800px at 20% 10%, rgba(124,255,138,.18), transparent 55%),
      radial-gradient(900px 600px at 90% 20%, rgba(255,210,77,.16), transparent 60%),
      linear-gradient(160deg, var(--overlayA), var(--overlayB));
    z-index:-2;
  }

  /* NEBBIA */
  .mist{
    position:fixed; inset:-60px;
    background:
      radial-gradient(520px 340px at 30% 30%, rgba(255,255,255,.10), transparent 70%),
      radial-gradient(700px 440px at 70% 45%, rgba(255,255,255,.08), transparent 72%),
      radial-gradient(520px 340px at 40% 80%, rgba(255,255,255,.07), transparent 70%);
    filter: blur(14px);
    opacity:.85;
    animation: drift 16s ease-in-out infinite alternate;
    pointer-events:none;
    z-index:-1;
  }
  @keyframes drift{
    from{ transform: translate3d(-10px, 0, 0) scale(1.02); }
    to  { transform: translate3d(10px, -8px, 0) scale(1.03); }
  }

  /* FOGLIE CHE CADONO */
  .leaves{ position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden; }
  .leafFall{
    position:absolute;
    top:-80px;
    width: 28px; height: 28px;
    background: radial-gradient(circle at 30% 30%, rgba(255,210,77,.9), rgba(18,58,32,.25));
    border-radius: 6px 18px 6px 18px;
    opacity:0;
    box-shadow: 0 6px 20px rgba(0,0,0,.18);
    animation:
      leafDown var(--t) linear infinite,
      leafSpin calc(var(--t) * .75) ease-in-out infinite;
  }
  .leafFall::after{
    content:"";
    position:absolute; inset:0;
    border-radius: inherit;
    background: linear-gradient(120deg, rgba(255,255,255,.25), transparent 55%);
    opacity:.65;
  }
  @keyframes leafDown{
    0%   { transform: translate3d(0,-60px,0); opacity:0; }
    8%   { opacity:.85; }
    50%  { opacity:.55; }
    100% { transform: translate3d(var(--dx), 110vh, 0); opacity:0; }
  }
  @keyframes leafSpin{
    0%{ rotate:0deg; } 50%{ rotate:130deg; } 100%{ rotate:260deg; }
  }

  /* LUCCIOLE */
  .fireflies{ position:fixed; inset:0; pointer-events:none; z-index:0; opacity:var(--fliesOpacity); }
  .firefly{
    position:absolute;
    width:6px; height:6px;
    border-radius:50%;
    background: rgba(255,210,77,.95);
    box-shadow: 0 0 18px rgba(255,210,77,.85);
    opacity:0;
    animation: fly var(--t) linear infinite;
  }
  @keyframes fly{
    0%{ transform: translate(0,0) scale(.8); opacity:0; }
    12%{ opacity:.95; }
    50%{ opacity:.35; }
    100%{ transform: translate(var(--dx), var(--dy)) scale(1.25); opacity:0; }
  }

  .wrap{
    position:relative;
    z-index:2;
    max-width: 1080px;
    margin: 22px auto 46px;
    padding: 14px;
  }

  .topbar{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
    padding: 14px;
    background: var(--panel);
    border: 1px solid var(--panel2);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
  }

  .title{ display:flex; gap:10px; align-items:center; font-weight:900; }
  .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  button, select, input, textarea{
    border:1px solid var(--btnBorder);
    background: var(--btn);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 14px;
    cursor:pointer;
    outline:none;
    font-family: inherit;
  }
  textarea{ cursor:text; resize:vertical; }
  button:hover, select:hover{ transform: translateY(-1px); }
  button:active{ transform: translateY(0px) scale(.98); }

  .monthTitle{
    font-size: 18px;
    font-weight: 900;
    text-transform: capitalize;
  }
  .badge{
    display:inline-flex;
    gap:8px;
    align-items:center;
    padding: 6px 10px;
    border-radius: 999px;
    background: rgba(124,255,138,.14);
    border:1px solid rgba(124,255,138,.35);
    font-size: 13px;
    white-space:nowrap;
  }

  .stage{
    margin-top: 14px;
    position:relative;
    border-radius: 22px;
    overflow:hidden;
    box-shadow: var(--shadow);
    border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    backdrop-filter: blur(10px);
  }

  .frame{
    position:absolute; inset:0;
    background: url("frame.jpg") center/cover no-repeat;
    opacity:.96;
    pointer-events:none;
    z-index:1;
  }

  .content{ position:relative; z-index:2; padding: 34px 26px 26px; }

  .grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
  .dow{
    text-align:center;
    font-weight:900;
    font-size: 13px;
    color: rgba(0,0,0,.80);
    background: rgba(255,255,255,.84);
    border-radius: 12px;
    padding: 10px 6px;
    border: 1px solid rgba(0,0,0,.08);
  }

  .day{
    min-height: 86px;
    border-radius: 16px;
    padding: 10px 10px 8px;
    background: rgba(255,255,255,.90);
    border: 1px solid rgba(0,0,0,.08);
    color: rgba(0,0,0,.88);
    cursor:pointer;
    position:relative;
    overflow:hidden;
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .day:hover{ transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,.18); }

  .day .n{
    font-weight:900;
    font-size: 16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    position:relative;
    z-index:2;
  }
  .leafBadge{
    position:absolute;
    right:-10px;
    bottom:-12px;
    width: 56px;
    height: 56px;
    border-radius: 18px;
    background: radial-gradient(circle at 30% 30%, rgba(124,255,138,.65), rgba(18,58,32,.15));
    transform: rotate(18deg);
    opacity:.55;
    animation: leafPulse 3.2s ease-in-out infinite;
    z-index:1;
  }
  @keyframes leafPulse{
    0%,100%{ transform: rotate(18deg) scale(1); opacity:.45; }
    50%{ transform: rotate(10deg) scale(1.06); opacity:.62; }
  }

  .off{ opacity:.55; }
  .today{
    outline: 3px solid rgba(124,255,138,.75);
    outline-offset: -3px;
  }

  /* ROSSO: festivi + compleanni */
  .red{
    border: 2px solid rgba(255,63,63,.70);
    box-shadow: inset 0 0 0 2px rgba(255,63,63,.08);
  }
  .red .n{ color: var(--danger); }

  .tags{
    margin-top: 8px;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    position:relative;
    z-index:2;
  }
  .tag{
    font-size: 11px;
    font-weight: 900;
    padding: 4px 8px;
    border-radius: 999px;
    border:1px solid rgba(0,0,0,.10);
    background: rgba(0,0,0,.06);
    color: rgba(0,0,0,.75);
  }
  .tag.bday,.tag.holi{ background: rgba(255,63,63,.12); border-color: rgba(255,63,63,.28); }
  .tag.saint{ background: rgba(255,210,77,.22); border-color: rgba(255,210,77,.45); }
  .tag.scout{ background: rgba(124,255,138,.18); border-color: rgba(124,255,138,.35); }

  /* MODALI */
  .modalBackdrop{
    position:fixed; inset:0;
    background: rgba(0,0,0,.60);
    display:none;
    align-items:center;
    justify-content:center;
    padding: 18px;
    z-index:99;
  }
  .modalBackdrop.show{ display:flex; }

  .modal{
    width:min(680px, 96vw);
    background: rgba(14,44,25,.92);
    border:1px solid rgba(255,255,255,.14);
    border-radius: 22px;
    box-shadow: var(--shadow);
    padding: 16px;
    transform: translateY(18px) scale(.95);
    opacity:0;
    animation: pop .32s ease forwards;
    position:relative;
    overflow:hidden;
  }
  @keyframes pop{ to{ transform: translateY(0) scale(1); opacity:1; } }
  .modalHeader{
    display:flex; justify-content:space-between; align-items:flex-start;
    gap:12px; padding:6px 6px 10px;
  }
  .modalTitle{ font-weight:900; font-size:18px; margin:0; }
  .modalBody{
    background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12);
    border-radius: 18px;
    padding: 12px;
    margin: 6px;
    position:relative;
    overflow:hidden;
  }
  .closeBtn{ padding:8px 10px; border-radius: 12px; }

  .line{
    display:flex; gap:10px; align-items:flex-start;
    padding:10px; border-radius:14px;
    background: rgba(0,0,0,.20);
    border:1px solid rgba(255,255,255,.10);
    margin-bottom: 10px;
    animation: slideIn .35s ease both;
  }
  @keyframes slideIn{
    from{ transform: translateX(-12px); opacity:0; }
    to{ transform: translateX(0); opacity:1; }
  }
  .ico{ font-size: 22px; line-height:1; }
  .sub{ color: rgba(238,247,239,.85); font-size: 13px; margin:2px 0 0; }

  /* EFFETTI: palloncini + coriandoli */
  .fxLayer{ position:absolute; inset:0; pointer-events:none; z-index:3; }
  .balloon{
    position:absolute;
    bottom:-40px;
    width: 22px; height: 28px;
    border-radius: 50% 50% 45% 45%;
    background: rgba(255,63,63,.92);
    box-shadow: 0 10px 18px rgba(0,0,0,.18);
    animation: balloonUp 1.8s ease-out forwards;
    opacity:0;
  }
  .balloon::after{
    content:"";
    position:absolute;
    left:50%; top: 26px;
    width:2px; height: 22px;
    background: rgba(255,255,255,.75);
    transform: translateX(-50%);
    opacity:.65;
  }
  @keyframes balloonUp{
    0%{ transform: translateY(0) scale(.9); opacity:0; }
    10%{ opacity:.95; }
    100%{ transform: translateY(-320px) scale(1.05); opacity:0; }
  }
  .conf{
    position:absolute;
    top:-10px;
    width: 8px; height: 10px;
    border-radius: 2px;
    background: rgba(255,210,77,.95);
    opacity:0;
    animation: confetti 1.4s linear forwards;
  }
  @keyframes confetti{
    0%{ transform: translateY(0) rotate(0deg); opacity:0; }
    10%{ opacity:1; }
    100%{ transform: translateY(360px) rotate(360deg); opacity:0; }
  }

  /* Sezione Baden-Powell */
  .bp{
    margin-top: 14px;
    background: var(--panel);
    border: 1px solid var(--panel2);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
    padding: 14px;
    display:flex;
    gap:14px;
    align-items:center;
    flex-wrap:wrap;
  }
  .bp img{
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,.18);
  }
  .bp h3{ margin:0; font-size:16px; }
  .bp p{ margin:6px 0 0; color: var(--muted); }

  @media (max-width: 780px){
    .content{ padding: 18px 14px 14px; }
    .day{ min-height: 74px; }
    .grid{ gap: 8px; }
    .monthTitle{ font-size: 16px; }
  }
</style>
</head>

<body>
  <div class="bg"></div>
  <div class="bgOverlay"></div>
  <div class="mist"></div>

  <div class="leaves" id="leaves"></div>
  <div class="fireflies" id="fireflies"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <div style="font-size:22px;">üå≤</div>
        <div>
          <div style="font-size:16px;font-weight:900;">Calendario Scout nel Bosco</div>
          <div style="color:var(--muted);font-size:13px;">2026 ‚Üí 2029 ‚Ä¢ eventi condivisi per tutti</div>
        </div>
      </div>

      <div class="controls">
        <button id="lawsBtn">üìú Leggi Scout</button>
        <button id="addBtn">‚ûï Nuovo evento</button>

        <button id="prev">‚¨ÖÔ∏è</button>
        <div class="monthTitle" id="monthTitle">‚Äî</div>
        <button id="next">‚û°Ô∏è</button>

        <select id="yearSel">
          <option>2026</option>
          <option>2027</option>
          <option>2028</option>
          <option>2029</option>
        </select>

        <button id="todayBtn">Oggi</button>
        <span class="badge">üî¥ Rosso: feste & compleanni</span>
      </div>
    </div>

    <div class="stage" id="stage">
      <div class="frame"></div>

      <div class="content">
        <div class="grid" id="dow"></div>
        <div style="height:10px"></div>
        <div class="grid" id="cal"></div>
      </div>
    </div>

    <div class="bp">
      <img src="baden-powell.jpg" alt="Baden-Powell (immagine)" onerror="this.style.display='none'">
      <div>
        <h3>‚öúÔ∏è Robert Baden-Powell (fondatore degli scout)</h3>
        <p>‚ÄúLascia il posto migliore di come lo hai trovato.‚Äù</p>
      </div>
    </div>
  </div>

  <!-- MODAL EVENTI -->
  <div class="modalBackdrop" id="backdrop">
    <div class="modal">
      <div class="modalHeader">
        <h3 class="modalTitle" id="mTitle">Dettagli</h3>
        <button class="closeBtn" id="close">Chiudi ‚úñ</button>
      </div>
      <div class="modalBody" id="mBody">
        <div class="fxLayer" id="fx"></div>
      </div>
    </div>
  </div>

  <!-- MODAL LEGGI SCOUT -->
  <div class="modalBackdrop" id="lawsBackdrop">
    <div class="modal">
      <div class="modalHeader">
        <h3 class="modalTitle">üìú Legge Scout</h3>
        <button class="closeBtn" id="lawsClose">Chiudi ‚úñ</button>
      </div>
      <div class="modalBody" id="lawsBody" style="color:#eef7ef;">
        <div class="line"><div class="ico">1Ô∏è‚É£</div><div><b>Lo scout √® leale.</b><div class="sub">Dice la verit√† e mantiene la parola data.</div></div></div>
        <div class="line"><div class="ico">2Ô∏è‚É£</div><div><b>Lo scout √® amico di tutti e fratello di ogni altro scout.</b><div class="sub">Aiuta senza guardare chi sei.</div></div></div>
        <div class="line"><div class="ico">3Ô∏è‚É£</div><div><b>Lo scout √® cortese.</b><div class="sub">Rispetta gli altri e si comporta bene.</div></div></div>
        <div class="line"><div class="ico">4Ô∏è‚É£</div><div><b>Lo scout ama e rispetta la natura.</b><div class="sub">Protegge il bosco, gli animali e l‚Äôambiente.</div></div></div>
        <div class="line"><div class="ico">5Ô∏è‚É£</div><div><b>Lo scout sorride e canta anche nelle difficolt√†.</b><div class="sub">Non si arrende e porta buon umore.</div></div></div>
        <div class="line"><div class="ico">6Ô∏è‚É£</div><div><b>Lo scout √® laborioso ed economo.</b><div class="sub">Usa bene le cose e non spreca.</div></div></div>
        <div class="line"><div class="ico">7Ô∏è‚É£</div><div><b>Lo scout √® puro nei pensieri, parole e azioni.</b><div class="sub">Fa scelte giuste e rispettose.</div></div></div>
      </div>
    </div>
  </div>

  <!-- MODAL NUOVO EVENTO -->
  <div class="modalBackdrop" id="addBackdrop">
    <div class="modal">
      <div class="modalHeader">
        <h3 class="modalTitle">‚ûï Nuovo evento</h3>
        <button class="closeBtn" id="addClose">Chiudi ‚úñ</button>
      </div>
      <div class="modalBody">
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:10px;">
          <input id="dayInp" type="number" min="1" max="31" placeholder="Giorno">
          <input id="monInp" type="number" min="1" max="12" placeholder="Mese">
          <input id="yearInp" type="number" min="2026" max="2029" placeholder="Anno">
        </div>

        <select id="typeInp" style="width:100%;margin-bottom:10px;">
          <option value="bday">üéÇ Compleanno</option>
          <option value="scout">üèïÔ∏è Uscita</option>
          <option value="camp">üî• Campo</option>
          <option value="meet">üìå Riunione</option>
          <option value="service">ü§ù Servizio</option>
          <option value="route">üß≠ Route</option>
          <option value="saint">‚õ™ Santo</option>
          <option value="holi">üéâ Festivo</option>
        </select>

        <input id="titleInp" placeholder="Titolo evento (es: Uscita di Reparto)" style="width:100%;margin-bottom:10px;">
        <textarea id="detailInp" rows="3" placeholder="Descrizione (opzionale)" style="width:100%;"></textarea>

        <div style="display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:10px;">
          <button id="saveEventBtn">‚úÖ Salva evento (visibile a tutti)</button>
        </div>

        <div id="addMsg" style="margin-top:10px;color:var(--muted);font-size:13px;"></div>
      </div>
    </div>
  </div>

<script>
  // =========================
  // CONFIG: INCOLLA QUI LA TUA API
  // =========================
  const API_URL = "INCOLLA_QUI_LA_TUA_URL_APPS_SCRIPT";

  // =========================
  // UTIL
  // =========================
  const pad = n => String(n).padStart(2,"0");
  const ymd = (y,m,d) => `${y}-${pad(m)}-${pad(d)}`;
  const itMonth = (y,m) => new Date(y, m-1, 1).toLocaleString("it-IT",{month:"long", year:"numeric"});
  const DOW = ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];
  const inRange = y => (y>=2026 && y<=2029);

  // =========================
  // DOM
  // =========================
  const dowEl = document.getElementById("dow");
  const calEl = document.getElementById("cal");
  const monthTitleEl = document.getElementById("monthTitle");
  const yearSel = document.getElementById("yearSel");

  const backdrop = document.getElementById("backdrop");
  const closeBtn = document.getElementById("close");
  const mTitle = document.getElementById("mTitle");
  const mBody = document.getElementById("mBody");
  const fx = document.getElementById("fx");

  const lawsBackdrop = document.getElementById("lawsBackdrop");
  const lawsBtn = document.getElementById("lawsBtn");
  const lawsClose = document.getElementById("lawsClose");

  const addBackdrop = document.getElementById("addBackdrop");
  const addBtn = document.getElementById("addBtn");
  const addClose = document.getElementById("addClose");
  const saveEventBtn = document.getElementById("saveEventBtn");
  const addMsg = document.getElementById("addMsg");

  const dayInp = document.getElementById("dayInp");
  const monInp = document.getElementById("monInp");
  const yearInp = document.getElementById("yearInp");
  const typeInp = document.getElementById("typeInp");
  const titleInp = document.getElementById("titleInp");
  const detailInp = document.getElementById("detailInp");

  // =========================
  // STATO CALENDARIO
  // =========================
  let stateYear = 2026;
  let stateMonth = 1;

  // =========================
  // EVENTI (caricati da API)
  // Struttura interna: { "YYYY-MM-DD": [ {type,title,detail,icon} ] }
  // =========================
  const EVENTS = {};

  function iconForType(type){
    if(type==="bday") return "üéÇ";
    if(type==="scout") return "üèïÔ∏è";
    if(type==="camp") return "üî•";
    if(type==="meet") return "üìå";
    if(type==="service") return "ü§ù";
    if(type==="route") return "üß≠";
    if(type==="saint") return "‚õ™";
    if(type==="holi") return "üéâ";
    return "üìå";
  }

  function tagClass(type){
    if(type==="bday") return "bday";
    if(type==="holi") return "holi";
    if(type==="saint") return "saint";
    if(["scout","camp","meet","service","route"].includes(type)) return "scout";
    return "";
  }

  function tagLabel(type){
    if(type==="bday") return "Compleanno";
    if(type==="holi") return "Festivo";
    if(type==="saint") return "Santo";
    if(type==="scout") return "Uscita";
    if(type==="camp") return "Campo";
    if(type==="meet") return "Riunione";
    if(type==="service") return "Servizio";
    if(type==="route") return "Route";
    return "Evento";
  }

  function eventsFor(key){ return EVENTS[key] || []; }
  function isRedDay(key){
    const ev = eventsFor(key);
    return ev.some(e => e.type==="bday" || e.type==="holi");
  }

  // =========================
  // CALENDARIO: calcoli
  // =========================
  function firstDayOffset(y,m){
    const js = new Date(y, m-1, 1).getDay(); // 0 dom..6 sab
    return (js + 6) % 7; // lun=0..dom=6
  }
  function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); }

  // =========================
  // TEMA: stagione + giorno/notte (semplice)
  // =========================
  function setTheme(){
    const m = stateMonth;
    const hour = new Date().getHours();
    const night = (hour >= 20 || hour < 7);

    // stagione
    let overlayA = "rgba(8,25,14,.55)", overlayB = "rgba(8,25,14,.25)";
    if([12,1,2].includes(m)) { overlayA="rgba(8,16,32,.62)"; overlayB="rgba(8,16,32,.28)"; }
    if([6,7,8].includes(m)) { overlayA="rgba(40,22,6,.55)"; overlayB="rgba(15,35,18,.20)"; }
    if([9,10,11].includes(m)) { overlayA="rgba(22,12,6,.60)"; overlayB="rgba(15,30,16,.22)"; }

    document.documentElement.style.setProperty("--overlayA", night ? "rgba(0,0,0,.72)" : overlayA);
    document.documentElement.style.setProperty("--overlayB", night ? "rgba(0,0,0,.32)" : overlayB);
    document.documentElement.style.setProperty("--fliesOpacity", night ? ".95" : ".55");
  }

  // =========================
  // RENDER
  // =========================
  function renderDOW(){
    dowEl.innerHTML = "";
    DOW.forEach(d=>{
      const div = document.createElement("div");
      div.className="dow";
      div.textContent = d;
      dowEl.appendChild(div);
    });
  }

  function renderCalendar(){
    if(!inRange(stateYear)){ stateYear = 2026; stateMonth = 1; }
    setTheme();
    monthTitleEl.textContent = itMonth(stateYear, stateMonth);
    yearSel.value = String(stateYear);

    calEl.innerHTML = "";

    const today = new Date();
    const todayKey = ymd(today.getFullYear(), today.getMonth()+1, today.getDate());

    const offset = firstDayOffset(stateYear, stateMonth);
    const dim = daysInMonth(stateYear, stateMonth);

    const prevMonth = stateMonth === 1 ? 12 : stateMonth - 1;
    const prevYear  = stateMonth === 1 ? stateYear - 1 : stateYear;
    const nextMonth = stateMonth === 12 ? 1 : stateMonth + 1;
    const nextYear  = stateMonth === 12 ? stateYear + 1 : stateYear;

    const dimPrev = daysInMonth(prevYear, prevMonth);

    let cells = 0;

    for(let i=0;i<offset;i++){
      const dayNum = dimPrev - offset + 1 + i;
      const key = ymd(prevYear, prevMonth, dayNum);
      calEl.appendChild(makeDayCell(prevYear, prevMonth, dayNum, key, true, todayKey));
      cells++;
    }

    for(let d=1; d<=dim; d++){
      const key = ymd(stateYear, stateMonth, d);
      calEl.appendChild(makeDayCell(stateYear, stateMonth, d, key, false, todayKey));
      cells++;
    }

    let nextDay = 1;
    while(cells < 42){
      const key = ymd(nextYear, nextMonth, nextDay);
      calEl.appendChild(makeDayCell(nextYear, nextMonth, nextDay, key, true, todayKey));
      cells++;
      nextDay++;
    }
  }

  function makeDayCell(y,m,d,key,isOff,todayKey){
    const evs = eventsFor(key);
    const div = document.createElement("div");

    div.className = "day" + (isOff ? " off" : "") + (key===todayKey ? " today" : "") + (isRedDay(key) ? " red" : "");
    const iconMini =
      evs.some(e=>e.type==="bday") ? "üéÇ" :
      evs.some(e=>e.type==="holi") ? "üéâ" :
      evs.some(e=>["scout","camp","meet","service","route"].includes(e.type)) ? "‚öúÔ∏è" :
      evs.some(e=>e.type==="saint") ? "‚õ™" : "";

    div.innerHTML = `
      <div class="leafBadge"></div>
      <div class="n">
        <span>${d}</span>
        <span style="font-size:12px;opacity:.85;">${iconMini}</span>
      </div>
      <div class="tags">
        ${evs.slice(0,3).map(e => `<span class="tag ${tagClass(e.type)}">${tagLabel(e.type)}</span>`).join("")}
      </div>
    `;

    div.addEventListener("click", ()=>{
      const nice = new Date(y, m-1, d).toLocaleDateString("it-IT", {weekday:"long", day:"2-digit", month:"long", year:"numeric"});
      if(isOff){ stateYear=y; stateMonth=m; renderCalendar(); }
      openModal(key, nice, evs);
    });

    return div;
  }

  // =========================
  // MODAL EVENTI + EFFETTI
  // =========================
  function clearFx(){ fx.innerHTML = ""; }

  function spawnBalloons(){
    for(let i=0;i<10;i++){
      const b = document.createElement("div");
      b.className = "balloon";
      b.style.left = (6 + Math.random()*88) + "%";
      b.style.animationDelay = (Math.random()*0.35) + "s";
      const r = 120 + Math.floor(Math.random()*135);
      const g = 80 + Math.floor(Math.random()*140);
      b.style.background = `rgba(${r},${g},120,.92)`;
      fx.appendChild(b);
    }
  }
  function spawnConfetti(){
    for(let i=0;i<30;i++){
      const c = document.createElement("div");
      c.className = "conf";
      c.style.left = (Math.random()*100) + "%";
      c.style.animationDelay = (Math.random()*0.35) + "s";
      const colors = ["rgba(255,210,77,.95)","rgba(124,255,138,.95)","rgba(255,63,63,.95)","rgba(150,200,255,.95)"];
      c.style.background = colors[Math.floor(Math.random()*colors.length)];
      fx.appendChild(c);
    }
  }

  function openModal(dateKey, niceLabel, evs){
    mTitle.textContent = niceLabel;
    clearFx();

    mBody.querySelectorAll(".line").forEach(n=>n.remove());

    if(!evs.length){
      const line = document.createElement("div");
      line.className="line";
      line.innerHTML = `<div class="ico">üåø</div><div><p style="margin:0;font-weight:900;">Nessun evento segnato</p>
        <p class="sub">Giornata perfetta per una buona azione scout üòä</p></div>`;
      mBody.appendChild(line);
    } else {
      evs.forEach((e)=>{
        const line = document.createElement("div");
        line.className="line";
        line.innerHTML = `<div class="ico">${e.icon}</div><div>
          <p style="margin:0;font-weight:900;">${e.title}</p>
          <p class="sub">${e.detail || ""}</p></div>`;
        mBody.appendChild(line);
      });

      if(evs.some(e=>e.type==="bday")){ spawnBalloons(); spawnConfetti(); }
      else if(evs.some(e=>e.type==="holi")){ spawnConfetti(); }
    }

    backdrop.classList.add("show");
  }

  function closeModal(){
    backdrop.classList.remove("show");
    clearFx();
  }
  closeBtn.addEventListener("click", closeModal);
  backdrop.addEventListener("click", (e)=>{ if(e.target===backdrop) closeModal(); });
  window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") { closeModal(); lawsBackdrop.classList.remove("show"); addBackdrop.classList.remove("show"); } });

  // =========================
  // LEGGI SCOUT
  // =========================
  lawsBtn.addEventListener("click", ()=> lawsBackdrop.classList.add("show"));
  lawsClose.addEventListener("click", ()=> lawsBackdrop.classList.remove("show"));
  lawsBackdrop.addEventListener("click", (e)=>{ if(e.target===lawsBackdrop) lawsBackdrop.classList.remove("show"); });

  // =========================
  // NUOVO EVENTO (form)
  // =========================
  addBtn.addEventListener("click", ()=>{
    addMsg.textContent = "";
    const t = new Date();
    dayInp.value = t.getDate();
    monInp.value = t.getMonth()+1;
    yearInp.value = Math.min(2029, Math.max(2026, t.getFullYear()));
    typeInp.value = "scout";
    titleInp.value = "";
    detailInp.value = "";
    addBackdrop.classList.add("show");
  });
  addClose.addEventListener("click", ()=> addBackdrop.classList.remove("show"));
  addBackdrop.addEventListener("click", (e)=>{ if(e.target===addBackdrop) addBackdrop.classList.remove("show"); });

  saveEventBtn.addEventListener("click", async ()=>{
    const d = parseInt(dayInp.value,10);
    const m = parseInt(monInp.value,10);
    const y = parseInt(yearInp.value,10);

    if(!(d>=1 && d<=31 && m>=1 && m<=12 && inRange(y))){
      addMsg.textContent = "‚ùå Data non valida (deve essere tra 2026 e 2029).";
      return;
    }
    const date = ymd(y,m,d);
    const type = typeInp.value;
    const title = titleInp.value.trim();
    const detail = detailInp.value.trim();

    if(!title){
      addMsg.textContent = "‚ùå Inserisci almeno un titolo (es: Uscita di Reparto).";
      return;
    }

    addMsg.textContent = "‚è≥ Salvataggio in corso...";
    try{
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify({ date, type, title, detail })
      });
      const js = await res.json();
      if(!js.ok) throw new Error(js.error || "Errore");

      addMsg.textContent = "‚úÖ Evento salvato! Ora lo vedono tutti.";
      addBackdrop.classList.remove("show");

      // ricarica eventi
      await loadEvents();
      // vai al mese dell‚Äôevento
      stateYear = y; stateMonth = m;
      renderCalendar();

    }catch(err){
      addMsg.textContent = "‚ùå Errore nel salvataggio. Controlla API_URL e permessi Apps Script.";
    }
  });

  // =========================
  // NAV
  // =========================
  document.getElementById("prev").addEventListener("click", ()=>{
    stateMonth--;
    if(stateMonth<1){ stateMonth=12; stateYear--; }
    if(!inRange(stateYear)){ stateYear=2026; stateMonth=1; }
    renderCalendar();
  });

  document.getElementById("next").addEventListener("click", ()=>{
    stateMonth++;
    if(stateMonth>12){ stateMonth=1; stateYear++; }
    if(!inRange(stateYear)){ stateYear=2029; stateMonth=12; }
    renderCalendar();
  });

  yearSel.addEventListener("change", ()=>{
    stateYear = parseInt(yearSel.value,10);
    renderCalendar();
  });

  document.getElementById("todayBtn").addEventListener("click", ()=>{
    const t = new Date();
    if(t.getFullYear()<2026 || t.getFullYear()>2029){ stateYear=2026; stateMonth=1; }
    else { stateYear=t.getFullYear(); stateMonth=t.getMonth()+1; }
    renderCalendar();
  });

  // =========================
  // EFFETTI: foglie + lucciole
  // =========================
  function spawnLeaves(){
    const box = document.getElementById("leaves");
    box.innerHTML = "";
    const n = 28;
    for(let i=0;i<n;i++){
      const l = document.createElement("div");
      l.className = "leafFall";
      l.style.left = (Math.random()*100) + "%";
      l.style.setProperty("--t", (8 + Math.random()*10) + "s");
      l.style.setProperty("--dx", ((Math.random()*220)-110) + "px");
      l.style.animationDelay = (Math.random()*6) + "s";
      const s = 0.75 + Math.random()*1.0;
      l.style.width = (28*s) + "px";
      l.style.height = (28*s) + "px";
      box.appendChild(l);
    }
  }

  function spawnFireflies(){
    const box = document.getElementById("fireflies");
    box.innerHTML = "";
    const n = 16;
    for(let i=0;i<n;i++){
      const f = document.createElement("div");
      f.className = "firefly";
      f.style.left = (Math.random()*100) + "%";
      f.style.top  = (Math.random()*100) + "%";
      f.style.setProperty("--t", (6 + Math.random()*8) + "s");
      f.style.setProperty("--dx", ((Math.random()*240)-120) + "px");
      f.style.setProperty("--dy", ((Math.random()*220)-160) + "px");
      f.style.animationDelay = (Math.random()*3) + "s";
      box.appendChild(f);
    }
  }

  // =========================
  // LOAD EVENTS da Google Sheet
  // =========================
  async function loadEvents(){
    // pulizia
    Object.keys(EVENTS).forEach(k=> delete EVENTS[k]);

    // fallback: se API_URL non √® impostata, almeno mostro un esempio
    if(!API_URL || API_URL.includes("INCOLLA_QUI")){
      const k = "2026-01-20";
      EVENTS[k] = [{ type:"bday", icon:"üéÇ", title:"Compleanno di Simone", detail:"Auguri! üéà" }];
      return;
    }

    const res = await fetch(API_URL);
    const js = await res.json();

    if(!js.ok) throw new Error("API non ok");

    (js.events || []).forEach(row=>{
      const date = row.date;
      if(!date) return;
      const type = row.type || "note";
      const title = row.title || "Evento";
      const detail = row.detail || "";

      EVENTS[date] = EVENTS[date] || [];
      EVENTS[date].push({ type, icon: iconForType(type), title, detail });
    });
  }

  // =========================
  // AVVIO
  // =========================
  function renderAll(){
    renderDOW();
    spawnLeaves();
    spawnFireflies();
    renderCalendar();
    setTheme();
  }

  window.addEventListener("resize", ()=>{
    spawnLeaves();
    spawnFireflies();
  });

  (async ()=>{
    renderAll();
    try{
      await loadEvents();
    }catch(e){
      // se fallisce, almeno non rompe il sito
    }
    renderCalendar();
    setInterval(()=>setTheme(), 60000);
  })();
</script>
</body>
</html>
