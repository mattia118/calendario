<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calendario Scout nel Bosco (2026‚Äì2029)</title>

<style>
  :root{
    --text:#eef7ef; --muted: rgba(238,247,239,.78);
    --danger:#ff3f3f; --gold:#ffd24d;

    --overlayA: rgba(8,25,14,.58);
    --overlayB: rgba(8,25,14,.26);

    --panel: rgba(255,255,255,.10);
    --panel2: rgba(255,255,255,.14);

    --btn: rgba(0,0,0,.22);
    --btnBorder: rgba(255,255,255,.18);

    --shadow: 0 18px 50px rgba(0,0,0,.55);
    --radius: 18px;

    /* ‚úÖ SFONDO */
    --bgUrl: url("ChatGPT Image 19 gen 2026, 21_00_05.png");

    --fliesOpacity: .75;
    --windStrength: 0;
  }

  *{ box-sizing:border-box; }
  html, body { height:100%; }
  body{
    margin:0;
    color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    overflow-x:hidden;
    background:#08190e;
  }

  /* SFONDO */
  .bg{
    position:fixed; inset:0;
    background-image: var(--bgUrl);
    background-size: cover;
    background-position:center;
    transform:scale(1.03);
    z-index:-6;
    animation: bgSlow 16s ease-in-out infinite alternate;
  }
  @keyframes bgSlow{
    from{ transform: scale(1.03) translateY(0) translateX(0); filter:saturate(1); }
    to  { transform: scale(1.06) translateY(-10px) translateX(4px); filter:saturate(1.12); }
  }

  .bgOverlay{
    position:fixed; inset:0;
    background:
      radial-gradient(1200px 800px at 20% 10%, rgba(124,255,138,.18), transparent 55%),
      radial-gradient(900px 600px at 90% 20%, rgba(255,210,77,.16), transparent 60%),
      linear-gradient(160deg, var(--overlayA), var(--overlayB));
    z-index:-5;
    animation: overlayBreath 9s ease-in-out infinite;
  }
  @keyframes overlayBreath{ 0%,100%{ opacity:1; } 50%{ opacity:.92; } }

  /* NEBBIA/VENTO */
  .wind{
    position:fixed; inset:-90px;
    pointer-events:none;
    background:
      radial-gradient(700px 440px at 30% 30%, rgba(255,255,255,.12), transparent 72%),
      radial-gradient(900px 600px at 70% 45%, rgba(255,255,255,.09), transparent 74%),
      radial-gradient(720px 480px at 40% 80%, rgba(255,255,255,.08), transparent 72%);
    filter: blur(18px);
    opacity: calc(0.55 + (var(--windStrength) * 0.25));
    transform: translate3d(calc(var(--windStrength) * 18px), calc(var(--windStrength) * -8px), 0) scale(calc(1.02 + var(--windStrength) * 0.02));
    transition: opacity .35s ease, transform .35s ease;
    z-index:-4;
    animation: fogDrift 10s ease-in-out infinite alternate;
  }
  @keyframes fogDrift{
    from{ filter: blur(18px); }
    to{ filter: blur(22px); }
  }

  /* FOGLIE */
  .leaves{ position:fixed; inset:0; pointer-events:none; z-index:-1; overflow:hidden; }
  .leafFall{
    position:absolute; top:-80px;
    width:28px; height:28px;
    background: radial-gradient(circle at 30% 30%, rgba(255,210,77,.9), rgba(18,58,32,.25));
    border-radius: 6px 18px 6px 18px;
    opacity:0;
    animation: leafDown var(--t) linear infinite, leafSpin calc(var(--t) * .75) ease-in-out infinite;
    box-shadow: 0 6px 20px rgba(0,0,0,.18);
    transform: translateX(calc(var(--windStrength) * 8px));
  }
  @keyframes leafDown{
    0%{ transform: translate3d(0,-60px,0); opacity:0; }
    8%{ opacity:.85; }
    50%{ opacity:.55; }
    100%{ transform: translate3d(calc(var(--dx) + var(--windStrength) * 140px), 110vh, 0); opacity:0; }
  }
  @keyframes leafSpin{ 0%{ rotate:0deg; } 50%{ rotate:140deg; } 100%{ rotate:300deg; } }

  /* LUCCIOLE */
  .fireflies{ position:fixed; inset:0; pointer-events:none; z-index:-1; opacity:var(--fliesOpacity); }
  .firefly{
    position:absolute; width:6px; height:6px; border-radius:50%;
    background: rgba(255,210,77,.95);
    box-shadow: 0 0 18px rgba(255,210,77,.85);
    opacity:0;
    animation: fly var(--t) linear infinite;
  }
  @keyframes fly{
    0%{ transform: translate(0,0) scale(.8); opacity:0; }
    12%{ opacity:.95; }
    50%{ opacity:.35; }
    100%{ transform: translate(calc(var(--dx) + var(--windStrength) * 80px), var(--dy)) scale(1.25); opacity:0; }
  }

  /* SCINTILLE (piccole particelle) */
  .sparks{ position:fixed; inset:0; pointer-events:none; z-index:-1; }
  .spark{
    position:absolute;
    width:3px; height:3px; border-radius:50%;
    background: rgba(255,255,255,.85);
    box-shadow: 0 0 16px rgba(255,255,255,.32);
    opacity:0;
    animation: sparkFloat var(--t) ease-in-out infinite;
  }
  @keyframes sparkFloat{
    0%{ transform: translate3d(0,20px,0) scale(.8); opacity:0; }
    15%{ opacity:.55; }
    60%{ opacity:.25; }
    100%{ transform: translate3d(var(--dx), calc(-140px - var(--dy)), 0) scale(1.2); opacity:0; }
  }

  /* INTRO */
  .intro{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background: rgba(0,0,0,.62);
    backdrop-filter: blur(10px);
    z-index:50;
    transition: opacity .6s ease, transform .6s ease;
  }
  .intro.hide{ opacity:0; pointer-events:none; transform: scale(1.02); }

  .introRing{
    position:absolute;
    width:280px; height:280px;
    border-radius:50%;
    border:1px solid rgba(255,255,255,.22);
    box-shadow: 0 0 60px rgba(255,255,255,.10);
    animation: ring 3.2s ease-in-out infinite;
  }
  .introRing::after{
    content:"";
    position:absolute; inset:-18px;
    border-radius:50%;
    border:1px dashed rgba(255,210,77,.22);
    animation: ring2 6.8s linear infinite;
  }
  @keyframes ring{
    0%,100%{ transform: scale(1); opacity:.65; }
    50%{ transform: scale(1.06); opacity:.95; }
  }
  @keyframes ring2{ to{ transform: rotate(360deg); } }

  .enterBtn{
    position:relative;
    padding: 22px 46px;
    font-size: 26px;
    font-weight: 900;
    letter-spacing: .06em;
    border-radius: 999px;
    border: 2px solid rgba(255,255,255,.48);
    background: rgba(0,0,0,.30);
    color: var(--text);
    cursor:pointer;
    box-shadow: 0 22px 60px rgba(0,0,0,.55), 0 0 40px rgba(255,255,255,.18);
    animation: pulse 2.2s ease-in-out infinite;
    overflow:hidden;
  }
  .enterBtn::after{
    content:"";
    position:absolute; inset:-70px;
    background: radial-gradient(320px 220px at 30% 30%, rgba(255,255,255,.14), transparent 60%);
    transform: translateX(-40%);
    animation: shimmer 2.6s ease-in-out infinite;
  }
  @keyframes shimmer{ 0%,100%{ opacity:.25; transform: translateX(-40%); } 50%{ opacity:.55; transform: translateX(40%); } }
  @keyframes pulse{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-2px); } }
  .enterHint{ margin-top:14px; color: rgba(238,247,239,.78); font-size: 13px; text-align:center; }

  /* LAYOUT */
  .wrap{ position:relative; z-index:2; max-width:1080px; margin:22px auto 46px; padding:14px; }

  .topbar{
    display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    padding:14px; background:var(--panel); border:1px solid var(--panel2);
    border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter: blur(10px);
    animation: floatPanel 7s ease-in-out infinite;
  }
  @keyframes floatPanel{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-2px); } }

  .title{ display:flex; gap:10px; align-items:center; font-weight:900; }
  .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  button, select{
    border:1px solid var(--btnBorder); background: var(--btn); color: var(--text);
    padding:10px 12px; border-radius:14px; cursor:pointer; outline:none; font-family:inherit;
    transition: transform .18s ease, filter .18s ease, box-shadow .18s ease;
  }
  button:hover, select:hover{ transform: translateY(-1px) scale(1.01); filter: brightness(1.08); box-shadow: 0 14px 28px rgba(0,0,0,.22); }
  button:active{ transform: translateY(0) scale(.99); }

  .monthTitle{ font-size:18px; font-weight:900; text-transform:capitalize; }
  .muted{ color: var(--muted); font-size:13px; }

  .stage{
    margin-top:14px; position:relative; border-radius:22px; overflow:hidden;
    box-shadow:var(--shadow); border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    backdrop-filter: blur(10px);
  }
  .frame{ position:absolute; inset:0; background:url("frame.jpg") center/cover no-repeat; opacity:.96; pointer-events:none; z-index:1; }
  .content{ position:relative; z-index:2; padding:34px 26px 18px; }

  .grid{ display:grid; grid-template-columns:repeat(7, 1fr); gap:10px; }

  .dow{
    text-align:center; font-weight:900; font-size:13px; color: rgba(0,0,0,.80);
    background: rgba(255,255,255,.84); border-radius:12px; padding:10px 6px; border:1px solid rgba(0,0,0,.08);
    animation: popIn .5s ease both;
  }
  @keyframes popIn{ from{ transform: translateY(6px); opacity:0; } to{ transform: translateY(0); opacity:1; } }

  .day{
    border-radius:16px; padding:10px; background: rgba(255,255,255,.90);
    border:1px solid rgba(0,0,0,.08); color: rgba(0,0,0,.88);
    position:relative; overflow:hidden; display:flex; align-items:flex-start; justify-content:flex-start;
    transition: transform .18s ease, filter .18s ease, box-shadow .18s ease;
  }
  .day:hover{
    transform: translateY(-2px) scale(1.01);
    filter: brightness(1.03);
    box-shadow: 0 16px 30px rgba(0,0,0,.18);
  }
  .day .n{ font-weight:900; font-size:16px; }
  .off{ opacity:.55; }

  .today{
    outline: 3px solid rgba(124,255,138,.75);
    outline-offset:-3px;
    animation: todayGlow 2.2s ease-in-out infinite;
  }
  @keyframes todayGlow{
    0%,100%{ box-shadow: 0 0 0 rgba(124,255,138,0); }
    50%{ box-shadow: 0 0 28px rgba(124,255,138,.35); }
  }

  /* marker */
  .marker{
    position:absolute; right:8px; bottom:8px;
    font-size:14px; opacity:.98;
    animation: markerBounce 1.8s ease-in-out infinite;
    transform-origin: 50% 70%;
    display:flex; gap:2px; align-items:center;
  }
  @keyframes markerBounce{
    0%,100%{ transform: translateY(0) rotate(0deg); }
    50%{ transform: translateY(-2px) rotate(-2deg); }
  }

  /* aura evento */
  .eventDay::before{
    content:"";
    position:absolute; inset:-40px;
    background:
      radial-gradient(240px 180px at 25% 25%, rgba(255,63,63,.12), transparent 62%),
      radial-gradient(260px 200px at 80% 40%, rgba(255,210,77,.14), transparent 62%);
    opacity:.9;
    filter: blur(12px);
    pointer-events:none;
    animation: eventAura 3.4s ease-in-out infinite;
  }
  @keyframes eventAura{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-6px); } }

  /* üéÇ Simone lampeggia forte */
  .simoneBlink{
    outline: 3px solid rgba(255,63,63,.88);
    outline-offset:-3px;
    animation: blink 1.0s ease-in-out infinite;
  }
  @keyframes blink{
    0%,100%{ filter: brightness(1); box-shadow: 0 0 0 rgba(255,63,63,0); }
    50%{ filter: brightness(1.12); box-shadow: 0 0 40px rgba(255,63,63,.55); }
  }

  /* highlight quando arrivi dal countdown */
  .jumpFlash{
    animation: jumpFlash 1.6s ease-in-out 0s 3;
  }
  @keyframes jumpFlash{
    0%{ transform: scale(1); }
    50%{ transform: scale(1.03); filter: brightness(1.14); box-shadow: 0 0 40px rgba(255,63,63,.45); }
    100%{ transform: scale(1); }
  }

  /* TELEFONO */
  @media (max-width: 780px){
    .content{ padding: 18px 14px 14px; }
    .grid{ gap:8px; }
    .day{ aspect-ratio: 1/1; padding:8px; }
    .day .n{ font-size:14px; }
    .monthTitle{ font-size:16px; }
  }

  /* lista eventi del mese */
  .monthEvents{
    margin-top: 10px;
    padding: 10px 12px;
    border-radius: 16px;
    background: rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.14);
    display:flex;
    flex-direction:column;
    gap:6px;
    animation: rise .35s ease both;
  }
  .monthEventsLine{
    display:flex; gap:10px; align-items:flex-start;
    padding:8px 10px;
    border-radius:14px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    transition: transform .18s ease, filter .18s ease;
  }
  .monthEventsLine:hover{ transform: translateY(-1px); filter: brightness(1.06); }
  .monthEventsIco{ font-size:18px; line-height:1; }
  .monthEventsTxt{ font-size:13px; color: rgba(238,247,239,.88); }
  .monthEventsSub{ font-size:12px; color: var(--muted); margin-top:2px; }

  /* ACCORDION */
  .accordion{
    margin-top:14px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .accItem{
    background: var(--panel);
    border:1px solid var(--panel2);
    border-radius: 20px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
    overflow:hidden;
    transition: transform .18s ease, filter .18s ease;
  }
  .accItem:hover{ transform: translateY(-1px); filter: brightness(1.03); }

  .accBtn{
    width:100%;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:14px 14px;
    border:0;
    background: transparent;
    cursor:pointer;
    color: var(--text);
    position:relative;
    overflow:hidden;
  }
  .accBtn::after{
    content:"";
    position:absolute; inset:-60px;
    background: radial-gradient(360px 220px at 20% 30%, rgba(255,255,255,.10), transparent 60%);
    opacity:0;
    transition: opacity .22s ease;
  }
  .accItem:hover .accBtn::after{ opacity:.65; }

  .accLeft{ display:flex; align-items:center; gap:10px; font-weight:900; }
  .accIco{
    width:34px; height:34px;
    display:grid; place-items:center;
    border-radius: 12px;
    background: rgba(0,0,0,.18);
    border: 1px solid rgba(255,255,255,.14);
    box-shadow: 0 10px 26px rgba(0,0,0,.22);
    animation: icoFloat 4.2s ease-in-out infinite;
  }
  @keyframes icoFloat{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-2px); } }

  .accTitle{ font-size:15px; margin:0; }
  .chev{
    width:40px; height:40px;
    display:grid; place-items:center;
    border-radius: 14px;
    background: rgba(0,0,0,.14);
    border:1px solid rgba(255,255,255,.14);
    transition: transform .25s ease, filter .25s ease;
  }
  .accItem.open .chev{ transform: rotate(180deg); filter: brightness(1.15); }

  .accBody{ display:none; padding: 0 14px 14px; }
  .accItem.open .accBody{ display:block; animation: rise .32s ease both; }
  @keyframes rise{ from{ opacity:0; transform: translateY(10px);} to{ opacity:1; transform: translateY(0);} }

  /* CARDS */
  .cards{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
  @media (max-width: 900px){ .cards{ grid-template-columns: 1fr; } }

  .card{
    background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12);
    border-radius: 16px; padding:12px; position:relative; overflow:hidden;
    transition: transform .18s ease, filter .18s ease;
  }
  .card:hover{ transform: translateY(-2px); filter: brightness(1.06); }
  .card::before{
    content:""; position:absolute; inset:-80px;
    background:
      radial-gradient(280px 200px at 20% 20%, rgba(124,255,138,.22), transparent 60%),
      radial-gradient(240px 180px at 80% 30%, rgba(255,210,77,.18), transparent 60%);
    filter: blur(12px); opacity:.9; pointer-events:none;
    animation: cardGlow 6s ease-in-out infinite;
  }
  @keyframes cardGlow{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-10px); } }

  .card > *{ position:relative; z-index:1; }
  .kicker{ font-size:12px; color: var(--muted); margin-bottom:6px; }
  .big{ font-size:15px; font-weight:900; margin:0; }
  .small{ margin:6px 0 0; color: var(--muted); font-size:13px; }

  .redNote{
    margin:8px 0 0;
    font-weight:900;
    color: rgba(255,63,63,.95);
    letter-spacing: .02em;
    text-shadow: 0 10px 26px rgba(0,0,0,.35);
    animation: redPulse 1.4s ease-in-out infinite;
  }
  @keyframes redPulse{ 0%,100%{ opacity:.78; } 50%{ opacity:1; } }

  .miniBtn{
    margin-top:10px;
    width:100%;
    border-radius: 14px;
    padding:10px 12px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.18);
    color: var(--text);
    cursor:pointer;
    font-weight:900;
    transition: transform .18s ease, filter .18s ease;
  }
  .miniBtn:hover{ transform: translateY(-1px); filter: brightness(1.08); }

  /* DIARIO */
  .journalBox{
    width:100%;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.18);
    color: var(--text);
    border-radius: 16px;
    padding: 12px;
    min-height: 110px;
    outline:none;
    font-family: inherit;
    resize: vertical;
    transition: box-shadow .18s ease, filter .18s ease;
  }
  .journalBox:focus{ box-shadow: 0 0 0 3px rgba(124,255,138,.22); filter: brightness(1.05); }

  /* NODO */
  .knotBox{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
  .knotArt{
    flex: 0 0 220px;
    background: rgba(0,0,0,.22);
    border:1px solid rgba(255,255,255,.14);
    border-radius: 16px;
    padding: 12px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    white-space: pre;
    line-height: 1.15;
    animation: knotFloat 4.8s ease-in-out infinite;
  }
  @keyframes knotFloat{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-3px); } }
  .knotText{ flex: 1 1 260px; }
  .knotName{ font-weight:900; font-size:16px; margin:0; }
  .knotDesc{ margin:8px 0 0; color: var(--muted); }

  /* BUSSOLA */
  .compassWrap{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .compass{
    width:140px; height:140px;
    border-radius:50%;
    border:2px solid rgba(255,255,255,.35);
    background: rgba(0,0,0,.18);
    position:relative;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    animation: compassBreath 3.6s ease-in-out infinite;
  }
  @keyframes compassBreath{ 0%,100%{ transform: scale(1); } 50%{ transform: scale(1.02); } }
  .compass::before{
    content:""; position:absolute; inset:10px;
    border-radius:50%;
    border:1px dashed rgba(255,210,77,.28);
    opacity:.85;
    animation: spinSlow 18s linear infinite;
  }
  @keyframes spinSlow{ to{ transform: rotate(360deg); } }

  .needle{
    position:absolute;
    left:50%; top:22px;
    width:4px; height:54px;
    transform-origin: 50% 100%;
    background: rgba(255,63,63,.95);
    border-radius: 6px;
    box-shadow: 0 0 18px rgba(255,63,63,.35);
    transform: translateX(-50%) rotate(0deg);
    transition: transform .5s ease;
  }
  .needle::after{
    content:""; position:absolute; left:-6px; top:-6px;
    width:16px; height:16px; border-radius:50%;
    background: rgba(255,255,255,.75);
    box-shadow: 0 0 18px rgba(255,255,255,.25);
  }
  .virtueCard{ flex: 1 1 260px; }
  .virtueName{ margin:0; font-weight:900; font-size:16px; }
  .virtueDesc{ margin:8px 0 0; color: var(--muted); }

  /* TIMELINE */
  .timeline{
    display:flex; gap:12px;
    overflow-x:auto;
    scroll-snap-type: x mandatory;
    padding-bottom: 6px;
  }
  .timeItem{
    min-width: 220px;
    scroll-snap-align: start;
    background: rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.14);
    border-radius: 16px;
    padding: 12px;
    transition: transform .18s ease, filter .18s ease;
  }
  .timeItem:hover{ transform: translateY(-2px); filter: brightness(1.08); }
  .timeYear{ font-weight:900; font-size:16px; margin:0; }
  .timeText{ margin:8px 0 0; color: var(--muted); font-size:13px; }

  /* FOTO FINALE */
  .panel{
    margin-top:14px; background:var(--panel); border:1px solid var(--panel2);
    border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter: blur(10px);
    padding:14px;
  }
  .panel h3{ margin:0 0 10px; font-size:16px; }

  .belowImg{
    width:100%;
    border-radius: 18px;
    border:1px solid rgba(255,255,255,.14);
    box-shadow: var(--shadow);
    display:block;
    animation: photoFloat 7.5s ease-in-out infinite;
  }
  @keyframes photoFloat{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-3px); } }

  .footerWindow{
    margin-top:14px;
    background: rgba(0,0,0,.25);
    border: 1px solid rgba(255,255,255,.16);
    border-radius: 18px;
    padding: 14px;
    text-align:center;
    box-shadow: var(--shadow);
    animation: footerGlow 5.2s ease-in-out infinite;
  }
  @keyframes footerGlow{ 0%,100%{ filter: brightness(1); } 50%{ filter: brightness(1.07); } }
</style>
</head>

<body>
  <div class="bg"></div>
  <div class="bgOverlay"></div>
  <div class="wind" id="windLayer"></div>
  <div class="leaves" id="leaves"></div>
  <div class="fireflies" id="fireflies"></div>
  <div class="sparks" id="sparks"></div>

  <!-- INTRO -->
  <div class="intro" id="intro">
    <div class="introRing"></div>
    <button class="enterBtn" id="enterBtn">ENTRA</button>
    <div class="enterHint">‚öúÔ∏è Entra nel bosco e apri il calendario</div>
  </div>

  <div class="wrap" id="app" style="opacity:0; transform: translateY(8px); transition: opacity .5s ease, transform .5s ease;">
    <div class="topbar">
      <div class="title">
        <div style="font-size:22px;">üå≤</div>
        <div>
          <div style="font-size:16px;font-weight:900;">Calendario Scout nel Bosco</div>
        </div>
      </div>

      <div class="controls">
        <button id="prev">‚¨ÖÔ∏è</button>
        <div class="monthTitle" id="monthTitle">‚Äî</div>
        <button id="next">‚û°Ô∏è</button>

        <select id="yearSel">
          <option>2026</option>
          <option>2027</option>
          <option>2028</option>
          <option>2029</option>
        </select>

        <button id="todayBtn">Oggi</button>
      </div>
    </div>

    <div class="stage" id="stage">
      <div class="frame"></div>
      <div class="content">
        <div class="grid" id="dow"></div>
        <div style="height:10px"></div>
        <div class="grid" id="cal"></div>

        <!-- lista eventi del mese -->
        <div class="monthEvents" id="monthEvents"></div>
      </div>
    </div>

    <!-- SEZIONI -->
    <div class="accordion">

      <div class="accItem" id="accThoughts">
        <button class="accBtn" type="button" aria-expanded="false">
          <div class="accLeft">
            <div class="accIco">üí≠</div>
            <div class="accTitle">Pensieri</div>
          </div>
          <div class="chev">‚ñæ</div>
        </button>
        <div class="accBody">
          <h3 style="margin:10px 0 8px;">üí≠ Cosa ti passa per la mente?</h3>
          <p class="muted" style="margin:0 0 10px;">Scrivi qui. Rimane salvato anche se ricarichi il sito.</p>
          <textarea id="journal" class="journalBox" placeholder="Scrivi qui quello che ti passa per la mente..."></textarea>
          <div class="muted" id="journalStatus" style="margin-top:8px;"></div>
        </div>
      </div>

      <div class="accItem" id="accTheme">
        <button class="accBtn" type="button" aria-expanded="false">
          <div class="accLeft">
            <div class="accIco">üåç</div>
            <div class="accTitle">Giornate a tema</div>
          </div>
          <div class="chev">‚ñæ</div>
        </button>
        <div class="accBody">
          <h3 style="margin:10px 0 8px;">üåç Giornate a tema</h3>
          <div class="cards" id="themeCards"></div>
        </div>
      </div>

      <div class="accItem" id="accCountdown">
        <button class="accBtn" type="button" aria-expanded="false">
          <div class="accLeft">
            <div class="accIco">‚è≥</div>
            <div class="accTitle">Countdown (solo ultimi 10 giorni)</div>
          </div>
          <div class="chev">‚ñæ</div>
        </button>
        <div class="accBody">
          <h3 style="margin:10px 0 8px;">‚è≥ Countdown</h3>
          <div class="cards" id="countCards"></div>
        </div>
      </div>

      <div class="accItem" id="accKnot">
        <button class="accBtn" type="button" aria-expanded="false">
          <div class="accLeft">
            <div class="accIco">üßµ</div>
            <div class="accTitle">Nodo del giorno</div>
          </div>
          <div class="chev">‚ñæ</div>
        </button>
        <div class="accBody">
          <h3 style="margin:10px 0 8px;">üßµ Nodo del giorno</h3>
          <div class="knotBox">
            <div class="knotArt" id="knotArt"></div>
            <div class="knotText">
              <p class="knotName" id="knotName">‚Äî</p>
              <p class="knotDesc" id="knotDesc">‚Äî</p>
            </div>
          </div>
        </div>
      </div>

      <div class="accItem" id="accCompass">
        <button class="accBtn" type="button" aria-expanded="false">
          <div class="accLeft">
            <div class="accIco">üß≠</div>
            <div class="accTitle">Bussola morale</div>
          </div>
          <div class="chev">‚ñæ</div>
        </button>
        <div class="accBody">
          <h3 style="margin:10px 0 8px;">üß≠ Bussola morale</h3>
          <div class="compassWrap">
            <div class="compass" aria-label="Bussola morale">
              <div class="needle" id="needle"></div>
            </div>
            <div class="virtueCard">
              <p class="virtueName" id="virtueName">‚Äî</p>
              <p class="virtueDesc" id="virtueDesc">‚Äî</p>
            </div>
          </div>
        </div>
      </div>

      <div class="accItem" id="accTimeline">
        <button class="accBtn" type="button" aria-expanded="false">
          <div class="accLeft">
            <div class="accIco">üï∞Ô∏è</div>
            <div class="accTitle">Linea del tempo scout</div>
          </div>
          <div class="chev">‚ñæ</div>
        </button>
        <div class="accBody">
          <h3 style="margin:10px 0 8px;">üï∞Ô∏è Linea del tempo scout</h3>
          <div class="timeline" id="timeline">
            <div class="timeItem">
              <p class="timeYear">1907</p>
              <p class="timeText">Primo campo scout sull‚Äôisola di Brownsea.</p>
            </div>
            <div class="timeItem">
              <p class="timeYear">1920</p>
              <p class="timeText">Primo Jamboree mondiale.</p>
            </div>
            <div class="timeItem">
              <p class="timeYear">1950+</p>
              <p class="timeText">Lo scoutismo cresce in tutto il mondo e diventa una grande famiglia.</p>
            </div>
            <div class="timeItem">
              <p class="timeYear">Oggi</p>
              <p class="timeText">Tu nel bosco üå≤: ‚Äúlascia il posto migliore di come lo hai trovato‚Äù.</p>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- FOTO FISSA ALLA FINE -->
    <div class="panel">
      <h3>üì∑ Foto</h3>
      <img class="belowImg" src="Immagine 2026-01-21 205031.png" alt="Immagine sotto al calendario">
    </div>

    <div class="footerWindow">
      <b>Site created by Mattia Spensieri</b>
    </div>
  </div>

<script>
  // =========================
  // UTIL
  // =========================
  const pad = n => String(n).padStart(2,"0");
  const ymd = (y,m,d) => `${y}-${pad(m)}-${pad(d)}`;
  const itMonth = (y,m) => new Date(y, m-1, 1).toLocaleString("it-IT",{month:"long", year:"numeric"});
  const DOW = ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];
  const YEAR_MIN = 2026, YEAR_MAX = 2029;
  const inRange = y => (y>=YEAR_MIN && y<=YEAR_MAX);

  // =========================
  // DOM
  // =========================
  const intro = document.getElementById("intro");
  const enterBtn = document.getElementById("enterBtn");
  const app = document.getElementById("app");

  const dowEl = document.getElementById("dow");
  const calEl = document.getElementById("cal");
  const monthTitleEl = document.getElementById("monthTitle");
  const yearSel = document.getElementById("yearSel");

  const journal = document.getElementById("journal");
  const journalStatus = document.getElementById("journalStatus");

  const themeCards = document.getElementById("themeCards");
  const countCards = document.getElementById("countCards");

  const knotArt = document.getElementById("knotArt");
  const knotName = document.getElementById("knotName");
  const knotDesc = document.getElementById("knotDesc");

  const needle = document.getElementById("needle");
  const virtueName = document.getElementById("virtueName");
  const virtueDesc = document.getElementById("virtueDesc");

  const monthEventsBox = document.getElementById("monthEvents");

  // =========================
  // STATO
  // =========================
  let stateYear = 2026;
  let stateMonth = 1;

  // =========================
  // EVENTI (SORGENTE UNICA)
  // - Route + Campo estivo (fissi)
  // - Compleanno Simone (annuale, lampeggia)
  // - Festivit√† nazionali (annuali, + Pasqua/Pasquetta calcolate per ogni anno)
  // - Celebrazioni/Santi con data fissa (annuali)
  // =========================
  const SCOUT_EVENTS = [
    { kind:"fixed",  date:"2026-07-15", icon:"üî•", name:"Campo estivo", tag:"scout" },
    { kind:"fixed",  date:"2026-08-24", icon:"üß≠", name:"Route", tag:"scout" },
    { kind:"annual", md:"01-23", icon:"üéÇ", name:"Compleanno di Simone", tag:"family", special:"simone" }
  ];

  // Festivit√† nazionali (date fisse -> annuali)
  const HOLIDAYS_FIXED = [
    { md:"01-01", icon:"üéâ", name:"Capodanno", tag:"holiday" },
    { md:"01-06", icon:"üßπ", name:"Epifania", tag:"holiday" },
    { md:"04-25", icon:"üáÆüáπ", name:"Festa della Liberazione", tag:"holiday" },
    { md:"05-01", icon:"üõ†Ô∏è", name:"Festa dei Lavoratori", tag:"holiday" },
    { md:"06-02", icon:"üèõÔ∏è", name:"Festa della Repubblica", tag:"holiday" },
    { md:"08-15", icon:"‚òÄÔ∏è", name:"Ferragosto", tag:"holiday" },
    { md:"11-01", icon:"üïØÔ∏è", name:"Tutti i Santi", tag:"holiday" },
    { md:"12-08", icon:"‚ú®", name:"Immacolata Concezione", tag:"holiday" },
    { md:"12-25", icon:"üéÑ", name:"Natale", tag:"holiday" },
    { md:"12-26", icon:"üéÅ", name:"Santo Stefano", tag:"holiday" }
  ];

  // Celebrazioni / santi (date fisse -> annuali)
  const CELEBRATIONS_FIXED = [
    { md:"01-07", icon:"üáÆüáπ", name:"Festa del Tricolore", tag:"celebration" },
    { md:"02-14", icon:"‚ù§Ô∏è", name:"San Valentino", tag:"celebration" },
    { md:"02-17", icon:"üé≠", name:"Carnevale", tag:"celebration" },
    { md:"03-19", icon:"üë®‚Äçüëß", name:"Festa del Pap√† (San Giuseppe)", tag:"celebration" },
    { md:"06-17", icon:"‚õ™", name:"San Ranieri (Pisa)", tag:"celebration" },
    { md:"06-24", icon:"‚õ™", name:"San Giovanni Battista", tag:"celebration" },
    { md:"06-29", icon:"‚õ™", name:"Santi Pietro e Paolo (Roma)", tag:"celebration" },
    { md:"07-15", icon:"‚õ™", name:"Santa Rosalia (Palermo)", tag:"celebration" },
    { md:"09-19", icon:"‚õ™", name:"San Gennaro (Napoli)", tag:"celebration" },
    { md:"10-04", icon:"‚õ™", name:"San Francesco / San Petronio", tag:"celebration" },
    { md:"11-02", icon:"‚õ™", name:"San Giusto (Trieste)", tag:"celebration" },
    { md:"12-06", icon:"‚õ™", name:"San Nicola (Bari)", tag:"celebration" },
    { md:"12-07", icon:"‚õ™", name:"Sant‚ÄôAmbrogio (Milano)", tag:"celebration" }
  ];

  // Pasqua (calcolata) + Pasquetta
  function easterDate(year){
    // Algoritmo Meeus/Jones/Butcher (gregoriano)
    const a = year % 19;
    const b = Math.floor(year / 100);
    const c = year % 100;
    const d = Math.floor(b / 4);
    const e = b % 4;
    const f = Math.floor((b + 8) / 25);
    const g = Math.floor((b - f + 1) / 3);
    const h = (19*a + b - d - g + 15) % 30;
    const i = Math.floor(c / 4);
    const k = c % 4;
    const l = (32 + 2*e + 2*i - h - k) % 7;
    const m = Math.floor((a + 11*h + 22*l) / 451);
    const month = Math.floor((h + l - 7*m + 114) / 31); // 3=Marzo, 4=Aprile
    const day = ((h + l - 7*m + 114) % 31) + 1;
    return new Date(year, month-1, day);
  }

  function buildEvents(){
    const out = [];

    // scout
    for(const e of SCOUT_EVENTS){
      if(e.kind === "fixed"){
        out.push({ date: e.date, icon:e.icon, name:e.name, tag:e.tag, special:e.special||"", kind:e.kind });
      }else{
        for(let y=YEAR_MIN; y<=YEAR_MAX; y++){
          out.push({ date: `${y}-${e.md}`, icon:e.icon, name:e.name, tag:e.tag, special:e.special||"", kind:e.kind });
        }
      }
    }

    // festivit√† fisse
    for(const h of HOLIDAYS_FIXED){
      for(let y=YEAR_MIN; y<=YEAR_MAX; y++){
        out.push({ date: `${y}-${h.md}`, icon:h.icon, name:h.name, tag:h.tag, special:"", kind:"annual" });
      }
    }

    // pasqua/pasquetta per ogni anno
    for(let y=YEAR_MIN; y<=YEAR_MAX; y++){
      const pasqua = easterDate(y);
      const pasquetta = new Date(pasqua.getFullYear(), pasqua.getMonth(), pasqua.getDate() + 1);

      out.push({
        date: ymd(pasqua.getFullYear(), pasqua.getMonth()+1, pasqua.getDate()),
        icon:"‚úùÔ∏è",
        name:"Pasqua",
        tag:"holiday",
        special:"",
        kind:"annual"
      });

      out.push({
        date: ymd(pasquetta.getFullYear(), pasquetta.getMonth()+1, pasquetta.getDate()),
        icon:"üê£",
        name:"Pasquetta",
        tag:"holiday",
        special:"",
        kind:"annual"
      });
    }

    // celebrazioni fisse
    for(const c of CELEBRATIONS_FIXED){
      for(let y=YEAR_MIN; y<=YEAR_MAX; y++){
        out.push({ date: `${y}-${c.md}`, icon:c.icon, name:c.name, tag:c.tag, special:"", kind:"annual" });
      }
    }

    // ordina
    out.sort((a,b)=> a.date.localeCompare(b.date));
    return out;
  }

  const EVENTS = buildEvents();

  function eventsForDate(key){ return EVENTS.filter(e => e.date === key); }
  function isEventDay(key){ return eventsForDate(key).length > 0; }
  function isSimoneDay(key){ return eventsForDate(key).some(e => e.special === "simone"); }

  function markerForDate(key){
    const list = eventsForDate(key);
    if(!list.length) return [];
    // massimo 2 icone per non fare casino
    const icons = [];
    for(const e of list){
      if(!icons.includes(e.icon)) icons.push(e.icon);
      if(icons.length >= 2) break;
    }
    return icons;
  }

  // =========================
  // GIORNATE A TEMA (restano)
  // =========================
  const THEME_DAYS = [
    { date:"01-21", icon:"ü§ó", name:"Giornata Mondiale degli Abbracci" },
    { date:"03-21", icon:"üå≥", name:"Giornata Internazionale delle Foreste" },
    { date:"03-22", icon:"üíß", name:"Giornata Mondiale dell‚ÄôAcqua" },
    { date:"04-22", icon:"üåç", name:"Giornata della Terra" },
    { date:"05-20", icon:"üêù", name:"Giornata Mondiale delle Api" },
    { date:"06-05", icon:"üå±", name:"Giornata Mondiale dell‚ÄôAmbiente" },
    { date:"09-21", icon:"üïäÔ∏è", name:"Giornata Internazionale della Pace" },
    { date:"10-04", icon:"üêæ", name:"Giornata Mondiale degli Animali" }
  ];
  const SCOUT_THEME = [
    { date:"02-22", icon:"‚öúÔ∏è", name:"Giornata del Pensiero (Scout)" },
    { date:"04-23", icon:"üõ°Ô∏è", name:"San Giorgio (tradizione scout)" }
  ];

  // =========================
  // NODI / VIRT√ô
  // =========================
  const KNOTS = [
    { name:"Nodo piano", art:`\\ \\     / /\n \\ \\   / /\n  \\ \\_/ /\n   / _ \\\n  / / \\ \\\n /_/   \\_\\`, desc:"Serve per unire due corde dello stesso spessore. √à semplice, ma deve essere fatto bene." },
    { name:"Gassa d‚Äôamante", art:`   ____ \n  / __ \\__\n / /  \\___)\n \\ \\__\n  \\___\\\n (____)`, desc:"Fa un cappio fisso che non scorre. Utilissima quando ti serve un anello sicuro." },
    { name:"Nodo parlato", art:`|\\      /|\n| \\____/ |\n|  ____  |\n| /    \\ |\n|/      \\|`, desc:"Ottimo per fissare una corda a un palo. √à stabile e molto usato in campo." }
  ];

  const VIRTUES = [
    { name:"Coraggio", desc:"Fare la cosa giusta anche quando hai paura." },
    { name:"Aiuto", desc:"Dare una mano senza aspettarsi niente in cambio." },
    { name:"Onest√†", desc:"Dire la verit√† e rispettare la parola data." },
    { name:"Lealt√†", desc:"Essere affidabile con gli altri e con te stesso." },
    { name:"Servizio", desc:"Mettere il bene comune davanti alla comodit√† personale." }
  ];

  // =========================
  // CALENDARIO - CALCOLI
  // =========================
  function firstDayOffset(y,m){
    const js = new Date(y, m-1, 1).getDay(); // 0 dom..6 sab
    return (js + 6) % 7; // lun=0..dom=6
  }
  function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); }

  // =========================
  // TEMA giorno/notte + stagione
  // =========================
  function setTheme(){
    const m = stateMonth;
    const hour = new Date().getHours();
    const night = (hour >= 20 || hour < 7);

    let overlayA = "rgba(8,25,14,.58)", overlayB = "rgba(8,25,14,.26)";
    if([12,1,2].includes(m)) { overlayA="rgba(8,16,32,.64)"; overlayB="rgba(8,16,32,.30)"; }
    if([6,7,8].includes(m)) { overlayA="rgba(40,22,6,.58)"; overlayB="rgba(15,35,18,.22)"; }
    if([9,10,11].includes(m)) { overlayA="rgba(22,12,6,.62)"; overlayB="rgba(15,30,16,.24)"; }

    document.documentElement.style.setProperty("--overlayA", night ? "rgba(0,0,0,.72)" : overlayA);
    document.documentElement.style.setProperty("--overlayB", night ? "rgba(0,0,0,.32)" : overlayB);
    document.documentElement.style.setProperty("--fliesOpacity", night ? ".95" : ".55");
  }

  // =========================
  // RENDER DOW
  // =========================
  function renderDOW(){
    dowEl.innerHTML = "";
    DOW.forEach(d=>{
      const div = document.createElement("div");
      div.className="dow";
      div.textContent = d;
      dowEl.appendChild(div);
    });
  }

  // =========================
  // RENDER CALENDARIO
  // =========================
  function renderCalendar(){
    if(!inRange(stateYear)){ stateYear=YEAR_MIN; stateMonth=1; }
    setTheme();

    monthTitleEl.textContent = itMonth(stateYear, stateMonth);
    yearSel.value = String(stateYear);
    calEl.innerHTML = "";

    const today = new Date();
    const todayKey = ymd(today.getFullYear(), today.getMonth()+1, today.getDate());

    const offset = firstDayOffset(stateYear, stateMonth);
    const dim = daysInMonth(stateYear, stateMonth);

    const prevMonth = stateMonth === 1 ? 12 : stateMonth - 1;
    const prevYear  = stateMonth === 1 ? stateYear - 1 : stateYear;
    const nextMonth = stateMonth === 12 ? 1 : stateMonth + 1;
    const nextYear  = stateMonth === 12 ? stateYear + 1 : stateYear;

    const dimPrev = daysInMonth(prevYear, prevMonth);
    let cells = 0;

    for(let i=0;i<offset;i++){
      const dayNum = dimPrev - offset + 1 + i;
      const key = ymd(prevYear, prevMonth, dayNum);
      calEl.appendChild(makeDayCell(prevYear, prevMonth, dayNum, key, true, todayKey));
      cells++;
    }

    for(let d=1; d<=dim; d++){
      const key = ymd(stateYear, stateMonth, d);
      calEl.appendChild(makeDayCell(stateYear, stateMonth, d, key, false, todayKey));
      cells++;
    }

    let nextDay = 1;
    while(cells < 42){
      const key = ymd(nextYear, nextMonth, nextDay);
      calEl.appendChild(makeDayCell(nextYear, nextMonth, nextDay, key, true, todayKey));
      cells++;
      nextDay++;
    }

    renderMonthEventsList();
  }

  function makeDayCell(y,m,d,key,isOff,todayKey){
    const div = document.createElement("div");

    const cls = [
      "day",
      isOff ? "off" : "",
      key===todayKey ? "today" : "",
      isEventDay(key) ? "eventDay" : "",
      isSimoneDay(key) ? "simoneBlink" : ""
    ].filter(Boolean).join(" ");

    div.className = cls;

    const evs = eventsForDate(key);
    div.title = evs.length ? evs.map(e=>`${e.icon} ${e.name}`).join(" ‚Ä¢ ") : "";

    const icons = markerForDate(key);
    const markerHtml = icons.length
      ? `<div class="marker">${icons.map(i=>`<span>${i}</span>`).join("")}</div>`
      : "";

    div.innerHTML = `<div class="n">${d}</div>${markerHtml}`;
    div.dataset.key = key;
    return div;
  }

  // =========================
  // EVENTI DEL MESE (visibili sotto)
  // =========================
  function renderMonthEventsList(){
    monthEventsBox.innerHTML = "";
    const monthKey = `${stateYear}-${pad(stateMonth)}`;
    const list = EVENTS
      .filter(e => e.date.startsWith(monthKey))
      .sort((a,b)=> a.date.localeCompare(b.date));

    if(!list.length){
      monthEventsBox.innerHTML = `<div class="monthEventsLine">
        <div class="monthEventsIco">üåô</div>
        <div class="monthEventsTxt">Nessun evento in questo mese</div>
      </div>`;
      return;
    }

    list.forEach(e=>{
      const [y,m,d] = e.date.split("-").map(n=>parseInt(n,10));
      const dt = new Date(y, m-1, d);
      const label = dt.toLocaleDateString("it-IT",{weekday:"long", day:"2-digit", month:"long", year:"numeric"});
      const row = document.createElement("div");
      row.className = "monthEventsLine";
      row.innerHTML = `
        <div class="monthEventsIco">${e.icon}</div>
        <div class="monthEventsTxt">
          <b>${e.name}</b>
          <div class="monthEventsSub">${label}</div>
        </div>
      `;
      row.addEventListener("click", ()=> jumpToEvent(e.date));
      monthEventsBox.appendChild(row);
    });
  }

  // =========================
  // ACCORDION
  // =========================
  function setupAccordion(){
    document.querySelectorAll(".accItem").forEach(item=>{
      const btn = item.querySelector(".accBtn");
      btn.addEventListener("click", ()=>{
        const isOpen = item.classList.contains("open");
        item.classList.toggle("open", !isOpen);
        btn.setAttribute("aria-expanded", String(!isOpen));
        if(!isOpen) setTimeout(()=> item.scrollIntoView({behavior:"smooth", block:"start"}), 80);
      });
    });
  }

  // =========================
  // DIARIO
  // =========================
  const JOURNAL_KEY = "scout_thoughts_v4";
  function loadJournal(){
    const saved = localStorage.getItem(JOURNAL_KEY);
    if(saved !== null) journal.value = saved;
    journalStatus.textContent = saved ? "‚úÖ Testo caricato" : "‚úçÔ∏è Inizia a scrivere‚Ä¶";
  }
  let saveTimer = null;
  function scheduleSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      localStorage.setItem(JOURNAL_KEY, journal.value);
      const t = new Date();
      journalStatus.textContent = "üíæ Salvato: " + t.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});
    }, 220);
  }
  journal.addEventListener("input", scheduleSave);

  // =========================
  // GIORNATE A TEMA: prossime 6
  // =========================
  function nextThemeDays(){
    const now = new Date();
    const year = now.getFullYear();
    const list = [...THEME_DAYS, ...SCOUT_THEME].map(x=>{
      const [mm,dd] = x.date.split("-").map(n=>parseInt(n,10));
      let d = new Date(year, mm-1, dd);
      const today0 = new Date(year, now.getMonth(), now.getDate());
      if(d < today0) d = new Date(year+1, mm-1, dd);
      return { ...x, nextDate: d };
    }).sort((a,b)=> a.nextDate - b.nextDate);

    return list.slice(0,6);
  }
  function renderThemeDays(){
    const now = new Date();
    const todayYMD = ymd(now.getFullYear(), now.getMonth()+1, now.getDate());

    themeCards.innerHTML = "";
    nextThemeDays().forEach(x=>{
      const d = x.nextDate;
      const key = ymd(d.getFullYear(), d.getMonth()+1, d.getDate());
      const isToday = (key === todayYMD);

      const label = d.toLocaleDateString("it-IT", {weekday:"long", day:"2-digit", month:"long", year:"numeric"});
      const card = document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <div class="kicker">${isToday ? "‚úÖ Oggi" : "üìÖ Prossima data"}</div>
        <p class="big">${x.icon} ${x.name}</p>
        <p class="small">${label}</p>
      `;
      themeCards.appendChild(card);
    });
  }

  // =========================
  // COUNTDOWN
  // ‚úÖ entra SOLO negli ultimi 10 giorni (0..10)
  // ‚úÖ dedup: stesso nome -> prende la data pi√π vicina
  // ‚úÖ clic -> va al giorno sul calendario + lampeggia
  // =========================
  function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function parseEventDate(e){
    const [y,m,d] = e.date.split("-").map(n=>parseInt(n,10));
    return new Date(y, m-1, d, 0, 0, 0, 0);
  }
  function diffDaysFromToday(dateObj){
    const A = startOfDay(new Date());
    const B = startOfDay(dateObj);
    return Math.round((B - A) / (1000*60*60*24));
  }

  function renderCountdown(){
    countCards.innerHTML = "";

    const now0 = startOfDay(new Date());

    // lista eventi 0..10 giorni
    const list = EVENTS
      .map(e=>{
        const dateObj = parseEventDate(e);
        const diff = diffDaysFromToday(dateObj);
        return { ...e, dateObj, diff };
      })
      .filter(e => e.dateObj >= now0 && e.diff <= 10)   // ‚úÖ SOLO ultimi 10 giorni
      .sort((a,b)=> a.dateObj - b.dateObj);

    if(!list.length){
      const card = document.createElement("div");
      card.className="card";
      card.innerHTML = `<div class="kicker">‚è≥ Countdown</div>
        <p class="big">Nessun evento nei prossimi 10 giorni</p>
        <p class="small">Quando un evento √® vicino, lo vedrai qui.</p>`;
      countCards.appendChild(card);
      return;
    }

    // dedup per nome (es: Compleanno di Simone compare una sola volta)
    const picked = [];
    const seen = new Set();
    for(const e of list){
      if(seen.has(e.name)) continue;
      seen.add(e.name);
      picked.push(e);
      if(picked.length >= 9) break;
    }

    picked.forEach(e=>{
      const when = e.dateObj.toLocaleDateString("it-IT", {day:"2-digit", month:"long", year:"numeric"});

      let msg = `Mancano ${e.diff} giorni a ${e.name}`;
      if(e.diff === 0) msg = `√à oggi: ${e.name}!`;
      if(e.diff === 1) msg = `Manca 1 giorno a ${e.name}`;

      const card = document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <div class="kicker">${e.icon} Countdown</div>
        <p class="big">${msg}</p>
        <p class="small">üìÖ ${when}</p>
        <p class="redNote">üî¥ Segnato sul calendario</p>
        <button class="miniBtn" type="button">Vai sul calendario</button>
      `;

      card.querySelector(".miniBtn").addEventListener("click", ()=> jumpToEvent(e.date));
      countCards.appendChild(card);
    });
  }

  function jumpToEvent(dateStr){
    const [y,m] = dateStr.split("-").map(n=>parseInt(n,10));

    stateYear = Math.min(Math.max(y, YEAR_MIN), YEAR_MAX);
    stateMonth = m;
    renderCalendar();

    document.getElementById("stage").scrollIntoView({behavior:"smooth", block:"start"});

    const cell = calEl.querySelector(`[data-key="${dateStr}"]`);
    if(cell){
      cell.classList.add("jumpFlash");
      setTimeout(()=> cell.classList.remove("jumpFlash"), 5200);
    }
  }

  // =========================
  // NODO / BUSSOLA
  // =========================
  function setKnotOfDay(){
    const now = new Date();
    const seed = (now.getFullYear()*10000) + ((now.getMonth()+1)*100) + now.getDate();
    const idx = seed % KNOTS.length;
    const k = KNOTS[idx];
    knotName.textContent = k.name;
    knotArt.textContent = k.art;
    knotDesc.textContent = k.desc;
  }

  function setVirtueOfDay(){
    const now = new Date();
    const seed = (now.getFullYear()*10000) + ((now.getMonth()+1)*100) + now.getDate();
    const idx = seed % VIRTUES.length;
    const v = VIRTUES[idx];

    virtueName.textContent = `Virt√π del giorno: ${v.name}`;
    virtueDesc.textContent = v.desc;

    const angle = idx * 72;
    needle.style.transform = `translateX(-50%) rotate(${angle}deg)`;
  }

  // =========================
  // NAV CALENDARIO
  // =========================
  document.getElementById("prev").addEventListener("click", ()=>{
    stateMonth--;
    if(stateMonth<1){ stateMonth=12; stateYear--; }
    if(!inRange(stateYear)){ stateYear=YEAR_MIN; stateMonth=1; }
    renderCalendar();
  });

  document.getElementById("next").addEventListener("click", ()=>{
    stateMonth++;
    if(stateMonth>12){ stateMonth=1; stateYear++; }
    if(!inRange(stateYear)){ stateYear=YEAR_MAX; stateMonth=12; }
    renderCalendar();
  });

  yearSel.addEventListener("change", ()=>{
    stateYear = parseInt(yearSel.value,10);
    renderCalendar();
  });

  document.getElementById("todayBtn").addEventListener("click", ()=>{
    const t = new Date();
    if(t.getFullYear()<YEAR_MIN || t.getFullYear()>YEAR_MAX){ stateYear=YEAR_MIN; stateMonth=1; }
    else { stateYear=t.getFullYear(); stateMonth=t.getMonth()+1; }
    renderCalendar();
  });

  // swipe mobile
  const stage = document.getElementById("stage");
  let touchStartX = null;
  stage.addEventListener("touchstart",(e)=>{ touchStartX = e.touches[0].clientX; }, {passive:true});
  stage.addEventListener("touchend",(e)=>{
    if(touchStartX===null) return;
    const endX = e.changedTouches[0].clientX;
    const dx = endX - touchStartX;
    touchStartX = null;
    if(Math.abs(dx) < 40) return;
    if(dx < 0) document.getElementById("next").click();
    else document.getElementById("prev").click();
  }, {passive:true});

  // =========================
  // EFFETTI: foglie + lucciole + scintille
  // =========================
  function spawnLeaves(){
    const box = document.getElementById("leaves");
    box.innerHTML = "";
    const n = 34;
    for(let i=0;i<n;i++){
      const l = document.createElement("div");
      l.className = "leafFall";
      l.style.left = (Math.random()*100) + "%";
      l.style.setProperty("--t", (7 + Math.random()*11) + "s");
      l.style.setProperty("--dx", ((Math.random()*260)-130) + "px");
      l.style.animationDelay = (Math.random()*6) + "s";
      const s = 0.65 + Math.random()*1.15;
      l.style.width = (28*s) + "px";
      l.style.height = (28*s) + "px";
      box.appendChild(l);
    }
  }

  function spawnFireflies(){
    const box = document.getElementById("fireflies");
    box.innerHTML = "";
    const n = 20;
    for(let i=0;i<n;i++){
      const f = document.createElement("div");
      f.className = "firefly";
      f.style.left = (Math.random()*100) + "%";
      f.style.top  = (Math.random()*100) + "%";
      f.style.setProperty("--t", (6 + Math.random()*9) + "s");
      f.style.setProperty("--dx", ((Math.random()*260)-130) + "px");
      f.style.setProperty("--dy", ((Math.random()*240)-170) + "px");
      f.style.animationDelay = (Math.random()*3) + "s";
      box.appendChild(f);
    }
  }

  function spawnSparks(){
    const box = document.getElementById("sparks");
    box.innerHTML = "";
    const n = 24;
    for(let i=0;i<n;i++){
      const s = document.createElement("div");
      s.className = "spark";
      s.style.left = (Math.random()*100) + "%";
      s.style.top  = (55 + Math.random()*50) + "%";
      s.style.setProperty("--t", (4 + Math.random()*6) + "s");
      s.style.setProperty("--dx", ((Math.random()*180)-90) + "px");
      s.style.setProperty("--dy", (Math.random()*90) + "px");
      s.style.animationDelay = (Math.random()*4) + "s";
      box.appendChild(s);
    }
  }

  window.addEventListener("resize", ()=>{ spawnLeaves(); spawnFireflies(); spawnSparks(); });

  // vento su scroll
  let lastY = window.scrollY;
  let lastT = performance.now();
  let wind = 0;
  let calmTimer = null;

  function setWindStrength(v){
    wind = Math.max(0, Math.min(1, v));
    document.documentElement.style.setProperty("--windStrength", String(wind));
  }

  window.addEventListener("scroll", ()=>{
    const y = window.scrollY;
    const t = performance.now();
    const dy = Math.abs(y - lastY);
    const dt = Math.max(16, (t - lastT));
    const speed = dy / dt;

    const boost = Math.max(0, Math.min(1, speed * 3.2));
    setWindStrength(Math.max(wind, boost));

    lastY = y; lastT = t;

    clearTimeout(calmTimer);
    calmTimer = setTimeout(()=> setWindStrength(wind * 0.45), 180);
    setTimeout(()=> setWindStrength(wind * 0.35), 380);
    setTimeout(()=> setWindStrength(wind * 0.25), 680);
    setTimeout(()=> setWindStrength(wind * 0.15), 980);
    setTimeout(()=> setWindStrength(0), 1400);
  }, {passive:true});

  // =========================
  // INTRO
  // =========================
  enterBtn.addEventListener("click", ()=>{
    intro.classList.add("hide");
    app.style.opacity = "1";
    app.style.transform = "translateY(0)";
  });

  // =========================
  // AVVIO
  // =========================
  (function init(){
    renderDOW();
    spawnLeaves();
    spawnFireflies();
    spawnSparks();
    setupAccordion();

    renderCalendar();
    renderThemeDays();
    renderCountdown();

    loadJournal();
    setKnotOfDay();
    setVirtueOfDay();

    setTheme();
    setInterval(()=>{
      setTheme();
      renderThemeDays();
      renderCountdown();
      setKnotOfDay();
      setVirtueOfDay();
    }, 60000);
  })();
</script>
</body>
</html>
